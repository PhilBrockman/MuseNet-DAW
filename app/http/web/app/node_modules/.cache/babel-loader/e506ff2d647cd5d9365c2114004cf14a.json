{"ast":null,"code":"//    abc2abc_write.js: Prints an abc file in text format parsed by abc_parse.js\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nvar TextPrinter = function (elem, reposition) {\n  this.elem = elem;\n  this.text = \"\";\n  this.l = 1 / 8;\n  this.reposition = reposition || false;\n};\n\nTextPrinter.prototype.printString = function (str, elem) {\n  if (this.reposition && elem) elem.startChar = this.text.length;\n  this.text += str;\n  if (this.reposition && elem) elem.endChar = this.text.length;\n};\n\nTextPrinter.prototype.printNewLine = function () {\n  this.text += \"\\n\";\n};\n\nTextPrinter.prototype.printSpace = function () {\n  if (this.text[this.text.length - 1].match(/\\s/)) return; //TODO match whitespace\n\n  this.text += \" \";\n};\n\nTextPrinter.prototype.printABC = function (abctune) {\n  this.text = \"\";\n  this.abctune = abctune; //TODO formatting\n\n  this.printHeader();\n  this.printBody();\n  this.elem.value = this.text;\n};\n\nTextPrinter.prototype.printHeader = function () {\n  // much of this info is duplicated in metaTextHEaders in abc_parse_header.js\n  this.printHeaderLine(\"x\", \"X\", \"1\");\n  this.printHeaderLine(\"title\", \"T\");\n  this.printHeaderLine(\"composer\", \"C\");\n  this.printHeaderLine(\"history\", \"H\");\n  this.printHeaderLine(\"author\", \"A\");\n  this.printHeaderLine(\"book\", \"B\");\n  this.printHeaderLine(\"discography\", \"D\");\n  this.printHeaderLine(\"url\", \"F\");\n  this.printHeaderLine(\"group\", \"G\");\n  this.printHeaderLine(\"instruction\", \"I\");\n  this.printHeaderLine(\"notes\", \"N\");\n  this.printHeaderLine(\"origin\", \"O\");\n  this.printHeaderLine(\"rhythm\", \"R\");\n  this.printHeaderLine(\"source\", \"S\");\n  this.printHeaderLine(\"unalignedwords\", \"W\");\n  this.printHeaderLine(\"transcription\", \"Z\"); //TODO part order\n  //TODO Q tempo\n  //TODO textBlock\n\n  this.printHeaderLine(\"NULL\", \"L\", \"1/8\"); //TODO L\n\n  this.printHeaderLine(\"NULL\", \"M\", this.getMeterString(this.abctune.lines[0].staff[0].meter));\n  this.printHeaderLine(\"NULL\", \"K\", this.getKeyString(this.abctune.lines[0].staff[0].key)); //TODO K\n};\n\nTextPrinter.prototype.getKeyString = function (key) {\n  return key.root + key.acc + key.mode;\n};\n\nTextPrinter.prototype.getMeterString = function (meter) {\n  switch (meter.type) {\n    case \"cut_time\":\n      return \"C|\";\n\n    case \"common_time\":\n      return \"C\";\n\n    case \"specified\":\n      if (meter.value[0].den) return meter.value[0].num + \"/\" + meter.value[0].den;else return meter.value[0].num;\n  }\n\n  return \"\";\n};\n\nTextPrinter.prototype.printHeaderLine = function (fieldname, abcfield, defaut) {\n  var val = this.abctune.metaText[fieldname] || defaut;\n\n  if (val !== undefined) {\n    var valarray = val.split(\"\\n\");\n\n    for (var i = 0; i < valarray.length; i++) {\n      this.printString(abcfield + \": \" + valarray[i]);\n      this.printNewLine();\n    }\n  }\n};\n\nTextPrinter.prototype.getElem = function () {\n  if (this.abcline.length <= this.pos) return null;\n  return this.abcline[this.pos];\n};\n\nTextPrinter.prototype.getNextElem = function () {\n  if (this.abcline.length <= this.pos + 1) return null;\n  return this.abcline[this.pos + 1];\n};\n\nTextPrinter.prototype.printBody = function () {\n  for (var line = 0; line < this.abctune.lines.length; line++) {\n    var abcline = this.abctune.lines[line];\n\n    if (abcline.staff) {\n      this.printABCLine(abcline.staff);\n    } else if (abcline.subtitle && line !== 0) {//TODO\n    } else if (abcline.text) {//TODO\n    }\n  }\n};\n\nTextPrinter.prototype.printABCLine = function (staffs) {\n  for (this.s = 0; this.s < staffs.length; this.s++) {\n    this.printABCStaff(staffs[this.s]);\n  }\n};\n\nTextPrinter.prototype.printABCStaff = function (abcstaff) {\n  // TODO if (abcstaff.bracket) header += \"bracket \"+abcstaff.bracket+\" \";\n  // TODO if (abcstaff.brace) header += \"brace \"+abcstaff.brace+\" \";\n  for (this.v = 0; this.v < abcstaff.voices.length; this.v++) {\n    // TODO stuff about voices\n    // TODO this is where key sig is this.voice.addChild(this.printClef(abcstaff.clef));\n    // this.voice.addChild(this.printKeySignature(abcstaff.key));\n    // if (abcstaff.meter) this.voice.addChild(this.printTimeSignature(abcstaff.meter));\n    this.printABCVoice(abcstaff.voices[this.v]);\n  }\n};\n\nTextPrinter.prototype.printABCVoice = function (abcline) {\n  this.abcline = abcline;\n\n  for (this.pos = 0; this.pos < this.abcline.length; this.pos++) {\n    this.printABCElement();\n  }\n\n  this.printNewLine();\n};\n\nTextPrinter.prototype.printABCElement = function () {\n  var elem = this.getElem();\n\n  switch (elem.el_type) {\n    case \"note\":\n      this.printBeam();\n      break;\n\n    case \"bar\":\n      this.printBarLine(elem);\n      break;\n\n    case \"meter\":\n      //TODO this.printTimeSignature(elem);\n      break;\n\n    case \"clef\":\n      //TODO this.printClef(elem);\n      break;\n\n    case \"key\": //TODO this.printKeySignature(elem);\n\n    case \"stem\":\n      //TODO do nothing?\n      break;\n\n    case \"part\":\n      //TODO print part\n      break;\n\n    default: //TODO show we're missing something\n\n  }\n};\n\nTextPrinter.prototype.printBeam = function () {\n  this.printSpace();\n\n  if (this.getElem().startBeam && !this.getElem().endBeam) {\n    while (this.getElem()) {\n      this.printNote(this.getElem());\n\n      if (this.getElem().endBeam) {\n        break;\n      }\n\n      this.pos++;\n    }\n  } else {\n    this.printNote(this.getElem());\n  }\n\n  this.printSpace();\n};\n\nTextPrinter.prototype.printNote = function (elem) {\n  var str = \"\";\n  var i;\n\n  if (elem.chord !== undefined) {\n    for (i = 0; i < elem.chord.length; i++) {\n      str += '\"' + elem.chord[i].name + '\"';\n    }\n  } //TODO unify map between names and symbols (to be used with abcparse?)\n\n\n  var decorations = {\n    \"staccato\": \".\",\n    \"upbow\": \"u\",\n    \"downbow\": \"v\",\n    \"roll\": \"~\",\n    \"fermata\": \"H\",\n    \"slide\": \"J\",\n    \"accent\": \"L\",\n    \"mordent\": \"M\",\n    \"pralltriller\": \"P\",\n    \"trill\": \"T\",\n    \"lower\": \".\"\n  };\n\n  if (elem.decoration !== undefined) {\n    for (i = 0; i < elem.decoration.length; i++) {\n      var dec = elem.decoration[i];\n\n      if (decorations[dec]) {\n        str += decorations[dec];\n      } else {\n        str += \"!\"; //TODO hardcoded\n\n        str += dec;\n        str += \"!\"; //TODO hardcoded\n      }\n    }\n  }\n\n  if (elem.gracenotes !== undefined) {\n    str += \"{\";\n\n    for (i = 0; i < elem.gracenotes.length; i++) {\n      str += this.getNoteString(elem.gracenotes[i]);\n    }\n\n    str += \"}\";\n  }\n\n  var ignoreslur = false;\n\n  if (elem.pitches.length === 1 && elem.pitches[0].startSlur) {\n    ignoreslur = true;\n    str += this.multiplyString(\"(\", elem.pitches[0].startSlur.length);\n  }\n\n  if (elem.startSlur) {\n    str += this.multiplyString(\"(\", elem.startSlur.length);\n  }\n\n  if (elem.pitches.length === 1 && elem.pitches[0].endSlur || elem.endSlur) {\n    ignoreslur = true;\n  }\n\n  if (elem.startTriplet) {\n    str += \"(3\";\n  }\n\n  if (elem.pitches) {\n    if (elem.pitches.length > 1) str += \"[\";\n\n    for (i = 0; i < elem.pitches.length; i++) {\n      elem.pitches[i].duration = elem.duration;\n      str += this.getNoteString(elem.pitches[i], ignoreslur);\n    }\n\n    if (elem.pitches.length > 1) str += \"]\";\n  }\n\n  if (elem.pitches.length === 1 && elem.pitches[0].endSlur) {\n    str += this.multiplyString(\")\", elem.pitches[0].endSlur.length);\n  }\n\n  if (elem.endSlur) {\n    str += this.multiplyString(\")\", elem.endSlur.length);\n  }\n\n  this.printString(str, elem);\n}; // accidentals, ties and sometimes slurs, sometimes duration\n\n\nTextPrinter.prototype.getNoteString = function (pitchelem, ignoreslur) {\n  var str = \"\";\n\n  if (!ignoreslur && pitchelem.startSlur) {\n    str += \"(\";\n  }\n\n  var symb = \"\";\n\n  switch (pitchelem.accidental) {\n    case \"quartersharp\":\n      symb = \"^/\";\n      break;\n\n    case \"dblsharp\":\n      symb = \"^^\";\n      break;\n\n    case \"sharp\":\n      symb = \"^\";\n      break;\n\n    case \"quarterflat\":\n      symb = \"_/\";\n      break;\n\n    case \"flat\":\n      symb = \"_\";\n      break;\n\n    case \"dblflat\":\n      symb = \"__\";\n      break;\n\n    case \"natural\":\n      symb = \"=\";\n  }\n\n  str += symb;\n  var pitches = [\"C\", \"D\", \"E\", \"F\", \"G\", \"A\", \"B\"];\n  var pitchstr = pitches[this.extractNote(pitchelem.pitch)];\n  var octave = this.extractOctave(pitchelem.pitch);\n\n  if (octave > 0) {\n    pitchstr = pitchstr.toLowerCase();\n    octave--;\n\n    while (octave > 0) {\n      pitchstr += \"'\";\n      octave--;\n    }\n  } else {\n    while (octave < 0) {\n      pitchstr += \",\";\n      octave++;\n    }\n  }\n\n  str += pitchstr;\n\n  if (pitchelem.duration) {\n    str += this.getDurationString(pitchelem.duration);\n  }\n\n  if (!ignoreslur && pitchelem.endSlur) {\n    str += \")\";\n  }\n\n  if (pitchelem.startTie) {\n    str += \"-\";\n  }\n\n  return str;\n};\n\nTextPrinter.prototype.getDurationString = function (duration) {\n  //TODO detect crooked rhythm\n  if (duration / this.l > 1) {\n    return duration / this.l;\n  }\n\n  var ret = \"\";\n\n  if (this.l / duration > 1) {\n    ret += \"/\";\n\n    if (this.l / duration > 2) {\n      ret += this.l / duration;\n    }\n  }\n\n  return ret;\n};\n\nTextPrinter.prototype.extractNote = function (pitch) {\n  var pitch2 = pitch % 7;\n  if (pitch2 < 0) pitch2 += 7;\n  return pitch2;\n};\n\nTextPrinter.prototype.extractOctave = function (pitch) {\n  return Math.floor(pitch / 7);\n};\n\nTextPrinter.prototype.printBarLine = function (elem) {\n  var barstr = \"\";\n\n  switch (elem.type) {\n    case \"bar_thin\":\n      barstr += \"|\";\n      break;\n\n    case \"bar_thin_thick\":\n      barstr += \"|]\";\n      break;\n\n    case \"bar_thin_thin\":\n      barstr += \"||\";\n      break;\n\n    case \"bar_thick_thin\":\n      barstr += \"[|\";\n      break;\n\n    case \"bar_dbl_repeat\":\n      barstr += \":||:\";\n      break;\n\n    case \"bar_left_repeat\":\n      barstr += \"|:\";\n      break;\n\n    case \"bar_right_repeat\":\n      barstr += \":|\";\n      break;\n\n    case \"bar_invisible\":\n      barstr += \"\";\n      break;\n  }\n\n  this.printString(barstr, elem);\n};\n\nTextPrinter.prototype.multiplyString = function (s, n) {\n  var ret = \"\";\n\n  for (; n > 0; n--) ret += s;\n\n  return ret;\n};\n\nmodule.exports = TextPrinter;","map":{"version":3,"sources":["/Users/philbrockman/coding/MusicalGens/app/http/web/app/node_modules/abcjs/src/transform/abc2abc_write.js"],"names":["TextPrinter","elem","reposition","text","l","prototype","printString","str","startChar","length","endChar","printNewLine","printSpace","match","printABC","abctune","printHeader","printBody","value","printHeaderLine","getMeterString","lines","staff","meter","getKeyString","key","root","acc","mode","type","den","num","fieldname","abcfield","defaut","val","metaText","undefined","valarray","split","i","getElem","abcline","pos","getNextElem","line","printABCLine","subtitle","staffs","s","printABCStaff","abcstaff","v","voices","printABCVoice","printABCElement","el_type","printBeam","printBarLine","startBeam","endBeam","printNote","chord","name","decorations","decoration","dec","gracenotes","getNoteString","ignoreslur","pitches","startSlur","multiplyString","endSlur","startTriplet","duration","pitchelem","symb","accidental","pitchstr","extractNote","pitch","octave","extractOctave","toLowerCase","getDurationString","startTie","ret","pitch2","Math","floor","barstr","n","module","exports"],"mappings":"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","sourcesContent":["//    abc2abc_write.js: Prints an abc file in text format parsed by abc_parse.js\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nvar TextPrinter = function(elem, reposition) {\n    this.elem = elem;\n    this.text = \"\";\n    this.l = 1/8;\n    this.reposition = reposition || false;\n}\n\nTextPrinter.prototype.printString = function(str, elem) {\n    if (this.reposition && elem) elem.startChar = this.text.length;\n    this.text += str;\n    if (this.reposition && elem) elem.endChar = this.text.length;\n};\n\nTextPrinter.prototype.printNewLine = function () {\n    this.text += \"\\n\";\n};\n\nTextPrinter.prototype.printSpace = function () {\n    if (this.text[this.text.length-1].match(/\\s/)) return; //TODO match whitespace\n    this.text += \" \";\n};\n\nTextPrinter.prototype.printABC = function(abctune) {\n    this.text = \"\";\n    this.abctune = abctune;\n    //TODO formatting\n    this.printHeader();\n    this.printBody();\n    this.elem.value=this.text;\n};\n\nTextPrinter.prototype.printHeader = function() {\n    // much of this info is duplicated in metaTextHEaders in abc_parse_header.js\n    this.printHeaderLine(\"x\",\"X\",\"1\");\n    this.printHeaderLine(\"title\",\"T\");\n    this.printHeaderLine(\"composer\",\"C\");\n    this.printHeaderLine(\"history\",\"H\");\n    this.printHeaderLine(\"author\",\"A\");\n    this.printHeaderLine(\"book\",\"B\");  \n    this.printHeaderLine(\"discography\",\"D\");  \n    this.printHeaderLine(\"url\",\"F\");\n    this.printHeaderLine(\"group\",\"G\");\n    this.printHeaderLine(\"instruction\",\"I\");\n    this.printHeaderLine(\"notes\",\"N\");\n    this.printHeaderLine(\"origin\",\"O\");\n    this.printHeaderLine(\"rhythm\",\"R\");\n    this.printHeaderLine(\"source\",\"S\");\n    this.printHeaderLine(\"unalignedwords\",\"W\");\n    this.printHeaderLine(\"transcription\",\"Z\");\n    //TODO part order\n    //TODO Q tempo\n    //TODO textBlock\n    this.printHeaderLine(\"NULL\",\"L\",\"1/8\"); //TODO L\n\n    this.printHeaderLine(\"NULL\",\"M\",this.getMeterString(this.abctune.lines[0].staff[0].meter));\n    this.printHeaderLine(\"NULL\",\"K\",this.getKeyString(this.abctune.lines[0].staff[0].key));//TODO K\n};\n\nTextPrinter.prototype.getKeyString = function(key) {\n    return key.root+key.acc+key.mode;\n};\n\nTextPrinter.prototype.getMeterString = function(meter) {\n    switch (meter.type) {\n    case \"cut_time\": return \"C|\";\n    case \"common_time\": return \"C\";\n    case \"specified\":\n      if (meter.value[0].den)\n\t\treturn meter.value[0].num+\"/\"+meter.value[0].den;\n      else\n\t    return meter.value[0].num;\n    }\n    return \"\";\n};\n\nTextPrinter.prototype.printHeaderLine = function(fieldname, abcfield, defaut) {\n    var val = this.abctune.metaText[fieldname] || defaut;\n    if (val !== undefined) {\n\tvar valarray = val.split(\"\\n\");\n\tfor (var i=0; i<valarray.length; i++) {\n\t    this.printString(abcfield+\": \"+valarray[i]);\n\t    this.printNewLine();\n\t} \n    }\n};\n\nTextPrinter.prototype.getElem = function() {\n    if (this.abcline.length <= this.pos)\n\treturn null;\n    return this.abcline[this.pos];\n};\n\nTextPrinter.prototype.getNextElem = function() {\n    if (this.abcline.length <= this.pos+1)\n\treturn null;\n    return this.abcline[this.pos+1];\n};\n\nTextPrinter.prototype.printBody = function() {\n    for(var line=0; line<this.abctune.lines.length; line++) {\n\tvar abcline = this.abctune.lines[line];\n\tif (abcline.staff) {\n\t    this.printABCLine(abcline.staff);\n\t} else if (abcline.subtitle && line!==0) {\n\t    //TODO\n\t} else if (abcline.text) {\n\t    //TODO\n\t}\n    }\n};\n\nTextPrinter.prototype.printABCLine = function(staffs) {\n    for (this.s = 0; this.s < staffs.length; this.s++) {\n\tthis.printABCStaff(staffs[this.s]);\n    }\n};\n\nTextPrinter.prototype.printABCStaff = function(abcstaff) {\n    \n    // TODO if (abcstaff.bracket) header += \"bracket \"+abcstaff.bracket+\" \";\n    // TODO if (abcstaff.brace) header += \"brace \"+abcstaff.brace+\" \";\n    \n    \n    for (this.v = 0; this.v < abcstaff.voices.length; this.v++) {\n\t// TODO stuff about voices\n\t\n\t// TODO this is where key sig is this.voice.addChild(this.printClef(abcstaff.clef));\n\t// this.voice.addChild(this.printKeySignature(abcstaff.key));\n\t// if (abcstaff.meter) this.voice.addChild(this.printTimeSignature(abcstaff.meter));\n\tthis.printABCVoice(abcstaff.voices[this.v]);\n    }\n    \n};\n\nTextPrinter.prototype.printABCVoice = function(abcline) {\n    this.abcline = abcline;\n    for (this.pos=0; this.pos<this.abcline.length; this.pos++) {\n\tthis.printABCElement();\n    }\n    this.printNewLine();\n};\n\nTextPrinter.prototype.printABCElement = function() {\n    var elem = this.getElem();\n    switch (elem.el_type) {\n    case \"note\":\n\tthis.printBeam();\n\tbreak;\n    case \"bar\":\n\tthis.printBarLine(elem);\n\tbreak;\n    case \"meter\":\n\t//TODO this.printTimeSignature(elem);\n\tbreak;\n    case \"clef\":\n\t//TODO this.printClef(elem);\n\tbreak;\n    case \"key\":\n\t//TODO this.printKeySignature(elem);\n    case \"stem\":\n\t//TODO do nothing?\n\tbreak;\n    case \"part\":\n\t//TODO print part\n\tbreak;\n    default:\n\t//TODO show we're missing something\n    }\n};\n\nTextPrinter.prototype.printBeam = function() {\n    this.printSpace();\n    if (this.getElem().startBeam && !this.getElem().endBeam) {\n\twhile (this.getElem()) {\n\t    this.printNote(this.getElem());\n\t    if (this.getElem().endBeam) {\n\t\tbreak;\n\t    }\n\t    this.pos++;\n\t}\n    } else {\n\tthis.printNote(this.getElem());\n    }\n    this.printSpace();\n};\n\nTextPrinter.prototype.printNote = function(elem) {\n    var str = \"\";\n\tvar i;\n    if (elem.chord !== undefined) {\n\tfor (i=0; i<elem.chord.length; i++) {\n\t    str+= '\"'+elem.chord[i].name+'\"';\n\t}\n    }\n    \n    //TODO unify map between names and symbols (to be used with abcparse?)\n    var decorations = {\n\t\"staccato\" : \".\",\n\t\"upbow\" : \"u\",\n\t\"downbow\" : \"v\",\n\t\"roll\" : \"~\",\n\t\"fermata\" : \"H\",\n\t\"slide\" : \"J\",\n\t\"accent\" : \"L\",\n\t\"mordent\" : \"M\",\n\t\"pralltriller\" : \"P\",\n\t\"trill\" : \"T\",\n\t\"lower\" : \".\"\n    };\n\n    if (elem.decoration !== undefined) {\n\tfor (i=0; i<elem.decoration.length; i++) {\n\t    var dec = elem.decoration[i];\n\t    if (decorations[dec]) {\n\t\tstr+=decorations[dec];\n\t    } else {\n\t\tstr+=\"!\"; //TODO hardcoded\n\t\tstr+=dec;\n\t\tstr+=\"!\"; //TODO hardcoded\n\t    }\n\t}\n    }\n\n    if (elem.gracenotes !== undefined) {\n\tstr+=\"{\";\n\tfor (i=0; i<elem.gracenotes.length; i++) {\n\t    str+=this.getNoteString(elem.gracenotes[i]);\n\t}\n\tstr+=\"}\";\n    }\n\n    var ignoreslur = false;\n    if (elem.pitches.length === 1 && elem.pitches[0].startSlur) {\n\tignoreslur = true;\n\tstr+=this.multiplyString(\"(\",elem.pitches[0].startSlur.length);\n    }\n\n    if (elem.startSlur) {\n\tstr+=this.multiplyString(\"(\",elem.startSlur.length);\n    }\n\n    if ((elem.pitches.length === 1 && elem.pitches[0].endSlur) || elem.endSlur) {\n\tignoreslur = true;\n    }\n\n    if (elem.startTriplet) {\n\tstr+=\"(3\";\n    }\n\n    if (elem.pitches) {\n\tif (elem.pitches.length > 1) str+=\"[\";\n\tfor (i=0; i<elem.pitches.length; i++) {\n\t    elem.pitches[i].duration = elem.duration;\n\t    str+=this.getNoteString(elem.pitches[i], ignoreslur);\n\t}\n\tif (elem.pitches.length > 1) str+=\"]\";\n    } \n\n    if (elem.pitches.length === 1 && elem.pitches[0].endSlur) {\n\tstr+=this.multiplyString(\")\",elem.pitches[0].endSlur.length);\n    }\n\n    if (elem.endSlur) {\n\tstr+=this.multiplyString(\")\",elem.endSlur.length);\n    }\n\n    this.printString(str,elem);\n\n};\n\n// accidentals, ties and sometimes slurs, sometimes duration\nTextPrinter.prototype.getNoteString = function(pitchelem, ignoreslur) {\n    var str = \"\";\n    if (!ignoreslur && pitchelem.startSlur) {\n\tstr+=\"(\";\n    }\n\n    var symb = \"\";\n    switch (pitchelem.accidental) {\n    case \"quartersharp\":\n\tsymb = \"^/\";\n\tbreak;\n    case \"dblsharp\":\n\tsymb = \"^^\";\n\tbreak;\n    case \"sharp\":\n\tsymb = \"^\";\n\tbreak;\n    case \"quarterflat\":\n\tsymb = \"_/\";\n\tbreak;\n    case \"flat\":\n\tsymb = \"_\";\n\tbreak;\n    case \"dblflat\":\n\tsymb = \"__\";\n\tbreak;\n    case \"natural\":\n\tsymb = \"=\";\n    }\n    str+=symb;\n\n    var pitches = [\"C\",\"D\",\"E\",\"F\",\"G\",\"A\",\"B\"];\n    var pitchstr = pitches[this.extractNote(pitchelem.pitch)];\n    var octave = this.extractOctave(pitchelem.pitch);\n    if (octave>0) {\n\tpitchstr = pitchstr.toLowerCase();\n\toctave--;\n\twhile (octave>0) {\n\t    pitchstr+=\"'\";\n\t    octave--;\n\t}\n    } else {\n\twhile (octave<0) {\n\t    pitchstr+=\",\";\n\t    octave++;\n\t}\n    }\n    \n    str+=pitchstr;\n    \n    if (pitchelem.duration) {\n\tstr+=this.getDurationString(pitchelem.duration);\n    }\n\n    if (!ignoreslur && pitchelem.endSlur) {\n\tstr+=\")\";\n    }\n\n    if (pitchelem.startTie) {\n\tstr+=\"-\";\n    }\n\n    return str;\n};\n\nTextPrinter.prototype.getDurationString = function(duration) {\n    //TODO detect crooked rhythm\n    if (duration/this.l > 1) {\n\treturn duration/this.l;\n    } \n    var ret = \"\";\n    if (this.l/duration>1) {\n\tret+=\"/\";\n\tif (this.l/duration>2) {\n\t    ret+=this.l/duration;\n\t}   \n    }\n    return ret;\n};\n\nTextPrinter.prototype.extractNote = function(pitch) {\n    var pitch2 = pitch%7;\n    if (pitch2<0) pitch2+=7;\n    return pitch2;\n};\n\nTextPrinter.prototype.extractOctave = function(pitch) {\n    return Math.floor(pitch/7);\n};\n\nTextPrinter.prototype.printBarLine = function(elem) {\n    var barstr = \"\";\n    switch (elem.type) {\n    case \"bar_thin\": barstr+=\"|\"; break;\n    case \"bar_thin_thick\": barstr+=\"|]\"; break;\n    case \"bar_thin_thin\": barstr+=\"||\"; break;\n    case \"bar_thick_thin\": barstr+=\"[|\"; break;\n    case \"bar_dbl_repeat\": barstr+=\":||:\"; break;\n    case \"bar_left_repeat\": barstr+=\"|:\"; break;\n    case \"bar_right_repeat\": barstr+=\":|\"; break;\n    case \"bar_invisible\": barstr+=\"\"; break;\n    }\n    this.printString(barstr,elem);\n};\n\nTextPrinter.prototype.multiplyString = function (s, n) {\n    var ret = \"\";\n    for (;n>0;n--) ret+=s;\n    return ret;\n};\n\nmodule.exports = TextPrinter;\n"]},"metadata":{},"sourceType":"script"}