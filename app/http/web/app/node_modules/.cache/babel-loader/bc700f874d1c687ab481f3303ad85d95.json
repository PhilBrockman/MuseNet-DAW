{"ast":null,"code":"//    abc_renderer.js: API to render to SVG/Raphael/whatever rendering engine\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global Math, console */\nvar glyphs = require('./abc_glyphs');\n\nvar spacing = require('./abc_spacing');\n\nvar sprintf = require('./sprintf');\n/**\n * Implements the API for rendering ABCJS Abstract Rendering Structure to a canvas/paper (e.g. SVG, Raphael, etc)\n * @param {Object} paper\n * @param {bool} doRegression\n */\n\n\nvar Renderer = function (paper, doRegression, shouldAddClasses) {\n  this.paper = paper;\n  this.controller = null; //TODO-GD only used when drawing the ABCJS ARS to connect the controller with the elements for highlighting\n\n  this.space = 3 * spacing.SPACE;\n  this.padding = {}; // renderer's padding is managed by the controller\n\n  this.doRegression = doRegression;\n  this.shouldAddClasses = shouldAddClasses;\n  if (this.doRegression) this.regressionLines = [];\n  this.reset();\n};\n\nRenderer.prototype.reset = function () {\n  this.paper.clear();\n  this.y = 0;\n  this.abctune = null;\n  this.lastM = null;\n  this.ingroup = false;\n  this.path = null;\n  this.isPrint = false;\n  this.initVerticalSpace();\n  if (this.doRegression) this.regressionLines = []; // HACK-PER: There was a problem in Raphael where every path string that was sent to it was cached.\n  // That was causing the browser's memory to steadily grow until the browser went slower and slower until\n  // it crashed. The fix to that was a patch to Raphael, so it is only patched on the versions of this library that\n  // bundle Raphael with it. Also, if Raphael gets an update, then that patch will be lost. On version 2.1.2 of Raphael,\n  // the patch is on line 1542 and 1545 and it is:\n  //             p[ps].sleep = 1;\n};\n/**\n * Set whether we are formatting this for the screen, or as a preview for creating a PDF version.\n * @param {bool} isPrint\n */\n\n\nRenderer.prototype.setPrintMode = function (isPrint) {\n  this.isPrint = isPrint;\n};\n/**\n * Set the size of the canvas.\n * @param {object} maxwidth\n * @param {object} scale\n */\n\n\nRenderer.prototype.setPaperSize = function (maxwidth, scale, responsive) {\n  var w = (maxwidth + this.padding.right) * scale;\n  var h = (this.y + this.padding.bottom) * scale;\n  if (this.isPrint) h = Math.max(h, 1056); // 11in x 72pt/in x 1.33px/pt\n  // TODO-PER: We are letting the page get as long as it needs now, but eventually that should go to a second page.\n\n  if (this.doRegression) this.regressionLines.push(\"PAPER SIZE: (\" + w + \",\" + h + \")\"); // for accessibility\n\n  this.paper.canvas.setAttribute(\"role\", \"img\");\n  var titleEl = document.createElement(\"title\");\n  var text = \"Sheet Music\";\n  if (this.abctune && this.abctune.metaText && this.abctune.metaText.title) text += \" for \\\"\" + this.abctune.metaText.title + '\"';\n  var title = document.createTextNode(text);\n  titleEl.appendChild(title);\n  this.paper.canvas.insertBefore(titleEl, this.paper.canvas.firstChild);\n\n  if (responsive === 'resize') {\n    // this technique is from: http://thenewcode.com/744/Make-SVG-Responsive, thx to https://github.com/iantresman\n    this.paper.canvas.parentNode.classList.add(\"abcjs-container\");\n    this.paper.canvas.setAttribute(\"viewBox\", \"0 0 \" + w + \" \" + h);\n    this.paper.canvas.setAttribute(\"preserveAspectRatio\", \"xMinYMin meet\");\n    this.paper.canvas.removeAttribute(\"height\");\n    this.paper.canvas.removeAttribute(\"width\");\n    this.paper.canvas.style['display'] = \"inline-block\";\n    this.paper.canvas.style['position'] = \"absolute\";\n    this.paper.canvas.style['top'] = \"0\";\n    this.paper.canvas.style['left'] = \"0\";\n    this.paper.canvas.parentNode.style['display'] = \"inline-block\";\n    this.paper.canvas.parentNode.style['position'] = \"relative\";\n    this.paper.canvas.parentNode.style['width'] = \"100%\"; // PER: I changed the padding from 100% to this through trial and error.\n    // The example was using a square image, but this music might be either wider or taller.\n\n    var padding = h / w * 100;\n    this.paper.canvas.parentNode.style['padding-bottom'] = padding + \"%\";\n    this.paper.canvas.parentNode.style['vertical-align'] = \"middle\";\n    this.paper.canvas.parentNode.style['overflow'] = \"hidden\";\n  } else {\n    this.paper.setSize(w / scale, h / scale); // Correct for IE problem in calculating height\n\n    var isIE =\n    /*@cc_on!@*/\n    false; //IE detector\n\n    if (isIE) {\n      this.paper.canvas.parentNode.style.width = w + \"px\";\n      this.paper.canvas.parentNode.style.height = \"\" + h + \"px\";\n    } else this.paper.canvas.parentNode.setAttribute(\"style\", \"width:\" + w + \"px\");\n  }\n\n  if (scale !== 1) {\n    this.paper.canvas.style.transform = \"scale(\" + scale + \",\" + scale + \")\";\n    this.paper.canvas.style['-ms-transform'] = \"scale(\" + scale + \",\" + scale + \")\";\n    this.paper.canvas.style['-webkit-transform'] = \"scale(\" + scale + \",\" + scale + \")\";\n    this.paper.canvas.style['transform-origin'] = \"0 0\";\n    this.paper.canvas.style['-ms-transform-origin-x'] = \"0\";\n    this.paper.canvas.style['-ms-transform-origin-y'] = \"0\";\n    this.paper.canvas.style['-webkit-transform-origin-x'] = \"0\";\n    this.paper.canvas.style['-webkit-transform-origin-y'] = \"0\";\n  } else {\n    this.paper.canvas.style.transform = \"\";\n    this.paper.canvas.style['-ms-transform'] = \"\";\n    this.paper.canvas.style['-webkit-transform'] = \"\";\n  }\n\n  this.paper.canvas.parentNode.style.overflow = \"hidden\";\n  if (responsive !== 'resize') this.paper.canvas.parentNode.style.height = \"\" + h + \"px\";\n};\n/**\n * Set the padding\n * @param {object} params\n */\n\n\nRenderer.prototype.setPaddingOverride = function (params) {\n  this.paddingOverride = {\n    top: params.paddingtop,\n    bottom: params.paddingbottom,\n    right: params.paddingright,\n    left: params.paddingleft\n  };\n};\n/**\n * Set the padding\n * @param {object} params\n */\n\n\nRenderer.prototype.setPadding = function (abctune) {\n  // If the padding is set in the tune, then use that.\n  // Otherwise, if the padding is set in the override, use that.\n  // Otherwise, use the defaults (there are a different set of defaults for screen and print.)\n  function setPaddingVariable(self, paddingKey, formattingKey, printDefault, screenDefault) {\n    if (abctune.formatting[formattingKey] !== undefined) self.padding[paddingKey] = abctune.formatting[formattingKey];else if (self.paddingOverride[paddingKey] !== undefined) self.padding[paddingKey] = self.paddingOverride[paddingKey];else if (self.isPrint) self.padding[paddingKey] = printDefault;else self.padding[paddingKey] = screenDefault;\n  } // 1cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 38px\n  // 1.8cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 68px\n\n\n  setPaddingVariable(this, 'top', 'topmargin', 38, 15);\n  setPaddingVariable(this, 'bottom', 'botmargin', 38, 15);\n  setPaddingVariable(this, 'left', 'leftmargin', 68, 15);\n  setPaddingVariable(this, 'right', 'rightmargin', 68, 15);\n};\n/**\n * Some of the items on the page are not scaled, so adjust them in the opposite direction of scaling to cancel out the scaling.\n * @param {float} scale\n */\n\n\nRenderer.prototype.adjustNonScaledItems = function (scale) {\n  this.padding.top /= scale;\n  this.padding.bottom /= scale;\n  this.padding.left /= scale;\n  this.padding.right /= scale;\n  this.abctune.formatting.headerfont.size /= scale;\n  this.abctune.formatting.footerfont.size /= scale;\n};\n/**\n * Set the the values for all the configurable vertical space options.\n */\n\n\nRenderer.prototype.initVerticalSpace = function () {\n  // conversion: 37.7953 = conversion factor for cm to px.\n  // All of the following values are in px.\n  this.spacing = {\n    composer: 7.56,\n    // Set the vertical space above the composer.\n    graceBefore: 8.67,\n    // Define the space before, inside and after the grace notes.\n    graceInside: 10.67,\n    graceAfter: 16,\n    info: 0,\n    // Set the vertical space above the infoline.\n    lineSkipFactor: 1.1,\n    // Set the factor for spacing between lines of text. (multiply this by the font size)\n    music: 7.56,\n    // Set the vertical space above the first staff.\n    paragraphSkipFactor: 0.4,\n    // Set the factor for spacing between text paragraphs. (multiply this by the font size)\n    parts: 11.33,\n    // Set the vertical space above a new part.\n    slurHeight: 1.0,\n    // Set the slur height factor.\n    staffSeparation: 61.33,\n    // Do not put a staff system closer than <unit> from the previous system.\n    stemHeight: 26.67 + 10,\n    // Set the stem height.\n    subtitle: 3.78,\n    // Set the vertical space above the subtitle.\n    systemStaffSeparation: 48,\n    // Do not place the staves closer than <unit> inside a system. * This values applies to all staves when in the tune header. Otherwise, it applies to the next staff\n    text: 18.9,\n    // Set the vertical space above the history.\n    title: 7.56,\n    // Set the vertical space above the title.\n    top: 30.24,\n    //Set the vertical space above the tunes and on the top of the continuation pages.\n    vocal: 30.67,\n    // Set the vertical space above the lyrics under the staves.\n    words: 0 // Set the vertical space above the lyrics at the end of the tune.\n\n  };\n  /*\n  TODO-PER: Handle the x-coordinate spacing items, too.\n  maxshrink <float>Default: 0.65\n  Set how much to compress horizontally when music line breaks\n  are automatic.\n  <float> must be between 0 (natural spacing)\n  and 1 (max shrinking).\n  // This next value is used to compute the natural spacing of\n  // the notes. The base spacing of the crotchet is always\n  // 40 pts. When the duration of a note type is twice the\n  // duration of an other note type, its spacing is multiplied\n  // by this factor.\n  // The default value causes the note spacing to be multiplied\n  // by 2 when its duration is multiplied by 4, i.e. the\n  // space of the semibreve is 80 pts and the space of the\n  // semiquaver is 20 pts.\n  // Setting this value to 1 sets all note spacing to 40 pts.\n  noteSpacingFactor: 1.414, // Set the note spacing factor to <float> (range 1..2).\n  scale <float> Default: 0.75 Set the page scale factor. Note that the header and footer are not scaled.\n  stretchlast <float>Default: 0.8\n  Stretch the last music line of a tune when it exceeds\n  the <float> fraction of the page width.\n  <float> range is 0.0 to 1.0.\n   */\n};\n\nRenderer.prototype.setVerticalSpace = function (formatting) {\n  // conversion from pts to px 4/3\n  if (formatting.staffsep !== undefined) this.spacing.staffSeparation = formatting.staffsep * 4 / 3;\n  if (formatting.composerspace !== undefined) this.spacing.composer = formatting.composerspace * 4 / 3;\n  if (formatting.partsspace !== undefined) this.spacing.parts = formatting.partsspace * 4 / 3;\n  if (formatting.textspace !== undefined) this.spacing.text = formatting.textspace * 4 / 3;\n  if (formatting.musicspace !== undefined) this.spacing.music = formatting.musicspace * 4 / 3;\n  if (formatting.titlespace !== undefined) this.spacing.title = formatting.titlespace * 4 / 3;\n  if (formatting.sysstaffsep !== undefined) this.spacing.systemStaffSeparation = formatting.sysstaffsep * 4 / 3;\n  if (formatting.subtitlespace !== undefined) this.spacing.subtitle = formatting.subtitlespace * 4 / 3;\n  if (formatting.topspace !== undefined) this.spacing.top = formatting.topspace * 4 / 3;\n  if (formatting.vocalspace !== undefined) this.spacing.vocal = formatting.vocalspace * 4 / 3;\n  if (formatting.wordsspace !== undefined) this.spacing.words = formatting.wordsspace * 4 / 3;\n};\n/**\n * Leave space at the top of the paper\n * @param {object} abctune\n */\n\n\nRenderer.prototype.topMargin = function (abctune) {\n  this.moveY(this.padding.top);\n};\n/**\n * Leave space before printing the music\n */\n\n\nRenderer.prototype.addMusicPadding = function () {\n  this.moveY(this.spacing.music);\n};\n/**\n * Leave space before printing a staff system\n */\n\n\nRenderer.prototype.addStaffPadding = function (lastStaffGroup, thisStaffGroup) {\n  var lastStaff = lastStaffGroup.staffs[lastStaffGroup.staffs.length - 1];\n  var lastBottomLine = -(lastStaff.bottom - 2); // The 2 is because the scale goes to 2 below the last line.\n\n  var nextTopLine = thisStaffGroup.staffs[0].top - 10; // Because 10 represents the top line.\n\n  var naturalSeparation = nextTopLine + lastBottomLine; // This is how far apart they'd be without extra spacing\n\n  var separationInPixels = naturalSeparation * spacing.STEP;\n  if (separationInPixels < this.spacing.staffSeparation) this.moveY(this.spacing.staffSeparation - separationInPixels);\n};\n/**\n * Text that goes above the score\n * @param {number} width\n * @param {object} abctune\n */\n\n\nRenderer.prototype.engraveTopText = function (width, abctune) {\n  if (abctune.metaText.header && this.isPrint) {\n    // Note: whether there is a header or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n    // This text goes above the margin, so we'll temporarily move up.\n    var headerTextHeight = this.getTextSize(\"XXXX\", \"headerfont\", 'abcjs-header abcjs-meta-top').height;\n    this.y -= headerTextHeight;\n    this.outputTextIf(this.padding.left, abctune.metaText.header.left, 'headerfont', 'header meta-top', 0, null, 'start');\n    this.outputTextIf(this.padding.left + width / 2, abctune.metaText.header.center, 'headerfont', 'header meta-top', 0, null, 'middle');\n    this.outputTextIf(this.padding.left + width, abctune.metaText.header.right, 'headerfont', 'header meta-top', 0, null, 'end');\n    this.y += headerTextHeight;\n  }\n\n  if (this.isPrint) this.moveY(this.spacing.top);\n  this.outputTextIf(this.padding.left + width / 2, abctune.metaText.title, 'titlefont', 'title meta-top', this.spacing.title, 0, 'middle');\n  if (abctune.lines[0]) this.outputTextIf(this.padding.left + width / 2, abctune.lines[0].subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n\n  if (abctune.metaText.rhythm || abctune.metaText.origin || abctune.metaText.composer) {\n    this.moveY(this.spacing.composer);\n    var rSpace = this.outputTextIf(this.padding.left, abctune.metaText.rhythm, 'infofont', 'meta-top', 0, null, \"start\");\n    var composerLine = \"\";\n    if (abctune.metaText.composer) composerLine += abctune.metaText.composer;\n    if (abctune.metaText.origin) composerLine += ' (' + abctune.metaText.origin + ')';\n\n    if (composerLine.length > 0) {\n      var space = this.outputTextIf(this.padding.left + width, composerLine, 'composerfont', 'meta-top', 0, null, \"end\");\n      this.moveY(space[1]);\n    } else {\n      this.moveY(rSpace[1]);\n    } // TODO-PER: The following is a hack to make the elements line up with abcm2ps. Don't know where the extra space is coming from.\n\n\n    this.moveY(-6); //} else if (this.isPrint) {\n    //\t// abcm2ps adds this space whether there is anything to write or not.\n    //\tthis.moveY(this.spacing.composer);\n    //\tvar space2 = this.getTextSize(\"M\", 'composerfont', 'meta-top');\n    //\tthis.moveY(space2.height);\n  }\n\n  this.outputTextIf(this.padding.left + width, abctune.metaText.author, 'composerfont', 'meta-top', 0, 0, \"end\"); //this.skipSpaceY();\n\n  this.outputTextIf(this.padding.left, abctune.metaText.partOrder, 'partsfont', 'meta-bottom', 0, 0, \"start\");\n};\n/**\n * Text that goes below the score\n * @param {number} width\n * @param {object} abctune\n */\n\n\nRenderer.prototype.engraveExtraText = function (width, abctune) {\n  this.lineNumber = null;\n  this.measureNumber = null;\n  this.noteNumber = null;\n  this.voiceNumber = null;\n  var extraText;\n\n  if (abctune.metaText.unalignedWords) {\n    extraText = \"\";\n\n    for (var j = 0; j < abctune.metaText.unalignedWords.length; j++) {\n      if (typeof abctune.metaText.unalignedWords[j] === 'string') extraText += abctune.metaText.unalignedWords[j] + \"\\n\";else {\n        for (var k = 0; k < abctune.metaText.unalignedWords[j].length; k++) {\n          extraText += \" FONT \" + abctune.metaText.unalignedWords[j][k].text;\n        }\n\n        extraText += \"\\n\";\n      }\n    }\n\n    this.outputTextIf(this.padding.left + spacing.INDENT, extraText, 'wordsfont', 'meta-bottom', this.spacing.words, 2, \"start\");\n  }\n\n  extraText = \"\";\n  if (abctune.metaText.book) extraText += \"Book: \" + abctune.metaText.book + \"\\n\";\n  if (abctune.metaText.source) extraText += \"Source: \" + abctune.metaText.source + \"\\n\";\n  if (abctune.metaText.discography) extraText += \"Discography: \" + abctune.metaText.discography + \"\\n\";\n  if (abctune.metaText.notes) extraText += \"Notes: \" + abctune.metaText.notes + \"\\n\";\n  if (abctune.metaText.transcription) extraText += \"Transcription: \" + abctune.metaText.transcription + \"\\n\";\n  if (abctune.metaText.history) extraText += \"History: \" + abctune.metaText.history + \"\\n\";\n  if (abctune.metaText['abc-copyright']) extraText += \"Copyright: \" + abctune.metaText['abc-copyright'] + \"\\n\";\n  if (abctune.metaText['abc-creator']) extraText += \"Creator: \" + abctune.metaText['abc-creator'] + \"\\n\";\n  if (abctune.metaText['abc-edited-by']) extraText += \"Edited By: \" + abctune.metaText['abc-edited-by'] + \"\\n\";\n  this.outputTextIf(this.padding.left, extraText, 'historyfont', 'meta-bottom', this.spacing.info, 0, \"start\");\n\n  if (abctune.metaText.footer && this.isPrint) {\n    // Note: whether there is a footer or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n    this.outputTextIf(this.padding.left, abctune.metaText.footer.left, 'footerfont', 'header meta-bottom', 0, null, 'start');\n    this.outputTextIf(this.padding.left + width / 2, abctune.metaText.footer.center, 'footerfont', 'header meta-bottom', 0, null, 'middle');\n    this.outputTextIf(this.padding.left + width, abctune.metaText.footer.right, 'footerfont', 'header meta-bottom', 0, null, 'end');\n  }\n};\n/**\n * Output text defined with %%text.\n * @param {array or string} text\n */\n\n\nRenderer.prototype.outputFreeText = function (text) {\n  if (text === \"\") {\n    // we do want to print out blank lines if they have been specified.\n    var hash = this.getFontAndAttr('textfont', 'defined-text');\n    this.moveY(hash.attr['font-size'] * 2); // move the distance of the line, plus the distance of the margin, which is also one line.\n  } else if (typeof text === 'string') this.outputTextIf(this.padding.left, text, 'textfont', 'defined-text', 0, 1, \"start\");else {\n    var str = \"\";\n    var isCentered = false; // The structure is wrong here: it requires an array to do centering, but it shouldn't have.\n\n    for (var i = 0; i < text.length; i++) {\n      if (text[i].font) str += \"FONT(\" + text[i].font + \")\";\n      str += text[i].text;\n      if (text[i].center) isCentered = true;\n    }\n\n    var alignment = isCentered ? 'middle' : 'start';\n    var x = isCentered ? this.controller.width / 2 : this.padding.left;\n    this.outputTextIf(x, str, 'textfont', 'defined-text', 0, 1, alignment);\n  }\n};\n/**\n * Output an extra subtitle that is defined later in the tune.\n */\n\n\nRenderer.prototype.outputSubtitle = function (width, subtitle) {\n  this.outputTextIf(this.padding.left + width / 2, subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n};\n/**\n * Begin a group of glyphs that will always be moved, scaled and highlighted together\n */\n\n\nRenderer.prototype.beginGroup = function () {\n  this.path = [];\n  this.lastM = [0, 0];\n  this.ingroup = true;\n};\n/**\n * Add a path to the current group\n * @param {Array} path\n * @private\n */\n\n\nRenderer.prototype.addPath = function (path) {\n  path = path || [];\n  if (path.length === 0) return;\n  path[0][0] = \"m\";\n  path[0][1] -= this.lastM[0];\n  path[0][2] -= this.lastM[1];\n  this.lastM[0] += path[0][1];\n  this.lastM[1] += path[0][2];\n  this.path.push(path[0]);\n\n  for (var i = 1, ii = path.length; i < ii; i++) {\n    if (path[i][0] === \"m\") {\n      this.lastM[0] += path[i][1];\n      this.lastM[1] += path[i][2];\n    }\n\n    this.path.push(path[i]);\n  }\n};\n/**\n * End a group of glyphs that will always be moved, scaled and highlighted together\n */\n\n\nRenderer.prototype.endGroup = function (klass) {\n  this.ingroup = false;\n  if (this.path.length === 0) return null;\n  var ret = this.paper.path().attr({\n    path: this.path,\n    stroke: \"none\",\n    fill: \"#000000\",\n    'class': this.addClasses(klass)\n  });\n  this.path = [];\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * gets scaled\n * @param {number} x1 start x\n * @param {number} x2 end x\n * @param {number} pitch pitch the stave line is drawn at\n */\n\n\nRenderer.prototype.printStaveLine = function (x1, x2, pitch, klass) {\n  var extraClass = \"staff\";\n  if (klass !== undefined) extraClass += \" \" + klass;\n  var isIE =\n  /*@cc_on!@*/\n  false; //IE detector\n\n  var dy = 0.35;\n  var fill = \"#000000\";\n\n  if (isIE) {\n    dy = 1;\n    fill = \"#666666\";\n  }\n\n  var y = this.calcY(pitch);\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x2, y - dy, x2, y + dy, x1, y + dy);\n  var ret = this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses(extraClass)\n  }).toBack();\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * gets scaled if not in a group\n * @param {number} x x coordinate of the stem\n * @param {number} dx stem width\n * @param {number} y1 y coordinate of the stem bottom\n * @param {number} y2 y coordinate of the stem top\n */\n\n\nRenderer.prototype.printStem = function (x, dx, y1, y2) {\n  if (dx < 0) {\n    // correct path \"handedness\" for intersection with other elements\n    var tmp = y2;\n    y2 = y1;\n    y1 = tmp;\n  }\n\n  var isIE =\n  /*@cc_on!@*/\n  false; //IE detector\n\n  var fill = \"#000000\";\n\n  if (isIE && dx < 1) {\n    dx = 1;\n    fill = \"#666666\";\n  }\n\n  if (~~x === x) x += 0.05; // raphael does weird rounding (for VML)\n\n  var pathArray = [[\"M\", x, y1], [\"L\", x, y2], [\"L\", x + dx, y2], [\"L\", x + dx, y1], [\"z\"]];\n\n  if (!isIE && this.ingroup) {\n    this.addPath(pathArray);\n  } else {\n    var ret = this.paper.path().attr({\n      path: pathArray,\n      stroke: \"none\",\n      fill: fill,\n      'class': this.addClasses('stem')\n    }).toBack();\n    if (this.doRegression) this.addToRegression(ret);\n    return ret;\n  }\n};\n\nfunction kernSymbols(lastSymbol, thisSymbol, lastSymbolWidth) {\n  // This is just some adjustments to make it look better.\n  var width = lastSymbolWidth;\n  if (lastSymbol === 'f' && thisSymbol === 'f') width = width * 2 / 3;\n  if (lastSymbol === 'p' && thisSymbol === 'p') width = width * 5 / 6;\n  if (lastSymbol === 'f' && thisSymbol === 'z') width = width * 5 / 8;\n  return width;\n}\n/**\n * assumes this.y is set appropriately\n * if symbol is a multichar string without a . (as in scripts.staccato) 1 symbol per char is assumed\n * not scaled if not in printgroup\n */\n\n\nRenderer.prototype.printSymbol = function (x, offset, symbol, scalex, scaley, klass) {\n  var el;\n  var ycorr;\n  if (!symbol) return null;\n\n  if (symbol.length > 0 && symbol.indexOf(\".\") < 0) {\n    var elemset = this.paper.set();\n    var dx = 0;\n\n    for (var i = 0; i < symbol.length; i++) {\n      var s = symbol.charAt(i);\n      ycorr = glyphs.getYCorr(s);\n      el = glyphs.printSymbol(x + dx, this.calcY(offset + ycorr), s, this.paper, klass);\n\n      if (el) {\n        if (this.doRegression) this.addToRegression(el);\n        elemset.push(el);\n        if (i < symbol.length - 1) dx += kernSymbols(s, symbol.charAt(i + 1), glyphs.getSymbolWidth(s));\n      } else {\n        this.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n      }\n    }\n\n    return elemset;\n  } else {\n    ycorr = glyphs.getYCorr(symbol);\n\n    if (this.ingroup) {\n      this.addPath(glyphs.getPathForSymbol(x, this.calcY(offset + ycorr), symbol, scalex, scaley));\n    } else {\n      el = glyphs.printSymbol(x, this.calcY(offset + ycorr), symbol, this.paper, klass);\n\n      if (el) {\n        if (this.doRegression) this.addToRegression(el);\n        return el;\n      } else this.renderText(x, this.y, \"no symbol:\" + symbol, \"debugfont\", 'debug-msg', 'start');\n    }\n\n    return null;\n  }\n};\n\nRenderer.prototype.printPath = function (attrs) {\n  var ret = this.paper.path().attr(attrs);\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n\nRenderer.prototype.drawBrace = function (xLeft, yTop, yBottom) {\n  //Tony\n  var yHeight = yBottom - yTop;\n  var xCurve = [7.5, -8, 21, 0, 18.5, -10.5, 7.5];\n  var yCurve = [0, yHeight / 5.5, yHeight / 3.14, yHeight / 2, yHeight / 2.93, yHeight / 4.88, 0];\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", xLeft + xCurve[0], yTop + yCurve[0], xLeft + xCurve[1], yTop + yCurve[1], xLeft + xCurve[2], yTop + yCurve[2], xLeft + xCurve[3], yTop + yCurve[3], xLeft + xCurve[4], yTop + yCurve[4], xLeft + xCurve[5], yTop + yCurve[5], xLeft + xCurve[6], yTop + yCurve[6]);\n  var ret1 = this.paper.path().attr({\n    path: pathString,\n    stroke: \"#000000\",\n    fill: \"#000000\",\n    'class': this.addClasses('brace')\n  });\n  xCurve = [0, 17.5, -7.5, 6.6, -5, 20, 0];\n  yCurve = [yHeight / 2, yHeight / 1.46, yHeight / 1.22, yHeight, yHeight / 1.19, yHeight / 1.42, yHeight / 2];\n  pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", xLeft + xCurve[0], yTop + yCurve[0], xLeft + xCurve[1], yTop + yCurve[1], xLeft + xCurve[2], yTop + yCurve[2], xLeft + xCurve[3], yTop + yCurve[3], xLeft + xCurve[4], yTop + yCurve[4], xLeft + xCurve[5], yTop + yCurve[5], xLeft + xCurve[6], yTop + yCurve[6]);\n  var ret2 = this.paper.path().attr({\n    path: pathString,\n    stroke: \"#000000\",\n    fill: \"#000000\",\n    'class': this.addClasses('brace')\n  });\n\n  if (this.doRegression) {\n    this.addToRegression(ret1);\n    this.addToRegression(ret2);\n  }\n\n  return ret1 + ret2;\n};\n\nRenderer.prototype.drawArc = function (x1, x2, pitch1, pitch2, above, klass, isTie) {\n  // If it is a tie vs. a slur, draw it shallower.\n  var spacing = isTie ? 1.2 : 1.5;\n  x1 = x1 + 6;\n  x2 = x2 + 4;\n  pitch1 = pitch1 + (above ? spacing : -spacing);\n  pitch2 = pitch2 + (above ? spacing : -spacing);\n  var y1 = this.calcY(pitch1);\n  var y2 = this.calcY(pitch2); //unit direction vector\n\n  var dx = x2 - x1;\n  var dy = y2 - y1;\n  var norm = Math.sqrt(dx * dx + dy * dy);\n  var ux = dx / norm;\n  var uy = dy / norm;\n  var flatten = norm / 3.5;\n  var maxFlatten = isTie ? 10 : 25; // If it is a tie vs. a slur, draw it shallower.\n\n  var curve = (above ? -1 : 1) * Math.min(maxFlatten, Math.max(4, flatten));\n  var controlx1 = x1 + flatten * ux - curve * uy;\n  var controly1 = y1 + flatten * uy + curve * ux;\n  var controlx2 = x2 - flatten * ux - curve * uy;\n  var controly2 = y2 - flatten * uy + curve * ux;\n  var thickness = 2;\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", x1, y1, controlx1, controly1, controlx2, controly2, x2, y2, controlx2 - thickness * uy, controly2 + thickness * ux, controlx1 - thickness * uy, controly1 + thickness * ux, x1, y1);\n  if (klass) klass += ' slur';else klass = 'slur';\n  var ret = this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: \"#000000\",\n    'class': this.addClasses(klass)\n  });\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n/**\n * Calculates the y for a given pitch value (relative to the stave the renderer is currently printing)\n * @param {number} ofs pitch value (bottom C on a G clef = 0, D=1, etc.)\n */\n\n\nRenderer.prototype.calcY = function (ofs) {\n  return this.y - ofs * spacing.STEP;\n};\n/**\n * Print @param {number} numLines. If there is 1 line it is the B line. Otherwise the bottom line is the E line.\n */\n\n\nRenderer.prototype.printStave = function (startx, endx, numLines) {\n  var klass = \"top-line\"; // If there is one line, it is the B line. Otherwise, the bottom line is the E line.\n\n  if (numLines === 1) {\n    this.printStaveLine(startx, endx, 6, klass);\n    return;\n  }\n\n  for (var i = numLines - 1; i >= 0; i--) {\n    this.printStaveLine(startx, endx, (i + 1) * 2, klass);\n    klass = undefined;\n  }\n};\n/**\n *\n * @private\n */\n\n\nRenderer.prototype.addClasses = function (c, isNote) {\n  if (!this.shouldAddClasses) return \"\";\n  var ret = [];\n  if (c.length > 0) ret.push(c);\n  if (this.lineNumber !== null && this.lineNumber !== undefined) ret.push(\"l\" + this.lineNumber);\n  if (this.measureNumber !== null && this.measureNumber !== undefined) ret.push(\"m\" + this.measureNumber);\n  if (this.voiceNumber !== null && this.voiceNumber !== undefined) ret.push(\"v\" + this.voiceNumber);\n  if (c.indexOf('note') >= 0 && this.noteNumber !== null && this.noteNumber !== undefined) ret.push(\"n\" + this.noteNumber); // add a prefix to all classes that abcjs adds.\n\n  if (ret.length > 0) {\n    ret = ret.join(' '); // Some strings are compound classes - that is, specify more than one class in a string.\n\n    ret = ret.split(' ');\n\n    for (var i = 0; i < ret.length; i++) {\n      if (ret[i].indexOf('abcjs-') !== 0 && ret[i].length > 0) // if the prefix doesn't already exist and the class is not blank.\n        ret[i] = 'abcjs-' + ret[i];\n    }\n  }\n\n  return ret.join(' ');\n};\n\nRenderer.prototype.getFontAndAttr = function (type, klass) {\n  var font = this.abctune.formatting[type]; // Raphael deliberately changes the font units to pixels for some reason, so we need to change points to pixels here.\n\n  if (font) font = {\n    face: font.face,\n    size: font.size * 4 / 3,\n    decoration: font.decoration,\n    style: font.style,\n    weight: font.weight,\n    box: font.box\n  };else font = {\n    face: \"Arial\",\n    size: 12 * 4 / 3,\n    decoration: \"underline\",\n    style: \"normal\",\n    weight: \"normal\"\n  };\n  var attr = {\n    \"font-size\": font.size,\n    'font-style': font.style,\n    \"font-family\": font.face,\n    'font-weight': font.weight,\n    'text-decoration': font.decoration,\n    'class': this.addClasses(klass)\n  };\n  attr.font = \"\"; // There is a spurious font definition that is put on all text elements. This overwrites it.\n\n  return {\n    font: font,\n    attr: attr\n  };\n};\n\nRenderer.prototype.getTextSize = function (text, type, klass) {\n  var hash = this.getFontAndAttr(type, klass);\n  var el = this.paper.text(0, 0, text).attr(hash.attr);\n  var size = el.getBBox();\n  if (isNaN(size.height)) // This can happen if the element isn't visible.\n    size = {\n      width: 0,\n      height: 0\n    };\n  el.remove();\n  if (hash.font.box) size.height += 8;\n  return size;\n};\n\nRenderer.prototype.renderText = function (x, y, text, type, klass, anchor, centerVertically) {\n  var hash = this.getFontAndAttr(type, klass);\n  if (anchor) hash.attr[\"text-anchor\"] = anchor;\n  text = text.replace(/\\n\\n/g, \"\\n \\n\");\n  text = text.replace(/^\\n/, \"\\xA0\\n\");\n  var el = this.paper.text(x, y, text).attr(hash.attr);\n\n  if (!centerVertically) {\n    // The text will be placed centered in vertical alignment, so we need to move the box down so that\n    // the top of the text is where we've requested.\n    var size = el.getBBox();\n    if (isNaN(size.height)) // This can happen if the element is hidden.\n      el.attr({\n        \"y\": y\n      });else {\n      if (hash.font.box) {\n        var padding = 2;\n        var margin = 2;\n        this.paper.rect(size.x - padding, size.y + size.height / 2 + margin, size.width + padding * 2, size.height + padding * 2 - margin).attr({\n          \"stroke\": \"#888888\"\n        });\n        size.height += 8;\n      }\n\n      el.attr({\n        \"y\": y + size.height / 2\n      });\n    }\n  }\n\n  if (type === 'debugfont') {\n    console.log(\"Debug msg: \" + text);\n    el.attr({\n      stroke: \"#ff0000\"\n    });\n  }\n\n  if (this.doRegression) this.addToRegression(el);\n  return el;\n};\n\nRenderer.prototype.moveY = function (em, numLines) {\n  if (numLines === undefined) numLines = 1;\n  this.y += em * numLines;\n};\n\nRenderer.prototype.skipSpaceY = function () {\n  this.y += this.space;\n}; // Call with 'kind' being the font type to use,\n// if marginBottom === null then don't increment the Y after printing, otherwise that is the extra number of em's to leave below the line.\n// and alignment being \"start\", \"middle\", or \"end\".\n\n\nRenderer.prototype.outputTextIf = function (x, str, kind, klass, marginTop, marginBottom, alignment) {\n  if (str) {\n    if (marginTop) this.moveY(marginTop);\n    var el = this.renderText(x, this.y, str, kind, klass, alignment);\n    var bb = el.getBBox(); // This can return NaN if the element isn't visible.\n\n    var width = isNaN(bb.width) ? 0 : bb.width;\n    var height = isNaN(bb.height) ? 0 : bb.height;\n\n    if (marginBottom !== null) {\n      var numLines = str.split(\"\\n\").length;\n      if (!isNaN(bb.height)) this.moveY(height / numLines, numLines + marginBottom);\n    }\n\n    return [width, height];\n  }\n\n  return [0, 0];\n};\n\nRenderer.prototype.addInvisibleMarker = function (className) {\n  var dy = 0.35;\n  var fill = \"rgba(0,0,0,0)\";\n  var y = this.y;\n  y = Math.round(y);\n  var x1 = 0;\n  var x2 = 100;\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x1 + x2, y - dy, x2, y + dy, x1, y + dy);\n  this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses(className),\n    'data-vertical': y\n  }).toBack();\n}; // For debugging, it is sometimes useful to know where you are vertically.\n\n\nRenderer.prototype.printHorizontalLine = function (width, vertical, comment) {\n  var dy = 0.35;\n  var fill = \"rgba(0,0,255,.4)\";\n  var y = this.y;\n  if (vertical) y = vertical;\n  y = Math.round(y);\n  this.paper.text(10, y, \"\" + Math.round(y)).attr({\n    \"text-anchor\": \"start\",\n    \"font-size\": \"18px\",\n    fill: fill,\n    stroke: fill\n  });\n  var x1 = 50;\n  var x2 = width;\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y - dy, x1 + x2, y - dy, x2, y + dy, x1, y + dy);\n  this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  }).toBack();\n\n  for (var i = 1; i < width / 100; i++) {\n    pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", i * 100 - dy, y - 5, i * 100 - dy, y + 5, i * 100 + dy, y - 5, i * 100 + dy, y + 5);\n    this.paper.path().attr({\n      path: pathString,\n      stroke: \"none\",\n      fill: fill,\n      'class': this.addClasses('staff')\n    }).toBack();\n  }\n\n  if (comment) this.paper.text(width + 70, y, comment).attr({\n    \"text-anchor\": \"start\",\n    \"font-size\": \"18px\",\n    fill: fill,\n    stroke: fill\n  });\n};\n\nRenderer.prototype.printShadedBox = function (x, y, width, height, color, comment) {\n  var box = this.paper.rect(x, y, width, height).attr({\n    fill: color,\n    stroke: color\n  });\n  if (comment) this.paper.text(0, y + 7, comment).attr({\n    \"text-anchor\": \"start\",\n    \"font-size\": \"14px\",\n    fill: \"rgba(0,0,255,.4)\",\n    stroke: \"rgba(0,0,255,.4)\"\n  });\n  return box;\n};\n\nRenderer.prototype.printVerticalLine = function (x, y1, y2) {\n  var dy = 0.35;\n  var fill = \"#00aaaa\";\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - dy, y1, x - dy, y2, x + dy, y1, x + dy, y2);\n  this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  }).toBack();\n  pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - 20, y1, x - 20, y1 + 3, x, y1, x, y1 + 3);\n  this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  }).toBack();\n  pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x + 20, y2, x + 20, y2 + 3, x, y2, x, y2 + 3);\n  this.paper.path().attr({\n    path: pathString,\n    stroke: \"none\",\n    fill: fill,\n    'class': this.addClasses('staff')\n  }).toBack();\n};\n/**\n * @private\n */\n\n\nRenderer.prototype.addToRegression = function (el) {\n  var box = el.getBBox(); //var str = \"(\"+box.x+\",\"+box.y+\")[\"+box.width+\",\"+box.height+\"] \"\n\n  var str = el.type + ' ' + box.toString() + ' ';\n  var attrs = [];\n\n  for (var key in el.attrs) {\n    if (el.attrs.hasOwnProperty(key)) {\n      if (key === 'class') str = el.attrs[key] + \" \" + str;else attrs.push(key + \": \" + el.attrs[key]);\n    }\n  }\n\n  attrs.sort();\n  str += \"{ \" + attrs.join(\" \") + \" }\";\n  this.regressionLines.push(str);\n};\n\nmodule.exports = Renderer;","map":{"version":3,"sources":["/Users/philbrockman/coding/MusicalGens/app/http/web/app/node_modules/abcjs/src/write/abc_renderer.js"],"names":["glyphs","require","spacing","sprintf","Renderer","paper","doRegression","shouldAddClasses","controller","space","SPACE","padding","regressionLines","reset","prototype","clear","y","abctune","lastM","ingroup","path","isPrint","initVerticalSpace","setPrintMode","setPaperSize","maxwidth","scale","responsive","w","right","h","bottom","Math","max","push","canvas","setAttribute","titleEl","document","createElement","text","metaText","title","createTextNode","appendChild","insertBefore","firstChild","parentNode","classList","add","removeAttribute","style","setSize","isIE","width","height","transform","overflow","setPaddingOverride","params","paddingOverride","top","paddingtop","paddingbottom","paddingright","left","paddingleft","setPadding","setPaddingVariable","self","paddingKey","formattingKey","printDefault","screenDefault","formatting","undefined","adjustNonScaledItems","headerfont","size","footerfont","composer","graceBefore","graceInside","graceAfter","info","lineSkipFactor","music","paragraphSkipFactor","parts","slurHeight","staffSeparation","stemHeight","subtitle","systemStaffSeparation","vocal","words","setVerticalSpace","staffsep","composerspace","partsspace","textspace","musicspace","titlespace","sysstaffsep","subtitlespace","topspace","vocalspace","wordsspace","topMargin","moveY","addMusicPadding","addStaffPadding","lastStaffGroup","thisStaffGroup","lastStaff","staffs","length","lastBottomLine","nextTopLine","naturalSeparation","separationInPixels","STEP","engraveTopText","header","headerTextHeight","getTextSize","outputTextIf","center","lines","rhythm","origin","rSpace","composerLine","author","partOrder","engraveExtraText","lineNumber","measureNumber","noteNumber","voiceNumber","extraText","unalignedWords","j","k","INDENT","book","source","discography","notes","transcription","history","footer","outputFreeText","hash","getFontAndAttr","attr","str","isCentered","i","font","alignment","x","outputSubtitle","beginGroup","addPath","ii","endGroup","klass","ret","stroke","fill","addClasses","addToRegression","printStaveLine","x1","x2","pitch","extraClass","dy","calcY","pathString","toBack","printStem","dx","y1","y2","tmp","pathArray","kernSymbols","lastSymbol","thisSymbol","lastSymbolWidth","printSymbol","offset","symbol","scalex","scaley","el","ycorr","indexOf","elemset","set","s","charAt","getYCorr","getSymbolWidth","renderText","getPathForSymbol","printPath","attrs","drawBrace","xLeft","yTop","yBottom","yHeight","xCurve","yCurve","ret1","ret2","drawArc","pitch1","pitch2","above","isTie","norm","sqrt","ux","uy","flatten","maxFlatten","curve","min","controlx1","controly1","controlx2","controly2","thickness","ofs","printStave","startx","endx","numLines","c","isNote","join","split","type","face","decoration","weight","box","getBBox","isNaN","remove","anchor","centerVertically","replace","margin","rect","console","log","em","skipSpaceY","kind","marginTop","marginBottom","bb","addInvisibleMarker","className","round","printHorizontalLine","vertical","comment","printShadedBox","color","printVerticalLine","toString","key","hasOwnProperty","sort","module","exports"],"mappings":"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","sourcesContent":["//    abc_renderer.js: API to render to SVG/Raphael/whatever rendering engine\n//    Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n/*global Math, console */\n\nvar glyphs = require('./abc_glyphs');\nvar spacing = require('./abc_spacing');\nvar sprintf = require('./sprintf');\n\n/**\n * Implements the API for rendering ABCJS Abstract Rendering Structure to a canvas/paper (e.g. SVG, Raphael, etc)\n * @param {Object} paper\n * @param {bool} doRegression\n */\nvar Renderer = function(paper, doRegression, shouldAddClasses) {\n  this.paper = paper;\n  this.controller = null; //TODO-GD only used when drawing the ABCJS ARS to connect the controller with the elements for highlighting\n\n\tthis.space = 3*spacing.SPACE;\n  this.padding = {}; // renderer's padding is managed by the controller\n  this.doRegression = doRegression;\n  this.shouldAddClasses = shouldAddClasses;\n  if (this.doRegression)\n    this.regressionLines = [];\n\tthis.reset();\n};\n\nRenderer.prototype.reset = function() {\n\n\tthis.paper.clear();\n\tthis.y = 0;\n\tthis.abctune = null;\n\tthis.lastM = null;\n\tthis.ingroup = false;\n\tthis.path = null;\n\tthis.isPrint = false;\n\tthis.initVerticalSpace();\n\tif (this.doRegression)\n\t\tthis.regressionLines = [];\n\t// HACK-PER: There was a problem in Raphael where every path string that was sent to it was cached.\n\t// That was causing the browser's memory to steadily grow until the browser went slower and slower until\n\t// it crashed. The fix to that was a patch to Raphael, so it is only patched on the versions of this library that\n\t// bundle Raphael with it. Also, if Raphael gets an update, then that patch will be lost. On version 2.1.2 of Raphael,\n\t// the patch is on line 1542 and 1545 and it is:\n\t//             p[ps].sleep = 1;\n};\n\n/**\n * Set whether we are formatting this for the screen, or as a preview for creating a PDF version.\n * @param {bool} isPrint\n */\nRenderer.prototype.setPrintMode = function (isPrint) {\n\tthis.isPrint = isPrint;\n};\n\n/**\n * Set the size of the canvas.\n * @param {object} maxwidth\n * @param {object} scale\n */\nRenderer.prototype.setPaperSize = function (maxwidth, scale, responsive) {\n\tvar w = (maxwidth+this.padding.right)*scale;\n\tvar h = (this.y+this.padding.bottom)*scale;\n\tif (this.isPrint)\n\t\th = Math.max(h, 1056); // 11in x 72pt/in x 1.33px/pt\n\t// TODO-PER: We are letting the page get as long as it needs now, but eventually that should go to a second page.\n\tif (this.doRegression)\n\t\tthis.regressionLines.push(\"PAPER SIZE: (\"+w+\",\"+h+\")\");\n\n\t// for accessibility\n\tthis.paper.canvas.setAttribute(\"role\", \"img\");\n\tvar titleEl = document.createElement(\"title\");\n\tvar text = \"Sheet Music\";\n\tif (this.abctune && this.abctune.metaText && this.abctune.metaText.title)\n\t\ttext += \" for \\\"\" + this.abctune.metaText.title + '\"';\n\tvar title = document.createTextNode(text);\n\ttitleEl.appendChild(title);\n\tthis.paper.canvas.insertBefore(titleEl, this.paper.canvas.firstChild);\n\n\tif (responsive === 'resize') {\n\t\t// this technique is from: http://thenewcode.com/744/Make-SVG-Responsive, thx to https://github.com/iantresman\n\t\tthis.paper.canvas.parentNode.classList.add(\"abcjs-container\");\n\t\tthis.paper.canvas.setAttribute(\"viewBox\", \"0 0 \" + w + \" \" + h);\n\t\tthis.paper.canvas.setAttribute(\"preserveAspectRatio\", \"xMinYMin meet\");\n\t\tthis.paper.canvas.removeAttribute(\"height\");\n\t\tthis.paper.canvas.removeAttribute(\"width\");\n\t\tthis.paper.canvas.style['display'] = \"inline-block\";\n\t\tthis.paper.canvas.style['position'] = \"absolute\";\n\t\tthis.paper.canvas.style['top'] = \"0\";\n\t\tthis.paper.canvas.style['left'] = \"0\";\n\t\tthis.paper.canvas.parentNode.style['display'] = \"inline-block\";\n\t\tthis.paper.canvas.parentNode.style['position'] = \"relative\";\n\t\tthis.paper.canvas.parentNode.style['width'] = \"100%\";\n\t\t// PER: I changed the padding from 100% to this through trial and error.\n\t\t// The example was using a square image, but this music might be either wider or taller.\n\t\tvar padding = h / w * 100;\n\t\tthis.paper.canvas.parentNode.style['padding-bottom'] = padding + \"%\";\n\t\tthis.paper.canvas.parentNode.style['vertical-align'] = \"middle\";\n\t\tthis.paper.canvas.parentNode.style['overflow'] = \"hidden\";\n\n\t} else {\n\t\tthis.paper.setSize(w / scale, h / scale);\n\t\t// Correct for IE problem in calculating height\n\t\tvar isIE = /*@cc_on!@*/false;//IE detector\n\t\tif (isIE) {\n\t\t\tthis.paper.canvas.parentNode.style.width = w + \"px\";\n\t\t\tthis.paper.canvas.parentNode.style.height = \"\" + h + \"px\";\n\t\t} else\n\t\t\tthis.paper.canvas.parentNode.setAttribute(\"style\", \"width:\" + w + \"px\");\n\t}\n\tif (scale !== 1) {\n\t\tthis.paper.canvas.style.transform = \"scale(\"+scale+\",\"+scale+\")\";\n\t\tthis.paper.canvas.style['-ms-transform'] = \"scale(\"+scale+\",\"+scale+\")\";\n\t\tthis.paper.canvas.style['-webkit-transform'] = \"scale(\"+scale+\",\"+scale+\")\";\n\t\tthis.paper.canvas.style['transform-origin'] = \"0 0\";\n\t\tthis.paper.canvas.style['-ms-transform-origin-x'] = \"0\";\n\t\tthis.paper.canvas.style['-ms-transform-origin-y'] = \"0\";\n\t\tthis.paper.canvas.style['-webkit-transform-origin-x'] = \"0\";\n\t\tthis.paper.canvas.style['-webkit-transform-origin-y'] = \"0\";\n\t} else {\n\t\tthis.paper.canvas.style.transform = \"\";\n\t\tthis.paper.canvas.style['-ms-transform'] = \"\";\n\t\tthis.paper.canvas.style['-webkit-transform'] = \"\";\n\t}\n\tthis.paper.canvas.parentNode.style.overflow=\"hidden\";\n\tif (responsive !== 'resize')\n\t\tthis.paper.canvas.parentNode.style.height=\"\"+h+\"px\";\n};\n\n/**\n * Set the padding\n * @param {object} params\n */\nRenderer.prototype.setPaddingOverride = function(params) {\n\tthis.paddingOverride = { top: params.paddingtop, bottom: params.paddingbottom,\n\t\tright: params.paddingright, left: params.paddingleft };\n};\n\n/**\n * Set the padding\n * @param {object} params\n */\nRenderer.prototype.setPadding = function(abctune) {\n\t// If the padding is set in the tune, then use that.\n\t// Otherwise, if the padding is set in the override, use that.\n\t// Otherwise, use the defaults (there are a different set of defaults for screen and print.)\n\tfunction setPaddingVariable(self, paddingKey, formattingKey, printDefault, screenDefault) {\n\t\tif (abctune.formatting[formattingKey] !== undefined)\n\t\t\tself.padding[paddingKey] = abctune.formatting[formattingKey];\n\t\telse if (self.paddingOverride[paddingKey] !== undefined)\n\t\t\tself.padding[paddingKey] = self.paddingOverride[paddingKey];\n\t\telse if (self.isPrint)\n\t\t\tself.padding[paddingKey] = printDefault;\n\t\telse\n\t\t\tself.padding[paddingKey] = screenDefault;\n\t}\n\t// 1cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 38px\n\t// 1.8cm x 0.393701in/cm x 72pt/in x 1.33px/pt = 68px\n\tsetPaddingVariable(this, 'top', 'topmargin', 38, 15);\n\tsetPaddingVariable(this, 'bottom', 'botmargin', 38, 15);\n\tsetPaddingVariable(this, 'left', 'leftmargin', 68, 15);\n\tsetPaddingVariable(this, 'right', 'rightmargin', 68, 15);\n};\n\n/**\n * Some of the items on the page are not scaled, so adjust them in the opposite direction of scaling to cancel out the scaling.\n * @param {float} scale\n */\nRenderer.prototype.adjustNonScaledItems = function (scale) {\n\tthis.padding.top /= scale;\n\tthis.padding.bottom /= scale;\n\tthis.padding.left /= scale;\n\tthis.padding.right /= scale;\n\tthis.abctune.formatting.headerfont.size /= scale;\n\tthis.abctune.formatting.footerfont.size /= scale;\n};\n\n/**\n * Set the the values for all the configurable vertical space options.\n */\nRenderer.prototype.initVerticalSpace = function() {\n\t// conversion: 37.7953 = conversion factor for cm to px.\n\t// All of the following values are in px.\n\tthis.spacing = {\n\t\tcomposer: 7.56, // Set the vertical space above the composer.\n\t\tgraceBefore: 8.67, // Define the space before, inside and after the grace notes.\n\t\tgraceInside: 10.67,\n\t\tgraceAfter: 16,\n\t\tinfo: 0, // Set the vertical space above the infoline.\n\t\tlineSkipFactor: 1.1, // Set the factor for spacing between lines of text. (multiply this by the font size)\n\t\tmusic: 7.56, // Set the vertical space above the first staff.\n\t\tparagraphSkipFactor: 0.4, // Set the factor for spacing between text paragraphs. (multiply this by the font size)\n\t\tparts: 11.33, // Set the vertical space above a new part.\n\t\tslurHeight: 1.0, // Set the slur height factor.\n\t\tstaffSeparation: 61.33, // Do not put a staff system closer than <unit> from the previous system.\n\t\tstemHeight: 26.67+10, // Set the stem height.\n\t\tsubtitle: 3.78, // Set the vertical space above the subtitle.\n\t\tsystemStaffSeparation: 48, // Do not place the staves closer than <unit> inside a system. * This values applies to all staves when in the tune header. Otherwise, it applies to the next staff\n\t\ttext: 18.9, // Set the vertical space above the history.\n\t\ttitle: 7.56, // Set the vertical space above the title.\n\t\ttop: 30.24, //Set the vertical space above the tunes and on the top of the continuation pages.\n\t\tvocal: 30.67, // Set the vertical space above the lyrics under the staves.\n\t\twords: 0 // Set the vertical space above the lyrics at the end of the tune.\n\t};\n\t/*\n\tTODO-PER: Handle the x-coordinate spacing items, too.\nmaxshrink <float>Default: 0.65\nSet how much to compress horizontally when music line breaks\nare automatic.\n<float> must be between 0 (natural spacing)\nand 1 (max shrinking).\n\n// This next value is used to compute the natural spacing of\n// the notes. The base spacing of the crotchet is always\n// 40 pts. When the duration of a note type is twice the\n// duration of an other note type, its spacing is multiplied\n// by this factor.\n// The default value causes the note spacing to be multiplied\n// by 2 when its duration is multiplied by 4, i.e. the\n// space of the semibreve is 80 pts and the space of the\n// semiquaver is 20 pts.\n// Setting this value to 1 sets all note spacing to 40 pts.\nnoteSpacingFactor: 1.414, // Set the note spacing factor to <float> (range 1..2).\n\nscale <float> Default: 0.75 Set the page scale factor. Note that the header and footer are not scaled.\n\nstretchlast <float>Default: 0.8\nStretch the last music line of a tune when it exceeds\nthe <float> fraction of the page width.\n<float> range is 0.0 to 1.0.\n\t */\n};\n\nRenderer.prototype.setVerticalSpace = function(formatting) {\n\t// conversion from pts to px 4/3\n\tif (formatting.staffsep !== undefined)\n\t\tthis.spacing.staffSeparation = formatting.staffsep *4/3;\n\tif (formatting.composerspace !== undefined)\n\t\tthis.spacing.composer = formatting.composerspace *4/3;\n\tif (formatting.partsspace !== undefined)\n\t\tthis.spacing.parts = formatting.partsspace *4/3;\n\tif (formatting.textspace !== undefined)\n\t\tthis.spacing.text = formatting.textspace *4/3;\n\tif (formatting.musicspace !== undefined)\n\t\tthis.spacing.music = formatting.musicspace *4/3;\n\tif (formatting.titlespace !== undefined)\n\t\tthis.spacing.title = formatting.titlespace *4/3;\n\tif (formatting.sysstaffsep !== undefined)\n\t\tthis.spacing.systemStaffSeparation = formatting.sysstaffsep *4/3;\n\tif (formatting.subtitlespace !== undefined)\n\t\tthis.spacing.subtitle = formatting.subtitlespace *4/3;\n\tif (formatting.topspace !== undefined)\n\t\tthis.spacing.top = formatting.topspace *4/3;\n\tif (formatting.vocalspace !== undefined)\n\t\tthis.spacing.vocal = formatting.vocalspace *4/3;\n\tif (formatting.wordsspace !== undefined)\n\t\tthis.spacing.words = formatting.wordsspace *4/3;\n};\n\n/**\n * Leave space at the top of the paper\n * @param {object} abctune\n */\nRenderer.prototype.topMargin = function(abctune) {\n\t\tthis.moveY(this.padding.top);\n};\n\n/**\n * Leave space before printing the music\n */\nRenderer.prototype.addMusicPadding = function() {\n\t\tthis.moveY(this.spacing.music);\n};\n\n/**\n * Leave space before printing a staff system\n */\nRenderer.prototype.addStaffPadding = function(lastStaffGroup, thisStaffGroup) {\n\tvar lastStaff = lastStaffGroup.staffs[lastStaffGroup.staffs.length-1];\n\tvar lastBottomLine = -(lastStaff.bottom - 2); // The 2 is because the scale goes to 2 below the last line.\n\tvar nextTopLine = thisStaffGroup.staffs[0].top - 10; // Because 10 represents the top line.\n\tvar naturalSeparation = nextTopLine + lastBottomLine; // This is how far apart they'd be without extra spacing\n\tvar separationInPixels = naturalSeparation * spacing.STEP;\n\tif (separationInPixels < this.spacing.staffSeparation)\n\t\tthis.moveY(this.spacing.staffSeparation-separationInPixels);\n};\n\n/**\n * Text that goes above the score\n * @param {number} width\n * @param {object} abctune\n */\nRenderer.prototype.engraveTopText = function(width, abctune) {\n\tif (abctune.metaText.header && this.isPrint) {\n\t\t// Note: whether there is a header or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n\t\t// This text goes above the margin, so we'll temporarily move up.\n\t\tvar headerTextHeight = this.getTextSize(\"XXXX\", \"headerfont\", 'abcjs-header abcjs-meta-top').height;\n\t\tthis.y -=headerTextHeight;\n\t\tthis.outputTextIf(this.padding.left, abctune.metaText.header.left, 'headerfont', 'header meta-top', 0, null, 'start');\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.header.center, 'headerfont', 'header meta-top', 0, null, 'middle');\n\t\tthis.outputTextIf(this.padding.left + width, abctune.metaText.header.right, 'headerfont', 'header meta-top', 0, null, 'end');\n\t\tthis.y += headerTextHeight;\n\t}\n\tif (this.isPrint)\n\t\tthis.moveY(this.spacing.top);\n\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.title, 'titlefont', 'title meta-top', this.spacing.title, 0, 'middle');\n\tif (abctune.lines[0])\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.lines[0].subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n\n\tif (abctune.metaText.rhythm || abctune.metaText.origin || abctune.metaText.composer) {\n\t\tthis.moveY(this.spacing.composer);\n\t\tvar rSpace = this.outputTextIf(this.padding.left, abctune.metaText.rhythm, 'infofont', 'meta-top', 0, null, \"start\");\n\n\t\tvar composerLine = \"\";\n\t\tif (abctune.metaText.composer) composerLine += abctune.metaText.composer;\n\t\tif (abctune.metaText.origin) composerLine += ' (' + abctune.metaText.origin + ')';\n\t\tif (composerLine.length > 0) {\n\t\t\tvar space = this.outputTextIf(this.padding.left + width, composerLine, 'composerfont', 'meta-top', 0, null, \"end\");\n\t\t\tthis.moveY(space[1]);\n\t\t} else {\n\t\t\tthis.moveY(rSpace[1]);\n\t\t}\n\t\t// TODO-PER: The following is a hack to make the elements line up with abcm2ps. Don't know where the extra space is coming from.\n\t\tthis.moveY(-6);\n\t//} else if (this.isPrint) {\n\t//\t// abcm2ps adds this space whether there is anything to write or not.\n\t//\tthis.moveY(this.spacing.composer);\n\t//\tvar space2 = this.getTextSize(\"M\", 'composerfont', 'meta-top');\n\t//\tthis.moveY(space2.height);\n\t}\n\n\tthis.outputTextIf(this.padding.left + width, abctune.metaText.author, 'composerfont', 'meta-top', 0, 0, \"end\");\n\t//this.skipSpaceY();\n\n\tthis.outputTextIf(this.padding.left, abctune.metaText.partOrder, 'partsfont', 'meta-bottom', 0, 0, \"start\");\n};\n\n/**\n * Text that goes below the score\n * @param {number} width\n * @param {object} abctune\n */\nRenderer.prototype.engraveExtraText = function(width, abctune) {\n\tthis.lineNumber = null;\n\tthis.measureNumber = null;\n\tthis.noteNumber = null;\n\tthis.voiceNumber = null;\n\n\tvar extraText;\n\tif (abctune.metaText.unalignedWords) {\n\t\textraText = \"\";\n\t\tfor (var j = 0; j < abctune.metaText.unalignedWords.length; j++) {\n\t\t\tif (typeof abctune.metaText.unalignedWords[j] === 'string')\n\t\t\t\textraText += abctune.metaText.unalignedWords[j] + \"\\n\";\n\t\t\telse {\n\t\t\t\tfor (var k = 0; k < abctune.metaText.unalignedWords[j].length; k++) {\n\t\t\t\t\textraText += \" FONT \" + abctune.metaText.unalignedWords[j][k].text;\n\t\t\t\t}\n\t\t\t\textraText += \"\\n\";\n\t\t\t}\n\t\t}\n\t\tthis.outputTextIf(this.padding.left + spacing.INDENT, extraText, 'wordsfont', 'meta-bottom', this.spacing.words, 2, \"start\");\n\t}\n\n\textraText = \"\";\n\tif (abctune.metaText.book) extraText += \"Book: \" + abctune.metaText.book + \"\\n\";\n\tif (abctune.metaText.source) extraText += \"Source: \" + abctune.metaText.source + \"\\n\";\n\tif (abctune.metaText.discography) extraText += \"Discography: \" + abctune.metaText.discography + \"\\n\";\n\tif (abctune.metaText.notes) extraText += \"Notes: \" + abctune.metaText.notes + \"\\n\";\n\tif (abctune.metaText.transcription) extraText += \"Transcription: \" + abctune.metaText.transcription + \"\\n\";\n\tif (abctune.metaText.history) extraText += \"History: \" + abctune.metaText.history + \"\\n\";\n\tif (abctune.metaText['abc-copyright']) extraText += \"Copyright: \" + abctune.metaText['abc-copyright'] + \"\\n\";\n\tif (abctune.metaText['abc-creator']) extraText += \"Creator: \" + abctune.metaText['abc-creator'] + \"\\n\";\n\tif (abctune.metaText['abc-edited-by']) extraText += \"Edited By: \" + abctune.metaText['abc-edited-by'] + \"\\n\";\n\tthis.outputTextIf(this.padding.left, extraText, 'historyfont', 'meta-bottom', this.spacing.info, 0, \"start\");\n\n\tif (abctune.metaText.footer && this.isPrint) {\n\t\t// Note: whether there is a footer or not doesn't change any other positioning, so this doesn't change the Y-coordinate.\n\t\tthis.outputTextIf(this.padding.left, abctune.metaText.footer.left, 'footerfont', 'header meta-bottom', 0, null, 'start');\n\t\tthis.outputTextIf(this.padding.left + width / 2, abctune.metaText.footer.center, 'footerfont', 'header meta-bottom', 0, null, 'middle');\n\t\tthis.outputTextIf(this.padding.left + width, abctune.metaText.footer.right, 'footerfont', 'header meta-bottom', 0, null, 'end');\n\t}\n};\n\n/**\n * Output text defined with %%text.\n * @param {array or string} text\n */\nRenderer.prototype.outputFreeText = function (text) {\n\tif (text === \"\") {\t// we do want to print out blank lines if they have been specified.\n\t\tvar hash = this.getFontAndAttr('textfont', 'defined-text');\n\t\tthis.moveY(hash.attr['font-size'] * 2); // move the distance of the line, plus the distance of the margin, which is also one line.\n\t} else if (typeof text === 'string')\n\t\tthis.outputTextIf(this.padding.left, text, 'textfont', 'defined-text', 0, 1, \"start\");\n\telse {\n\t\tvar str = \"\";\n\t\tvar isCentered = false; // The structure is wrong here: it requires an array to do centering, but it shouldn't have.\n\t\tfor (var i = 0; i < text.length; i++) {\n\t\t\tif (text[i].font)\n\t\t\t\tstr += \"FONT(\" + text[i].font + \")\";\n\t\t\tstr += text[i].text;\n\t\t\tif (text[i].center)\n\t\t\t\tisCentered = true;\n\t\t}\n\t\tvar alignment = isCentered ? 'middle' : 'start';\n\t\tvar x = isCentered ? this.controller.width / 2 : this.padding.left;\n\t\tthis.outputTextIf(x, str, 'textfont', 'defined-text', 0, 1, alignment);\n\t}\n};\n\n/**\n * Output an extra subtitle that is defined later in the tune.\n */\nRenderer.prototype.outputSubtitle = function (width, subtitle) {\n\tthis.outputTextIf(this.padding.left + width / 2, subtitle, 'subtitlefont', 'text meta-top', this.spacing.subtitle, 0, 'middle');\n};\n\n/**\n * Begin a group of glyphs that will always be moved, scaled and highlighted together\n */\nRenderer.prototype.beginGroup = function () {\n  this.path = [];\n  this.lastM = [0,0];\n  this.ingroup = true;\n};\n\n/**\n * Add a path to the current group\n * @param {Array} path\n * @private\n */\nRenderer.prototype.addPath = function (path) {\n  path = path || [];\n  if (path.length===0) return;\n  path[0][0]=\"m\";\n  path[0][1]-=this.lastM[0];\n  path[0][2]-=this.lastM[1];\n  this.lastM[0]+=path[0][1];\n  this.lastM[1]+=path[0][2];\n  this.path.push(path[0]);\n  for (var i=1,ii=path.length;i<ii;i++) {\n    if (path[i][0]===\"m\") {\n      this.lastM[0]+=path[i][1];\n      this.lastM[1]+=path[i][2];\n    }\n    this.path.push(path[i]);\n  }\n};\n\n/**\n * End a group of glyphs that will always be moved, scaled and highlighted together\n */\nRenderer.prototype.endGroup = function (klass) {\n  this.ingroup = false;\n  if (this.path.length===0) return null;\n  var ret = this.paper.path().attr({path:this.path, stroke:\"none\", fill:\"#000000\", 'class': this.addClasses(klass)});\n\tthis.path = [];\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n\n/**\n * gets scaled\n * @param {number} x1 start x\n * @param {number} x2 end x\n * @param {number} pitch pitch the stave line is drawn at\n */\nRenderer.prototype.printStaveLine = function (x1,x2, pitch, klass) {\n\tvar extraClass = \"staff\";\n\tif (klass !== undefined)\n\t\textraClass += \" \" + klass;\n  var isIE=/*@cc_on!@*/false;//IE detector\n  var dy = 0.35;\n  var fill = \"#000000\";\n  if (isIE) {\n    dy = 1;\n    fill = \"#666666\";\n  }\n  var y = this.calcY(pitch);\n  var pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x2, y-dy,\n     x2, y+dy, x1, y+dy);\n  var ret = this.paper.path().attr({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses(extraClass)}).toBack();\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n\n/**\n * gets scaled if not in a group\n * @param {number} x x coordinate of the stem\n * @param {number} dx stem width\n * @param {number} y1 y coordinate of the stem bottom\n * @param {number} y2 y coordinate of the stem top\n */\nRenderer.prototype.printStem = function (x, dx, y1, y2) {\n  if (dx<0) { // correct path \"handedness\" for intersection with other elements\n    var tmp = y2;\n    y2 = y1;\n    y1 = tmp;\n  }\n  var isIE=/*@cc_on!@*/false;//IE detector\n  var fill = \"#000000\";\n  if (isIE && dx<1) {\n    dx = 1;\n    fill = \"#666666\";\n  }\n  if (~~x === x) x+=0.05; // raphael does weird rounding (for VML)\n  var pathArray = [[\"M\",x,y1],[\"L\", x, y2],[\"L\", x+dx, y2],[\"L\",x+dx,y1],[\"z\"]];\n  if (!isIE && this.ingroup) {\n    this.addPath(pathArray);\n  } else {\n    var ret = this.paper.path().attr({path:pathArray, stroke:\"none\", fill:fill, 'class': this.addClasses('stem')}).toBack();\n    if (this.doRegression) this.addToRegression(ret);\n\n    return ret;\n  }\n};\n\nfunction kernSymbols(lastSymbol, thisSymbol, lastSymbolWidth) {\n\t// This is just some adjustments to make it look better.\n\tvar width = lastSymbolWidth;\n\tif (lastSymbol === 'f' && thisSymbol === 'f')\n\t\twidth = width*2/3;\n\tif (lastSymbol === 'p' && thisSymbol === 'p')\n\t\twidth = width*5/6;\n\tif (lastSymbol === 'f' && thisSymbol === 'z')\n\t\twidth = width*5/8;\n\treturn width;\n}\n\n/**\n * assumes this.y is set appropriately\n * if symbol is a multichar string without a . (as in scripts.staccato) 1 symbol per char is assumed\n * not scaled if not in printgroup\n */\nRenderer.prototype.printSymbol = function(x, offset, symbol, scalex, scaley, klass) {\n\tvar el;\n    var ycorr;\n  if (!symbol) return null;\n  if (symbol.length>0 && symbol.indexOf(\".\")<0) {\n    var elemset = this.paper.set();\n    var dx =0;\n    for (var i=0; i<symbol.length; i++) {\n        var s = symbol.charAt(i);\n        ycorr = glyphs.getYCorr(s);\n\t\t\tel = glyphs.printSymbol(x+dx, this.calcY(offset+ycorr), s, this.paper, klass);\n\t\t\tif (el) {\n\t\t\t\tif (this.doRegression) this.addToRegression(el);\n\t\t\t\telemset.push(el);\n\t\t\t\tif (i < symbol.length-1)\n\t\t\t\t\tdx+= kernSymbols(s, symbol.charAt(i+1), glyphs.getSymbolWidth(s));\n\t\t\t} else {\n\t\t\t\tthis.renderText(x, this.y, \"no symbol:\" +symbol, \"debugfont\", 'debug-msg', 'start');\n      }\n    }\n    return elemset;\n  } else {\n    ycorr = glyphs.getYCorr(symbol);\n    if (this.ingroup) {\n      this.addPath(glyphs.getPathForSymbol(x, this.calcY(offset+ycorr), symbol, scalex, scaley));\n    } else {\n      el = glyphs.printSymbol(x, this.calcY(offset+ycorr), symbol, this.paper, klass);\n      if (el) {\n\tif (this.doRegression) this.addToRegression(el);\n\treturn el;\n      } else\n\t\t\t\tthis.renderText(x, this.y, \"no symbol:\" +symbol, \"debugfont\", 'debug-msg', 'start');\n    }\n    return null;    \n  }\n};\n\n\nRenderer.prototype.printPath = function (attrs) {\n  var ret = this.paper.path().attr(attrs);\n  if (this.doRegression) this.addToRegression(ret);\n  return ret;\n};\n\nRenderer.prototype.drawBrace = function(xLeft, yTop, yBottom) {//Tony\n\tvar yHeight = yBottom - yTop;\n\n\tvar xCurve = [7.5, -8, 21, 0, 18.5, -10.5, 7.5];\n\tvar yCurve = [0, yHeight/5.5, yHeight/3.14, yHeight/2, yHeight/2.93, yHeight/4.88, 0];\n\n\tvar pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\",\n\t\txLeft+xCurve[0], yTop+yCurve[0],\n\t\txLeft+xCurve[1], yTop+yCurve[1],\n\t\txLeft+xCurve[2], yTop+yCurve[2],\n\t\txLeft+xCurve[3], yTop+yCurve[3],\n\t\txLeft+xCurve[4], yTop+yCurve[4],\n\t\txLeft+xCurve[5], yTop+yCurve[5],\n\t\txLeft+xCurve[6], yTop+yCurve[6]);\n\tvar ret1 = this.paper.path().attr({path:pathString, stroke:\"#000000\", fill:\"#000000\", 'class': this.addClasses('brace')});\n\n\txCurve = [0, 17.5, -7.5, 6.6, -5, 20, 0];\n\tyCurve = [yHeight/2, yHeight/1.46, yHeight/1.22, yHeight, yHeight/1.19, yHeight/1.42, yHeight/2];\n\n\tpathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\",\n\t\txLeft+xCurve[ 0], yTop+yCurve[0],\n\t\txLeft+xCurve[1], yTop+yCurve[1],\n\t\txLeft+xCurve[2], yTop+yCurve[2],\n\t\txLeft+xCurve[3], yTop+yCurve[3],\n\t\txLeft+xCurve[4], yTop+yCurve[4],\n\t\txLeft+xCurve[5], yTop+yCurve[5],\n\t\txLeft+xCurve[6], yTop+yCurve[6]);\n\tvar ret2 = this.paper.path().attr({path:pathString, stroke:\"#000000\", fill:\"#000000\", 'class': this.addClasses('brace')});\n\n\tif (this.doRegression){\n\t\tthis.addToRegression(ret1);\n\t\tthis.addToRegression(ret2);\n\t}\n\treturn ret1 + ret2;\n};\n\nRenderer.prototype.drawArc = function(x1, x2, pitch1, pitch2, above, klass, isTie) {\n\t// If it is a tie vs. a slur, draw it shallower.\n\tvar spacing = isTie ? 1.2 : 1.5;\n\n  x1 = x1 + 6;\n  x2 = x2 + 4;\n  pitch1 = pitch1 + ((above)?spacing:-spacing);\n  pitch2 = pitch2 + ((above)?spacing:-spacing);\n  var y1 = this.calcY(pitch1);\n  var y2 = this.calcY(pitch2);\n\n  //unit direction vector\n  var dx = x2-x1;\n  var dy = y2-y1;\n  var norm= Math.sqrt(dx*dx+dy*dy);\n  var ux = dx/norm;\n  var uy = dy/norm;\n\n  var flatten = norm/3.5;\n  var maxFlatten = isTie ? 10 : 25;  // If it is a tie vs. a slur, draw it shallower.\n  var curve = ((above)?-1:1)*Math.min(maxFlatten, Math.max(4, flatten));\n\n  var controlx1 = x1+flatten*ux-curve*uy;\n  var controly1 = y1+flatten*uy+curve*ux;\n  var controlx2 = x2-flatten*ux-curve*uy;\n  var controly2 = y2-flatten*uy+curve*ux;\n  var thickness = 2;\n  var pathString = sprintf(\"M %f %f C %f %f %f %f %f %f C %f %f %f %f %f %f z\", x1, y1,\n     controlx1, controly1, controlx2, controly2, x2, y2,\n     controlx2-thickness*uy, controly2+thickness*ux, controlx1-thickness*uy, controly1+thickness*ux, x1, y1);\n\tif (klass)\n\t\tklass += ' slur';\n\telse\n\t\tklass = 'slur';\n  var ret = this.paper.path().attr({path:pathString, stroke:\"none\", fill:\"#000000\", 'class': this.addClasses(klass)});\n  if (this.doRegression) this.addToRegression(ret);\n\n  return ret;\n};\n/**\n * Calculates the y for a given pitch value (relative to the stave the renderer is currently printing)\n * @param {number} ofs pitch value (bottom C on a G clef = 0, D=1, etc.)\n */\nRenderer.prototype.calcY = function(ofs) {\n  return this.y - ofs*spacing.STEP;\n};\n\n/**\n * Print @param {number} numLines. If there is 1 line it is the B line. Otherwise the bottom line is the E line.\n */\nRenderer.prototype.printStave = function (startx, endx, numLines) {\n\tvar klass = \"top-line\";\n\t// If there is one line, it is the B line. Otherwise, the bottom line is the E line.\n\tif (numLines === 1) {\n\t\tthis.printStaveLine(startx,endx,6, klass);\n\t\treturn;\n\t}\n\tfor (var i = numLines-1; i >= 0; i--) {\n\t\tthis.printStaveLine(startx,endx,(i+1)*2, klass);\n\t\tklass = undefined;\n\t}\n};\n\n/**\n *\n * @private\n */\nRenderer.prototype.addClasses = function (c, isNote) {\n\tif (!this.shouldAddClasses)\n\t\treturn \"\";\n\tvar ret = [];\n\tif (c.length > 0) ret.push(c);\n\tif (this.lineNumber !== null && this.lineNumber !== undefined) ret.push(\"l\"+this.lineNumber);\n\tif (this.measureNumber !== null && this.measureNumber !== undefined) ret.push(\"m\"+this.measureNumber);\n\tif (this.voiceNumber !== null && this.voiceNumber !== undefined) ret.push(\"v\"+this.voiceNumber);\n\tif (c.indexOf('note') >= 0 && this.noteNumber !== null && this.noteNumber !== undefined) ret.push(\"n\"+this.noteNumber);\n\t// add a prefix to all classes that abcjs adds.\n\tif (ret.length > 0) {\n\t\tret = ret.join(' '); // Some strings are compound classes - that is, specify more than one class in a string.\n\t\tret = ret.split(' ');\n\t\tfor (var i = 0; i < ret.length; i++) {\n\t\t\tif (ret[i].indexOf('abcjs-') !== 0 && ret[i].length > 0) // if the prefix doesn't already exist and the class is not blank.\n\t\t\t\tret[i] = 'abcjs-' + ret[i];\n\t\t}\n\t}\n\treturn ret.join(' ');\n};\n\nRenderer.prototype.getFontAndAttr = function(type, klass) {\n\tvar font = this.abctune.formatting[type];\n\t// Raphael deliberately changes the font units to pixels for some reason, so we need to change points to pixels here.\n\tif (font)\n\t\tfont = { face: font.face, size: font.size*4/3, decoration: font.decoration, style: font.style, weight: font.weight, box: font.box };\n\telse\n\t\tfont = { face: \"Arial\", size: 12*4/3, decoration: \"underline\", style: \"normal\", weight: \"normal\" };\n\n\tvar attr = {\"font-size\": font.size, 'font-style': font.style,\n\t\t\"font-family\": font.face, 'font-weight': font.weight, 'text-decoration': font.decoration,\n\t\t'class': this.addClasses(klass) };\n\tattr.font = \"\";\t// There is a spurious font definition that is put on all text elements. This overwrites it.\n\treturn { font: font, attr: attr };\n};\n\nRenderer.prototype.getTextSize = function(text, type, klass) {\n\tvar hash = this.getFontAndAttr(type, klass);\n\tvar el = this.paper.text(0,0, text).attr(hash.attr);\n\tvar size = el.getBBox();\n\tif (isNaN(size.height)) // This can happen if the element isn't visible.\n\t\tsize = { width: 0, height: 0};\n\tel.remove();\n\tif (hash.font.box)\n\t\tsize.height += 8;\n\treturn size;\n};\n\nRenderer.prototype.renderText = function(x, y, text, type, klass, anchor, centerVertically) {\n\tvar hash = this.getFontAndAttr(type, klass);\n\tif (anchor)\n\t\thash.attr[\"text-anchor\"] = anchor;\n\ttext = text.replace(/\\n\\n/g, \"\\n \\n\");\n\ttext = text.replace(/^\\n/, \"\\xA0\\n\");\n\tvar el = this.paper.text(x, y, text).attr(hash.attr);\n\tif (!centerVertically) {\n\t\t// The text will be placed centered in vertical alignment, so we need to move the box down so that\n\t\t// the top of the text is where we've requested.\n\t\tvar size = el.getBBox();\n\t\tif (isNaN(size.height)) // This can happen if the element is hidden.\n\t\t\tel.attr({ \"y\": y });\n\t\telse {\n\t\t\tif (hash.font.box) {\n\t\t\t\tvar padding = 2;\n\t\t\t\tvar margin = 2;\n\t\t\t\tthis.paper.rect(size.x - padding, size.y + size.height / 2 + margin, size.width + padding*2, size.height + padding*2 - margin).attr({\"stroke\": \"#888888\"});\n\t\t\t\tsize.height += 8;\n\t\t\t}\n\t\t\tel.attr({\"y\": y + size.height / 2});\n\t\t}\n\t}\n\tif (type === 'debugfont') {\n\t\tconsole.log(\"Debug msg: \" + text);\n\t\tel.attr({ stroke: \"#ff0000\"});\n\t}\n\tif (this.doRegression) this.addToRegression(el);\n\treturn el;\n};\n\nRenderer.prototype.moveY = function (em, numLines) {\n\tif (numLines === undefined) numLines = 1;\n\tthis.y += em*numLines;\n};\n\nRenderer.prototype.skipSpaceY = function () {\n\tthis.y += this.space;\n};\n\n// Call with 'kind' being the font type to use,\n// if marginBottom === null then don't increment the Y after printing, otherwise that is the extra number of em's to leave below the line.\n// and alignment being \"start\", \"middle\", or \"end\".\nRenderer.prototype.outputTextIf = function(x, str, kind, klass, marginTop, marginBottom, alignment) {\n\tif (str) {\n\t\tif (marginTop)\n\t\t\tthis.moveY(marginTop);\n\t\tvar el = this.renderText(x, this.y, str, kind, klass, alignment);\n\t\tvar bb = el.getBBox(); // This can return NaN if the element isn't visible.\n\t\tvar width = isNaN(bb.width) ? 0 : bb.width;\n\t\tvar height = isNaN(bb.height) ? 0 : bb.height;\n\t\tif (marginBottom !== null) {\n\t\t\tvar numLines = str.split(\"\\n\").length;\n\t\t\tif (!isNaN(bb.height))\n\t\t\t\tthis.moveY(height/numLines, (numLines + marginBottom));\n\t\t}\n\t\treturn [width, height];\n\t}\n\treturn [0,0];\n};\n\nRenderer.prototype.addInvisibleMarker = function (className) {\n\tvar dy = 0.35;\n\tvar fill = \"rgba(0,0,0,0)\";\n\tvar y = this.y;\n\ty = Math.round(y);\n\tvar x1 = 0;\n\tvar x2 = 100;\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x1+x2, y-dy,\n\t\tx2, y+dy, x1, y+dy);\n\tthis.paper.path().attr({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses(className), 'data-vertical': y }).toBack();\n};\n\n// For debugging, it is sometimes useful to know where you are vertically.\nRenderer.prototype.printHorizontalLine = function (width, vertical, comment) {\n\tvar dy = 0.35;\n\tvar fill = \"rgba(0,0,255,.4)\";\n\tvar y = this.y;\n\tif (vertical) y = vertical;\n\ty = Math.round(y);\n\tthis.paper.text(10, y, \"\"+Math.round(y)).attr({\"text-anchor\": \"start\", \"font-size\":\"18px\", fill: fill, stroke: fill });\n\tvar x1 = 50;\n\tvar x2 = width;\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x1, y-dy, x1+x2, y-dy,\n\t\tx2, y+dy, x1, y+dy);\n\tthis.paper.path().attr({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses('staff')}).toBack();\n\tfor (var i = 1; i < width/100; i++) {\n\t\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", i*100-dy, y-5, i*100-dy, y+5,\n\t\t\ti*100+dy, y-5, i*100+dy, y+5);\n\t\tthis.paper.path().attr({path:pathString, stroke:\"none\", fill:fill, 'class': this.addClasses('staff')}).toBack();\n\t}\n\tif (comment)\n\t\tthis.paper.text(width+70, y, comment).attr({\"text-anchor\": \"start\", \"font-size\":\"18px\", fill: fill, stroke: fill });\n};\n\nRenderer.prototype.printShadedBox = function (x, y, width, height, color, comment) {\n\tvar box = this.paper.rect(x, y, width, height).attr({fill: color, stroke: color });\n\tif (comment)\n\t\tthis.paper.text(0, y+7, comment).attr({\"text-anchor\": \"start\", \"font-size\":\"14px\", fill: \"rgba(0,0,255,.4)\", stroke: \"rgba(0,0,255,.4)\" });\n\treturn box;\n};\n\nRenderer.prototype.printVerticalLine = function (x, y1, y2) {\n\tvar dy = 0.35;\n\tvar fill = \"#00aaaa\";\n\tvar pathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - dy, y1, x - dy, y2,\n\t\t\tx + dy, y1, x + dy, y2);\n\tthis.paper.path().attr({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')}).toBack();\n\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x - 20, y1, x - 20, y1+3,\n\t\tx, y1, x, y1+3);\n\tthis.paper.path().attr({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')}).toBack();\n\tpathString = sprintf(\"M %f %f L %f %f L %f %f L %f %f z\", x + 20, y2, x + 20, y2+3,\n\t\tx, y2, x, y2+3);\n\tthis.paper.path().attr({path: pathString, stroke: \"none\", fill: fill, 'class': this.addClasses('staff')}).toBack();\n\n};\n\n/**\n * @private\n */\nRenderer.prototype.addToRegression = function (el) {\n\tvar box = el.getBBox();\n\t//var str = \"(\"+box.x+\",\"+box.y+\")[\"+box.width+\",\"+box.height+\"] \"\n\tvar str = el.type + ' ' + box.toString() + ' ';\n\tvar attrs = [];\n\tfor (var key in el.attrs) {\n\t\tif (el.attrs.hasOwnProperty(key)) {\n\t\t\tif (key === 'class')\n\t\t\t\tstr = el.attrs[key] + \" \" + str;\n\t\t\telse\n\t\t\t\tattrs.push(key+\": \"+el.attrs[key]);\n\t\t}\n\t}\n\tattrs.sort();\n\tstr += \"{ \" +attrs.join(\" \") + \" }\";\n\tthis.regressionLines.push(str);\n};\n\nmodule.exports = Renderer;\n"]},"metadata":{},"sourceType":"script"}