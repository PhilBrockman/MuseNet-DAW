{"ast":null,"code":"// abc_abstract_engraver.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global window */\nvar AbsoluteElement = require('./abc_absolute_element');\n\nvar BeamElem = require('./abc_beam_element');\n\nvar BraceElem = require('./abc_brace_element');\n\nvar createClef = require('./abc_create_clef');\n\nvar createKeySignature = require('./abc_create_key_signature');\n\nvar createTimeSignature = require('./abc_create_time_signature');\n\nvar Decoration = require('./abc_decoration');\n\nvar EndingElem = require('./abc_ending_element');\n\nvar glyphs = require('./abc_glyphs');\n\nvar RelativeElement = require('./abc_relative_element');\n\nvar spacing = require('./abc_spacing');\n\nvar StaffGroupElement = require('./abc_staff_group_element');\n\nvar TempoElement = require('./abc_tempo_element');\n\nvar TieElem = require('./abc_tie_element');\n\nvar TripletElem = require('./abc_triplet_element');\n\nvar VoiceElement = require('./abc_voice_element');\n\nvar parseCommon = require('../parse/abc_common');\n\nvar AbstractEngraver;\n\n(function () {\n  \"use strict\";\n\n  var getDuration = function (elem) {\n    var d = 0;\n\n    if (elem.duration) {\n      d = elem.duration;\n    }\n\n    return d;\n  };\n\n  var hint = false;\n\n  AbstractEngraver = function (bagpipes, renderer, tuneNumber) {\n    this.decoration = new Decoration();\n    this.renderer = renderer;\n    this.tuneNumber = tuneNumber;\n    this.isBagpipes = bagpipes;\n    this.chartable = {\n      rest: {\n        0: \"rests.whole\",\n        1: \"rests.half\",\n        2: \"rests.quarter\",\n        3: \"rests.8th\",\n        4: \"rests.16th\",\n        5: \"rests.32nd\",\n        6: \"rests.64th\",\n        7: \"rests.128th\",\n        \"multi\": \"rests.multimeasure\"\n      },\n      note: {\n        \"-1\": \"noteheads.dbl\",\n        0: \"noteheads.whole\",\n        1: \"noteheads.half\",\n        2: \"noteheads.quarter\",\n        3: \"noteheads.quarter\",\n        4: \"noteheads.quarter\",\n        5: \"noteheads.quarter\",\n        6: \"noteheads.quarter\",\n        7: \"noteheads.quarter\",\n        'nostem': \"noteheads.quarter\"\n      },\n      rhythm: {\n        \"-1\": \"noteheads.slash.whole\",\n        0: \"noteheads.slash.whole\",\n        1: \"noteheads.slash.whole\",\n        2: \"noteheads.slash.quarter\",\n        3: \"noteheads.slash.quarter\",\n        4: \"noteheads.slash.quarter\",\n        5: \"noteheads.slash.quarter\",\n        6: \"noteheads.slash.quarter\",\n        7: \"noteheads.slash.quarter\",\n        nostem: \"noteheads.slash.nostem\"\n      },\n      x: {\n        \"-1\": \"noteheads.indeterminate\",\n        0: \"noteheads.indeterminate\",\n        1: \"noteheads.indeterminate\",\n        2: \"noteheads.indeterminate\",\n        3: \"noteheads.indeterminate\",\n        4: \"noteheads.indeterminate\",\n        5: \"noteheads.indeterminate\",\n        6: \"noteheads.indeterminate\",\n        7: \"noteheads.indeterminate\",\n        nostem: \"noteheads.indeterminate\"\n      },\n      harmonic: {\n        \"-1\": \"noteheads.harmonic.quarter\",\n        0: \"noteheads.harmonic.quarter\",\n        1: \"noteheads.harmonic.quarter\",\n        2: \"noteheads.harmonic.quarter\",\n        3: \"noteheads.harmonic.quarter\",\n        4: \"noteheads.harmonic.quarter\",\n        5: \"noteheads.harmonic.quarter\",\n        6: \"noteheads.harmonic.quarter\",\n        7: \"noteheads.harmonic.quarter\",\n        nostem: \"noteheads.harmonic.quarter\"\n      },\n      uflags: {\n        3: \"flags.u8th\",\n        4: \"flags.u16th\",\n        5: \"flags.u32nd\",\n        6: \"flags.u64th\"\n      },\n      dflags: {\n        3: \"flags.d8th\",\n        4: \"flags.d16th\",\n        5: \"flags.d32nd\",\n        6: \"flags.d64th\"\n      }\n    };\n    this.reset();\n  };\n\n  AbstractEngraver.prototype.reset = function () {\n    this.slurs = {};\n    this.ties = [];\n    this.slursbyvoice = {};\n    this.tiesbyvoice = {};\n    this.endingsbyvoice = {};\n    this.s = 0; // current staff number\n\n    this.v = 0; // current voice number on current staff\n\n    this.tripletmultiplier = 1;\n    this.abcline = undefined;\n    this.accidentalSlot = undefined;\n    this.accidentalshiftx = undefined;\n    this.dotshiftx = undefined;\n    this.hasVocals = false;\n    this.minY = undefined;\n    this.partstartelem = undefined;\n    this.pos = undefined;\n    this.roomtaken = undefined;\n    this.roomtakenright = undefined;\n    this.staffgroup = undefined;\n    this.startlimitelem = undefined;\n    this.stemdir = undefined;\n    this.voice = undefined;\n  };\n\n  AbstractEngraver.prototype.setStemHeight = function (heightInPixels) {\n    this.stemHeight = heightInPixels / spacing.STEP;\n  };\n\n  AbstractEngraver.prototype.getCurrentVoiceId = function () {\n    return \"s\" + this.s + \"v\" + this.v;\n  };\n\n  AbstractEngraver.prototype.pushCrossLineElems = function () {\n    this.slursbyvoice[this.getCurrentVoiceId()] = this.slurs;\n    this.tiesbyvoice[this.getCurrentVoiceId()] = this.ties;\n    this.endingsbyvoice[this.getCurrentVoiceId()] = this.partstartelem;\n  };\n\n  AbstractEngraver.prototype.popCrossLineElems = function () {\n    this.slurs = this.slursbyvoice[this.getCurrentVoiceId()] || {};\n    this.ties = this.tiesbyvoice[this.getCurrentVoiceId()] || [];\n    this.partstartelem = this.endingsbyvoice[this.getCurrentVoiceId()];\n  };\n\n  AbstractEngraver.prototype.getElem = function () {\n    if (this.abcline.length <= this.pos) return null;\n    return this.abcline[this.pos];\n  };\n\n  AbstractEngraver.prototype.getNextElem = function () {\n    if (this.abcline.length <= this.pos + 1) return null;\n    return this.abcline[this.pos + 1];\n  };\n\n  AbstractEngraver.prototype.containsLyrics = function (staves) {\n    for (var i = 0; i < staves.length; i++) {\n      for (var j = 0; j < staves[i].voices.length; j++) {\n        for (var k = 0; k < staves[i].voices[j].length; k++) {\n          var el = staves[i].voices[j][k];\n\n          if (el.lyric) {\n            // We just want to see if there are vocals below the music to know where to put the dynamics.\n            if (!el.positioning || el.positioning.vocalPosition === 'below') this.hasVocals = true;\n            return;\n          }\n        }\n      }\n    }\n  };\n\n  AbstractEngraver.prototype.createABCLine = function (staffs, tempo) {\n    this.minY = 2; // PER: This is the lowest that any note reaches. It will be used to set the dynamics row.\n    // See if there are any lyrics on this line.\n\n    this.containsLyrics(staffs);\n    this.staffgroup = new StaffGroupElement();\n    this.tempoSet = false;\n\n    for (this.s = 0; this.s < staffs.length; this.s++) {\n      if (hint) this.restoreState();\n      hint = false;\n      this.createABCStaff(staffs[this.s], tempo);\n    }\n\n    return this.staffgroup;\n  };\n\n  AbstractEngraver.prototype.createABCStaff = function (abcstaff, tempo) {\n    // If the tempo is passed in, then the first element should get the tempo attached to it.\n    for (this.v = 0; this.v < abcstaff.voices.length; this.v++) {\n      this.voice = new VoiceElement(this.v, abcstaff.voices.length);\n\n      if (this.v === 0) {\n        this.voice.barfrom = abcstaff.connectBarLines === \"start\" || abcstaff.connectBarLines === \"continue\";\n        this.voice.barto = abcstaff.connectBarLines === \"continue\" || abcstaff.connectBarLines === \"end\";\n      } else {\n        this.voice.duplicate = true; // bar lines and other duplicate info need not be created\n      }\n\n      if (abcstaff.title && abcstaff.title[this.v]) this.voice.header = abcstaff.title[this.v];\n      var clef = createClef(abcstaff.clef, this.tuneNumber);\n\n      if (clef) {\n        if (this.v === 0 && abcstaff.barNumber) {\n          this.addMeasureNumber(abcstaff.barNumber, clef);\n        }\n\n        this.voice.addChild(clef);\n      }\n\n      var keySig = createKeySignature(abcstaff.key, this.tuneNumber);\n\n      if (keySig) {\n        this.voice.addChild(keySig);\n        this.startlimitelem = keySig; // limit ties here\n      }\n\n      if (abcstaff.meter) {\n        var ts = createTimeSignature(abcstaff.meter, this.tuneNumber);\n        this.voice.addChild(ts);\n        this.startlimitelem = ts; // limit ties here\n      }\n\n      if (this.voice.duplicate) this.voice.children = []; // we shouldn't reprint the above if we're reusing the same staff. We just created them to get the right spacing.\n\n      var staffLines = abcstaff.clef.stafflines || abcstaff.clef.stafflines === 0 ? abcstaff.clef.stafflines : 5;\n      this.staffgroup.addVoice(this.voice, this.s, staffLines);\n      this.createABCVoice(abcstaff.voices[this.v], tempo);\n      this.staffgroup.setStaffLimits(this.voice); //Tony: Here I am following what staves need to be surrounded by the brace, by incrementing the length of the brace class.\n      //So basically this keeps incrementing the number of staff surrounded by the brace until it sees \"end\".\n      //This then gets processed in abc_staff_group_element.js, so that it will have the correct top and bottom coordinates for the brace.\n\n      if (abcstaff.brace === \"start\") {\n        this.staffgroup.brace = new BraceElem(1, true);\n      } else if (abcstaff.brace === \"end\" && this.staffgroup.brace) {\n        this.staffgroup.brace.increaseStavesIncluded();\n      } else if (abcstaff.brace === \"continue\" && this.staffgroup.brace) {\n        this.staffgroup.brace.increaseStavesIncluded();\n      }\n    }\n  };\n\n  AbstractEngraver.prototype.createABCVoice = function (abcline, tempo) {\n    this.popCrossLineElems();\n    this.stemdir = this.isBagpipes ? \"down\" : null;\n    this.abcline = abcline;\n\n    if (this.partstartelem) {\n      this.partstartelem = new EndingElem(\"\", null, null);\n      this.voice.addOther(this.partstartelem);\n    }\n\n    for (var slur in this.slurs) {\n      if (this.slurs.hasOwnProperty(slur)) {\n        this.slurs[slur] = new TieElem(null, null, this.slurs[slur].above, this.slurs[slur].force, false);\n        if (hint) this.slurs[slur].setHint();\n        this.voice.addOther(this.slurs[slur]);\n      }\n    }\n\n    for (var i = 0; i < this.ties.length; i++) {\n      this.ties[i] = new TieElem(null, null, this.ties[i].above, this.ties[i].force, true);\n      if (hint) this.ties[i].setHint();\n      this.voice.addOther(this.ties[i]);\n    }\n\n    for (this.pos = 0; this.pos < this.abcline.length; this.pos++) {\n      var abselems = this.createABCElement();\n\n      if (abselems) {\n        for (i = 0; i < abselems.length; i++) {\n          if (!this.tempoSet && tempo && !tempo.suppress) {\n            this.tempoSet = true;\n            abselems[i].addChild(new TempoElement(tempo, this.tuneNumber));\n          }\n\n          this.voice.addChild(abselems[i]);\n        }\n      }\n    }\n\n    this.pushCrossLineElems();\n  };\n\n  AbstractEngraver.prototype.saveState = function () {\n    this.tiesSave = parseCommon.cloneArray(this.ties);\n    this.slursSave = parseCommon.cloneHashOfHash(this.slurs);\n    this.slursbyvoiceSave = parseCommon.cloneHashOfHash(this.slursbyvoice);\n    this.tiesbyvoiceSave = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoice);\n  };\n\n  AbstractEngraver.prototype.restoreState = function () {\n    this.ties = parseCommon.cloneArray(this.tiesSave);\n    this.slurs = parseCommon.cloneHashOfHash(this.slursSave);\n    this.slursbyvoice = parseCommon.cloneHashOfHash(this.slursbyvoiceSave);\n    this.tiesbyvoice = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoiceSave);\n  }; // return an array of AbsoluteElement\n\n\n  AbstractEngraver.prototype.createABCElement = function () {\n    var elemset = [];\n    var elem = this.getElem();\n\n    switch (elem.el_type) {\n      case \"note\":\n        elemset = this.createBeam();\n        break;\n\n      case \"bar\":\n        elemset[0] = this.createBarLine(elem);\n        if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"meter\":\n        elemset[0] = createTimeSignature(elem, this.tuneNumber);\n        this.startlimitelem = elemset[0]; // limit ties here\n\n        if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"clef\":\n        elemset[0] = createClef(elem, this.tuneNumber);\n        if (!elemset[0]) return null;\n        if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"key\":\n        var absKey = createKeySignature(elem, this.tuneNumber);\n\n        if (absKey) {\n          elemset[0] = absKey;\n          this.startlimitelem = elemset[0]; // limit ties here\n        }\n\n        if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n        break;\n\n      case \"stem\":\n        this.stemdir = elem.direction;\n        break;\n\n      case \"part\":\n        var abselem = new AbsoluteElement(elem, 0, 0, 'part', this.tuneNumber);\n        var dim = this.renderer.getTextSize(elem.title, 'partsfont', \"part\");\n        abselem.addChild(new RelativeElement(elem.title, 0, 0, undefined, {\n          type: \"part\",\n          height: dim.height / spacing.STEP\n        }));\n        elemset[0] = abselem;\n        break;\n\n      case \"tempo\":\n        var abselem3 = new AbsoluteElement(elem, 0, 0, 'tempo', this.tuneNumber);\n        abselem3.addChild(new TempoElement(elem, this.tuneNumber));\n        elemset[0] = abselem3;\n        break;\n\n      case \"style\":\n        if (elem.head === \"normal\") delete this.style;else this.style = elem.head;\n        break;\n\n      case \"hint\":\n        hint = true;\n        this.saveState();\n        break;\n\n      case \"midi\":\n        // This has no effect on the visible music, so just skip it.\n        break;\n\n      default:\n        var abselem2 = new AbsoluteElement(elem, 0, 0, 'unsupported', this.tuneNumber);\n        abselem2.addChild(new RelativeElement(\"element type \" + elem.el_type, 0, 0, undefined, {\n          type: \"debug\"\n        }));\n        elemset[0] = abselem2;\n    }\n\n    return elemset;\n  };\n\n  AbstractEngraver.prototype.calcBeamDir = function () {\n    if (this.stemdir) // If the user or voice is forcing the stem direction, we already know the answer.\n      return this.stemdir;\n    var beamelem = new BeamElem(this.stemHeight, this.stemdir); // PER: need two passes: the first one decides if the stems are up or down.\n\n    var oldPos = this.pos;\n    var abselem;\n\n    while (this.getElem()) {\n      abselem = this.createNote(this.getElem(), true, true);\n      beamelem.add(abselem);\n      if (this.getElem().endBeam) break;\n      this.pos++;\n    }\n\n    var dir = beamelem.calcDir();\n    this.pos = oldPos;\n    return dir ? \"up\" : \"down\";\n  };\n\n  AbstractEngraver.prototype.createBeam = function () {\n    var abselemset = [];\n\n    if (this.getElem().startBeam && !this.getElem().endBeam) {\n      var dir = this.calcBeamDir();\n      var beamelem = new BeamElem(this.stemHeight, dir);\n      if (hint) beamelem.setHint();\n      var oldDir = this.stemdir;\n      this.stemdir = dir;\n\n      while (this.getElem()) {\n        var abselem = this.createNote(this.getElem(), true);\n        abselemset.push(abselem);\n        beamelem.add(abselem);\n\n        if (this.triplet && this.triplet.isClosed()) {\n          this.voice.addOther(this.triplet);\n          this.triplet = null;\n          this.tripletmultiplier = 1;\n        }\n\n        if (this.getElem().endBeam) {\n          break;\n        }\n\n        this.pos++;\n      }\n\n      this.stemdir = oldDir;\n      this.voice.addBeam(beamelem);\n    } else {\n      abselemset[0] = this.createNote(this.getElem());\n\n      if (this.triplet && this.triplet.isClosed()) {\n        this.voice.addOther(this.triplet);\n        this.triplet = null;\n        this.tripletmultiplier = 1;\n      }\n    }\n\n    return abselemset;\n  };\n\n  var sortPitch = function (elem) {\n    var sorted;\n\n    do {\n      sorted = true;\n\n      for (var p = 0; p < elem.pitches.length - 1; p++) {\n        if (elem.pitches[p].pitch > elem.pitches[p + 1].pitch) {\n          sorted = false;\n          var tmp = elem.pitches[p];\n          elem.pitches[p] = elem.pitches[p + 1];\n          elem.pitches[p + 1] = tmp;\n        }\n      }\n    } while (!sorted);\n  };\n\n  var ledgerLines = function (abselem, minPitch, maxPitch, isRest, c, additionalLedgers, dir, dx, scale) {\n    for (var i = maxPitch; i > 11; i--) {\n      if (i % 2 === 0 && !isRest) {\n        abselem.addChild(new RelativeElement(null, dx, (glyphs.getSymbolWidth(c) + 4) * scale, i, {\n          type: \"ledger\"\n        }));\n      }\n    }\n\n    for (i = minPitch; i < 1; i++) {\n      if (i % 2 === 0 && !isRest) {\n        abselem.addChild(new RelativeElement(null, dx, (glyphs.getSymbolWidth(c) + 4) * scale, i, {\n          type: \"ledger\"\n        }));\n      }\n    }\n\n    for (i = 0; i < additionalLedgers.length; i++) {\n      // PER: draw additional ledgers\n      var ofs = glyphs.getSymbolWidth(c);\n      if (dir === 'down') ofs = -ofs;\n      abselem.addChild(new RelativeElement(null, ofs + dx, (glyphs.getSymbolWidth(c) + 4) * scale, additionalLedgers[i], {\n        type: \"ledger\"\n      }));\n    }\n  };\n\n  AbstractEngraver.prototype.createNote = function (elem, nostem, dontDraw) {\n    //stem presence: true for drawing stemless notehead\n    var notehead = null;\n    var grace = null;\n    this.roomtaken = 0; // room needed to the left of the note\n\n    this.roomtakenright = 0; // room needed to the right of the note\n\n    var dotshiftx = 0; // room taken by chords with displaced noteheads which cause dots to shift\n\n    var c = \"\";\n    var flag = null;\n    var additionalLedgers = []; // PER: handle the case of [bc'], where the b doesn't have a ledger line\n\n    var p, i, pp;\n    var width, p1, p2, dx;\n    var duration = getDuration(elem);\n    var zeroDuration = false;\n\n    if (duration === 0) {\n      zeroDuration = true;\n      duration = 0.25;\n      nostem = true;\n    } //PER: zero duration will draw a quarter note head.\n\n\n    var durlog = Math.floor(Math.log(duration) / Math.log(2)); //TODO use getDurlog\n\n    var dot = 0;\n\n    for (var tot = Math.pow(2, durlog), inc = tot / 2; tot < duration; dot++, tot += inc, inc /= 2);\n\n    if (elem.startTriplet) {\n      this.tripletmultiplier = elem.tripletMultiplier;\n    }\n\n    var durationForSpacing = duration * this.tripletmultiplier;\n    if (elem.rest && elem.rest.type === 'multimeasure') durationForSpacing = 1;\n    var absType = elem.rest ? \"rest\" : \"note\";\n    var abselem = new AbsoluteElement(elem, durationForSpacing, 1, absType, this.tuneNumber, {\n      durationClassOveride: elem.duration * this.tripletmultiplier\n    });\n    if (hint) abselem.setHint();\n\n    if (elem.rest) {\n      var restpitch = 7;\n\n      if (this.voice.voicetotal > 1) {\n        if (this.stemdir === \"down\") restpitch = 3;\n        if (this.stemdir === \"up\") restpitch = 11;\n      } // There is special placement for the percussion staff. If there is one staff line, then move the rest position.\n\n\n      var numLines = this.staffgroup.staffs[this.staffgroup.staffs.length - 1].lines;\n\n      if (numLines === 1) {\n        // The half and whole rests are attached to different lines normally, so we need to tweak their position to get them to both be attached to the same one.\n        if (duration < 0.5) restpitch = 7;else if (duration < 1) restpitch = 6.8; // half rest\n        else restpitch = 4.8; // whole rest\n      }\n\n      switch (elem.rest.type) {\n        case \"whole\":\n          c = this.chartable.rest[0];\n          elem.averagepitch = restpitch;\n          elem.minpitch = restpitch;\n          elem.maxpitch = restpitch;\n          dot = 0;\n          break;\n\n        case \"rest\":\n          if (elem.style === \"rhythm\") // special case for rhythm: rests are a handy way to express the rhythm.\n            c = this.chartable.rhythm[-durlog];else c = this.chartable.rest[-durlog];\n          elem.averagepitch = restpitch;\n          elem.minpitch = restpitch;\n          elem.maxpitch = restpitch;\n          break;\n\n        case \"invisible\":\n        case \"spacer\":\n          c = \"\";\n          elem.averagepitch = restpitch;\n          elem.minpitch = restpitch;\n          elem.maxpitch = restpitch;\n          break;\n\n        case \"multimeasure\":\n          c = this.chartable.rest['multi'];\n          elem.averagepitch = restpitch;\n          elem.minpitch = restpitch;\n          elem.maxpitch = restpitch;\n          dot = 0;\n          var mmWidth = glyphs.getSymbolWidth(c);\n          abselem.addHead(new RelativeElement(c, -mmWidth, mmWidth * 2, 7));\n          var numMeasures = new RelativeElement(\"\" + elem.duration, 0, mmWidth, 16, {\n            type: \"multimeasure-text\"\n          });\n          abselem.addExtra(numMeasures);\n      }\n\n      if (!dontDraw && elem.rest.type !== \"multimeasure\") notehead = this.createNoteHead(abselem, c, {\n        verticalPos: restpitch\n      }, null, 0, -this.roomtaken, null, dot, 0, 1);\n      if (notehead) abselem.addHead(notehead);\n      this.roomtaken += this.accidentalshiftx;\n      this.roomtakenright = Math.max(this.roomtakenright, this.dotshiftx);\n    } else {\n      sortPitch(elem); // determine averagepitch, minpitch, maxpitch and stem direction\n\n      var sum = 0;\n\n      for (p = 0, pp = elem.pitches.length; p < pp; p++) {\n        sum += elem.pitches[p].verticalPos;\n      }\n\n      elem.averagepitch = sum / elem.pitches.length;\n      elem.minpitch = elem.pitches[0].verticalPos;\n      this.minY = Math.min(elem.minpitch, this.minY);\n      elem.maxpitch = elem.pitches[elem.pitches.length - 1].verticalPos;\n      var dir = elem.averagepitch >= 6 ? \"down\" : \"up\";\n      if (this.stemdir) dir = this.stemdir;\n      var style = elem.style ? elem.style : this.style; // get the style of note head.\n\n      if (!style || style === \"normal\") style = \"note\";\n      var noteSymbol;\n      if (zeroDuration) noteSymbol = this.chartable[style].nostem;else noteSymbol = this.chartable[style][-durlog];\n      if (!noteSymbol) console.log(\"noteSymbol:\", style, durlog, zeroDuration); // determine elements of chords which should be shifted\n\n      for (p = dir === \"down\" ? elem.pitches.length - 2 : 1; dir === \"down\" ? p >= 0 : p < elem.pitches.length; p = dir === \"down\" ? p - 1 : p + 1) {\n        var prev = elem.pitches[dir === \"down\" ? p + 1 : p - 1];\n        var curr = elem.pitches[p];\n        var delta = dir === \"down\" ? prev.pitch - curr.pitch : curr.pitch - prev.pitch;\n\n        if (delta <= 1 && !prev.printer_shift) {\n          curr.printer_shift = delta ? \"different\" : \"same\";\n\n          if (curr.verticalPos > 11 || curr.verticalPos < 1) {\n            // PER: add extra ledger line\n            additionalLedgers.push(curr.verticalPos - curr.verticalPos % 2);\n          }\n\n          if (dir === \"down\") {\n            this.roomtaken = glyphs.getSymbolWidth(noteSymbol) + 2;\n          } else {\n            dotshiftx = glyphs.getSymbolWidth(noteSymbol) + 2;\n          }\n        }\n      } // The accidentalSlot will hold a list of all the accidentals on this chord. Each element is a vertical place,\n      // and contains a pitch, which is the last pitch that contains an accidental in that slot. The slots are numbered\n      // from closest to the note to farther left. We only need to know the last accidental we placed because\n      // we know that the pitches are sorted by now.\n\n\n      this.accidentalSlot = [];\n\n      for (p = 0; p < elem.pitches.length; p++) {\n        if (!nostem) {\n          if (dir === \"down\" && p !== 0 || dir === \"up\" && p !== pp - 1) {\n            // not the stemmed elem of the chord\n            flag = null;\n          } else {\n            flag = this.chartable[dir === \"down\" ? \"dflags\" : \"uflags\"][-durlog];\n          }\n        }\n\n        if (elem.pitches[p].style) {\n          // There is a style for the whole group of pitches, but there could also be an override for a particular pitch.\n          c = this.chartable[elem.pitches[p].style][-durlog];\n        } else c = noteSymbol; // The highest position for the sake of placing slurs is itself if the slur is internal. It is the highest position possible if the slur is for the whole chord.\n        // If the note is the only one in the chord, then any slur it has counts as if it were on the whole chord.\n\n\n        elem.pitches[p].highestVert = elem.pitches[p].verticalPos;\n        var isTopWhenStemIsDown = (this.stemdir === \"up\" || dir === \"up\") && p === 0;\n        var isBottomWhenStemIsUp = (this.stemdir === \"down\" || dir === \"down\") && p === pp - 1;\n\n        if (!dontDraw && (isTopWhenStemIsDown || isBottomWhenStemIsUp)) {\n          // place to put slurs if not already on pitches\n          if (elem.startSlur || pp === 1) {\n            elem.pitches[p].highestVert = elem.pitches[pp - 1].verticalPos;\n            if (this.stemdir === \"up\" || dir === \"up\") elem.pitches[p].highestVert += 6; // If the stem is up, then compensate for the length of the stem\n          }\n\n          if (elem.startSlur) {\n            if (!elem.pitches[p].startSlur) elem.pitches[p].startSlur = []; //TODO possibly redundant, provided array is not optional\n\n            for (i = 0; i < elem.startSlur.length; i++) {\n              elem.pitches[p].startSlur.push(elem.startSlur[i]);\n            }\n          }\n\n          if (!dontDraw && elem.endSlur) {\n            elem.pitches[p].highestVert = elem.pitches[pp - 1].verticalPos;\n            if (this.stemdir === \"up\" || dir === \"up\") elem.pitches[p].highestVert += 6; // If the stem is up, then compensate for the length of the stem\n\n            if (!elem.pitches[p].endSlur) elem.pitches[p].endSlur = []; //TODO possibly redundant, provided array is not optional\n\n            for (i = 0; i < elem.endSlur.length; i++) {\n              elem.pitches[p].endSlur.push(elem.endSlur[i]);\n            }\n          }\n        }\n\n        var hasStem = !nostem && durlog <= -1;\n        if (!dontDraw) notehead = this.createNoteHead(abselem, c, elem.pitches[p], hasStem ? dir : null, 0, -this.roomtaken, flag, dot, dotshiftx, 1);\n\n        if (notehead) {\n          if (elem.gracenotes && elem.gracenotes.length > 0) notehead.bottom = notehead.bottom - 1; // If there is a tie to the grace notes, leave a little more room for the note to avoid collisions.\n\n          abselem.addHead(notehead);\n        }\n\n        this.roomtaken += this.accidentalshiftx;\n        this.roomtakenright = Math.max(this.roomtakenright, this.dotshiftx);\n      } // draw stem from the furthest note to a pitch above/below the stemmed note\n\n\n      if (hasStem) {\n        p1 = dir === \"down\" ? elem.minpitch - 7 : elem.minpitch + 1 / 3; // PER added stemdir test to make the line meet the note.\n\n        if (p1 > 6 && !this.stemdir) p1 = 6;\n        p2 = dir === \"down\" ? elem.maxpitch - 1 / 3 : elem.maxpitch + 7; // PER added stemdir test to make the line meet the note.\n\n        if (p2 < 6 && !this.stemdir) p2 = 6;\n        dx = dir === \"down\" || abselem.heads.length === 0 ? 0 : abselem.heads[0].w;\n        width = dir === \"down\" ? 1 : -1; // TODO-PER-HACK: One type of note head has a different placement of the stem. This should be more generically calculated:\n\n        if (notehead.c === 'noteheads.slash.quarter') {\n          if (dir === 'down') p2 -= 1;else p1 += 1;\n        }\n\n        abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\n          \"type\": \"stem\",\n          \"pitch2\": p2,\n          linewidth: width\n        }));\n        this.minY = Math.min(p1, this.minY);\n        this.minY = Math.min(p2, this.minY);\n      }\n    }\n\n    if (elem.lyric !== undefined) {\n      var lyricStr = \"\";\n      parseCommon.each(elem.lyric, function (ly) {\n        var div = ly.divider === ' ' ? \"\" : ly.divider;\n        lyricStr += ly.syllable + div + \"\\n\";\n      });\n      var lyricDim = this.renderer.getTextSize(lyricStr, 'vocalfont', \"lyric\");\n      var position = elem.positioning ? elem.positioning.vocalPosition : 'below';\n      abselem.addCentered(new RelativeElement(lyricStr, 0, lyricDim.width, undefined, {\n        type: \"lyric\",\n        position: position,\n        height: lyricDim.height / spacing.STEP\n      }));\n    }\n\n    if (!dontDraw && elem.gracenotes !== undefined) {\n      var gracescale = 3 / 5;\n      var graceScaleStem = 3.5 / 5; // TODO-PER: empirically found constant.\n\n      var gracebeam = null;\n\n      if (elem.gracenotes.length > 1) {\n        gracebeam = new BeamElem(this.stemHeight * graceScaleStem, \"grace\", this.isBagpipes);\n        if (hint) gracebeam.setHint();\n        gracebeam.mainNote = abselem; // this gives us a reference back to the note this is attached to so that the stems can be attached somewhere.\n      }\n\n      var graceoffsets = [];\n\n      for (i = elem.gracenotes.length - 1; i >= 0; i--) {\n        // figure out where to place each gracenote\n        this.roomtaken += 10;\n        graceoffsets[i] = this.roomtaken;\n\n        if (elem.gracenotes[i].accidental) {\n          this.roomtaken += 7;\n        }\n      }\n\n      for (i = 0; i < elem.gracenotes.length; i++) {\n        var gracepitch = elem.gracenotes[i].verticalPos;\n        flag = gracebeam ? null : this.chartable.uflags[this.isBagpipes ? 5 : 3];\n        grace = this.createNoteHead(abselem, \"noteheads.quarter\", elem.gracenotes[i], \"up\", -graceoffsets[i], -graceoffsets[i], flag, 0, 0, gracescale);\n        abselem.addExtra(grace); // PER: added acciaccatura slash\n\n        if (elem.gracenotes[i].acciaccatura) {\n          var pos = elem.gracenotes[i].verticalPos + 7 * gracescale; // the same formula that determines the flag position.\n\n          var dAcciaccatura = gracebeam ? 5 : 6; // just an offset to make it line up correctly.\n\n          abselem.addRight(new RelativeElement(\"flags.ugrace\", -graceoffsets[i] + dAcciaccatura, 0, pos, {\n            scalex: gracescale,\n            scaley: gracescale\n          }));\n        }\n\n        if (gracebeam) {\n          // give the beam the necessary info\n          var graceDuration = elem.gracenotes[i].duration / 2;\n          if (this.isBagpipes) graceDuration /= 2;\n          var pseudoabselem = {\n            heads: [grace],\n            abcelem: {\n              averagepitch: gracepitch,\n              minpitch: gracepitch,\n              maxpitch: gracepitch,\n              duration: graceDuration\n            }\n          };\n          gracebeam.add(pseudoabselem);\n        } else {\n          // draw the stem\n          p1 = gracepitch + 1 / 3 * gracescale;\n          p2 = gracepitch + 7 * gracescale;\n          dx = grace.dx + grace.w;\n          width = -0.6;\n          abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\n            \"type\": \"stem\",\n            \"pitch2\": p2,\n            linewidth: width\n          }));\n        }\n\n        ledgerLines(abselem, gracepitch, gracepitch, false, \"noteheads.quarter\", [], true, grace.dx - 1, 0.6);\n\n        if (i === 0 && !this.isBagpipes && !(elem.rest && (elem.rest.type === \"spacer\" || elem.rest.type === \"invisible\"))) {\n          var isTie = elem.gracenotes.length === 1 && grace.pitch === notehead.pitch;\n          this.voice.addOther(new TieElem(grace, notehead, false, true, isTie));\n        }\n      }\n\n      if (gracebeam) {\n        this.voice.addBeam(gracebeam);\n      }\n    }\n\n    if (!dontDraw && elem.decoration) {\n      this.decoration.createDecoration(this.voice, elem.decoration, abselem.top, notehead ? notehead.w : 0, abselem, this.roomtaken, dir, abselem.bottom, elem.positioning, this.hasVocals);\n    }\n\n    if (elem.barNumber) {\n      abselem.addChild(new RelativeElement(elem.barNumber, -10, 0, 0, {\n        type: \"barNumber\"\n      }));\n    } // ledger lines\n\n\n    ledgerLines(abselem, elem.minpitch, elem.maxpitch, elem.rest, c, additionalLedgers, dir, -2, 1);\n    var chordMargin = 8; // If there are chords next to each other, this is how close they can get.\n\n    if (elem.chord !== undefined) {\n      for (i = 0; i < elem.chord.length; i++) {\n        var x = 0;\n        var y;\n        var dim = this.renderer.getTextSize(elem.chord[i].name, 'annotationfont', \"annotation\");\n        var chordWidth = dim.width;\n        var chordHeight = dim.height / spacing.STEP;\n\n        switch (elem.chord[i].position) {\n          case \"left\":\n            this.roomtaken += chordWidth + 7;\n            x = -this.roomtaken; // TODO-PER: This is just a guess from trial and error\n\n            y = elem.averagepitch;\n            abselem.addExtra(new RelativeElement(elem.chord[i].name, x, chordWidth + 4, y, {\n              type: \"text\",\n              height: chordHeight\n            }));\n            break;\n\n          case \"right\":\n            this.roomtakenright += 4;\n            x = this.roomtakenright; // TODO-PER: This is just a guess from trial and error\n\n            y = elem.averagepitch;\n            abselem.addRight(new RelativeElement(elem.chord[i].name, x, chordWidth + 4, y, {\n              type: \"text\",\n              height: chordHeight\n            }));\n            break;\n\n          case \"below\":\n            // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n            abselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth + chordMargin, undefined, {\n              type: \"text\",\n              position: \"below\",\n              height: chordHeight\n            }));\n            break;\n\n          case \"above\":\n            // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n            abselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth + chordMargin, undefined, {\n              type: \"text\",\n              height: chordHeight\n            }));\n            break;\n\n          default:\n            if (elem.chord[i].rel_position) {\n              var relPositionY = elem.chord[i].rel_position.y + 3 * spacing.STEP; // TODO-PER: this is a fudge factor to make it line up with abcm2ps\n\n              abselem.addChild(new RelativeElement(elem.chord[i].name, x + elem.chord[i].rel_position.x, 0, elem.minpitch + relPositionY / spacing.STEP, {\n                type: \"text\",\n                height: chordHeight\n              }));\n            } else {\n              // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n              var pos2 = 'above';\n              if (elem.positioning && elem.positioning.chordPosition) pos2 = elem.positioning.chordPosition;\n              dim = this.renderer.getTextSize(elem.chord[i].name, 'gchordfont', \"chord\");\n              chordHeight = dim.height / spacing.STEP;\n              chordWidth = dim.width; // Since the chord is centered, we only use half the width.\n\n              abselem.addCentered(new RelativeElement(elem.chord[i].name, x, chordWidth, undefined, {\n                type: \"chord\",\n                position: pos2,\n                height: chordHeight\n              }));\n            }\n\n        }\n      }\n    }\n\n    if (elem.startTriplet && !dontDraw) {\n      this.triplet = new TripletElem(elem.startTriplet, notehead); // above is opposite from case of slurs\n    }\n\n    if (elem.endTriplet && this.triplet && !dontDraw) {\n      this.triplet.setCloseAnchor(notehead);\n    }\n\n    return abselem;\n  };\n\n  AbstractEngraver.prototype.createNoteHead = function (abselem, c, pitchelem, dir, headx, extrax, flag, dot, dotshiftx, scale) {\n    // TODO scale the dot as well\n    var pitch = pitchelem.verticalPos;\n    var notehead;\n    var i;\n    this.accidentalshiftx = 0;\n    this.dotshiftx = 0;\n    if (c === undefined) abselem.addChild(new RelativeElement(\"pitch is undefined\", 0, 0, 0, {\n      type: \"debug\"\n    }));else if (c === \"\") {\n      notehead = new RelativeElement(null, 0, 0, pitch);\n    } else {\n      var shiftheadx = headx;\n\n      if (pitchelem.printer_shift) {\n        var adjust = pitchelem.printer_shift === \"same\" ? 1 : 0;\n        shiftheadx = dir === \"down\" ? -glyphs.getSymbolWidth(c) * scale + adjust : glyphs.getSymbolWidth(c) * scale - adjust;\n      }\n\n      var opts = {\n        scalex: scale,\n        scaley: scale,\n        thickness: glyphs.symbolHeightInPitches(c) * scale\n      }; //if (dir)\n      //\topts.stemHeight = ((dir===\"down\")?-this.stemHeight:this.stemHeight);\n\n      notehead = new RelativeElement(c, shiftheadx, glyphs.getSymbolWidth(c) * scale, pitch, opts);\n\n      if (flag) {\n        var pos = pitch + (dir === \"down\" ? -7 : 7) * scale;\n        if (scale === 1 && dir === \"down\" ? pos > 6 : pos < 6) pos = 6;\n        var xdelta = dir === \"down\" ? headx : headx + notehead.w - 0.6;\n        abselem.addRight(new RelativeElement(flag, xdelta, glyphs.getSymbolWidth(flag) * scale, pos, {\n          scalex: scale,\n          scaley: scale\n        }));\n      }\n\n      this.dotshiftx = notehead.w + dotshiftx - 2 + 5 * dot;\n\n      for (; dot > 0; dot--) {\n        var dotadjusty = 1 - Math.abs(pitch) % 2; //PER: take abs value of the pitch. And the shift still happens on ledger lines.\n\n        abselem.addRight(new RelativeElement(\"dots.dot\", notehead.w + dotshiftx - 2 + 5 * dot, glyphs.getSymbolWidth(\"dots.dot\"), pitch + dotadjusty));\n      }\n    }\n    if (notehead) notehead.highestVert = pitchelem.highestVert;\n\n    if (pitchelem.accidental) {\n      var symb;\n\n      switch (pitchelem.accidental) {\n        case \"quartersharp\":\n          symb = \"accidentals.halfsharp\";\n          break;\n\n        case \"dblsharp\":\n          symb = \"accidentals.dblsharp\";\n          break;\n\n        case \"sharp\":\n          symb = \"accidentals.sharp\";\n          break;\n\n        case \"quarterflat\":\n          symb = \"accidentals.halfflat\";\n          break;\n\n        case \"flat\":\n          symb = \"accidentals.flat\";\n          break;\n\n        case \"dblflat\":\n          symb = \"accidentals.dblflat\";\n          break;\n\n        case \"natural\":\n          symb = \"accidentals.nat\";\n      } // if a note is at least a sixth away, it can share a slot with another accidental\n\n\n      var accSlotFound = false;\n      var accPlace = extrax;\n\n      for (var j = 0; j < this.accidentalSlot.length; j++) {\n        if (pitch - this.accidentalSlot[j][0] >= 6) {\n          this.accidentalSlot[j][0] = pitch;\n          accPlace = this.accidentalSlot[j][1];\n          accSlotFound = true;\n          break;\n        }\n      }\n\n      if (accSlotFound === false) {\n        accPlace -= glyphs.getSymbolWidth(symb) * scale + 2;\n        this.accidentalSlot.push([pitch, accPlace]);\n        this.accidentalshiftx = glyphs.getSymbolWidth(symb) * scale + 2;\n      }\n\n      abselem.addExtra(new RelativeElement(symb, accPlace, glyphs.getSymbolWidth(symb), pitch, {\n        scalex: scale,\n        scaley: scale\n      }));\n    }\n\n    if (pitchelem.endTie) {\n      if (this.ties[0]) {\n        this.ties[0].setEndAnchor(notehead);\n        this.ties = this.ties.slice(1, this.ties.length);\n      }\n    }\n\n    if (pitchelem.startTie) {\n      //PER: bug fix: var tie = new TieElem(notehead, null, (this.stemdir==\"up\" || dir==\"down\") && this.stemdir!=\"down\",(this.stemdir==\"down\" || this.stemdir==\"up\"));\n      var tie = new TieElem(notehead, null, (this.stemdir === \"down\" || dir === \"down\") && this.stemdir !== \"up\", this.stemdir === \"down\" || this.stemdir === \"up\", true);\n      if (hint) tie.setHint();\n      this.ties[this.ties.length] = tie;\n      this.voice.addOther(tie); // HACK-PER: For the animation, we need to know if a note is tied to the next one, so here's a flag.\n      // Unfortunately, only some of the notes in the current event might be tied, but this will consider it\n      // tied if any one of them is. That will work for most cases.\n\n      abselem.startTie = true;\n    }\n\n    if (pitchelem.endSlur) {\n      for (i = 0; i < pitchelem.endSlur.length; i++) {\n        var slurid = pitchelem.endSlur[i];\n        var slur;\n\n        if (this.slurs[slurid]) {\n          slur = this.slurs[slurid];\n          slur.setEndAnchor(notehead);\n          delete this.slurs[slurid];\n        } else {\n          slur = new TieElem(null, notehead, dir === \"down\", (this.stemdir === \"up\" || dir === \"down\") && this.stemdir !== \"down\", false);\n          if (hint) slur.setHint();\n          this.voice.addOther(slur);\n        }\n\n        if (this.startlimitelem) {\n          slur.setStartX(this.startlimitelem);\n        }\n      }\n    }\n\n    if (pitchelem.startSlur) {\n      for (i = 0; i < pitchelem.startSlur.length; i++) {\n        var slurid = pitchelem.startSlur[i].label; //PER: bug fix: var slur = new TieElem(notehead, null, (this.stemdir==\"up\" || dir==\"down\") && this.stemdir!=\"down\", this.stemdir);\n\n        var slur = new TieElem(notehead, null, (this.stemdir === \"down\" || dir === \"down\") && this.stemdir !== \"up\", false, false);\n        if (hint) slur.setHint();\n        this.slurs[slurid] = slur;\n        this.voice.addOther(slur);\n      }\n    }\n\n    return notehead;\n  };\n\n  AbstractEngraver.prototype.addMeasureNumber = function (number, abselem) {\n    var measureNumHeight = this.renderer.getTextSize(number, \"measurefont\", 'bar-number');\n    abselem.addChild(new RelativeElement(number, 0, 0, 11 + measureNumHeight.height / spacing.STEP, {\n      type: \"barNumber\"\n    }));\n  };\n\n  AbstractEngraver.prototype.createBarLine = function (elem) {\n    // bar_thin, bar_thin_thick, bar_thin_thin, bar_thick_thin, bar_right_repeat, bar_left_repeat, bar_double_repeat\n    var abselem = new AbsoluteElement(elem, 0, 10, 'bar', this.tuneNumber);\n    var anchor = null; // place to attach part lines\n\n    var dx = 0;\n\n    if (elem.barNumber) {\n      this.addMeasureNumber(elem.barNumber, abselem);\n    }\n\n    var firstdots = elem.type === \"bar_right_repeat\" || elem.type === \"bar_dbl_repeat\";\n    var firstthin = elem.type !== \"bar_left_repeat\" && elem.type !== \"bar_thick_thin\" && elem.type !== \"bar_invisible\";\n    var thick = elem.type === \"bar_right_repeat\" || elem.type === \"bar_dbl_repeat\" || elem.type === \"bar_left_repeat\" || elem.type === \"bar_thin_thick\" || elem.type === \"bar_thick_thin\";\n    var secondthin = elem.type === \"bar_left_repeat\" || elem.type === \"bar_thick_thin\" || elem.type === \"bar_thin_thin\" || elem.type === \"bar_dbl_repeat\";\n    var seconddots = elem.type === \"bar_left_repeat\" || elem.type === \"bar_dbl_repeat\"; // limit positioning of slurs\n\n    if (firstdots || seconddots) {\n      for (var slur in this.slurs) {\n        if (this.slurs.hasOwnProperty(slur)) {\n          this.slurs[slur].setEndX(abselem);\n        }\n      }\n\n      this.startlimitelem = abselem;\n    }\n\n    if (firstdots) {\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n      dx += 6; //2 hardcoded, twice;\n    }\n\n    if (firstthin) {\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor);\n    }\n\n    if (elem.type === \"bar_invisible\") {\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"none\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor);\n    }\n\n    if (elem.decoration) {\n      this.decoration.createDecoration(this.voice, elem.decoration, 12, thick ? 3 : 1, abselem, 0, \"down\", 2, elem.positioning, this.hasVocals);\n    }\n\n    if (thick) {\n      dx += 4; //3 hardcoded;\n\n      anchor = new RelativeElement(null, dx, 4, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 4\n      });\n      abselem.addRight(anchor);\n      dx += 5;\n    } // if (this.partstartelem && (thick || (firstthin && secondthin))) { // means end of nth part\n    // this.partstartelem.anchor2=anchor;\n    // this.partstartelem = null;\n    // }\n\n\n    if (this.partstartelem && elem.endEnding) {\n      this.partstartelem.anchor2 = anchor;\n      this.partstartelem = null;\n    }\n\n    if (secondthin) {\n      dx += 3; //3 hardcoded;\n\n      anchor = new RelativeElement(null, dx, 1, 2, {\n        \"type\": \"bar\",\n        \"pitch2\": 10,\n        linewidth: 0.6\n      });\n      abselem.addRight(anchor); // 3 is hardcoded\n    }\n\n    if (seconddots) {\n      dx += 3; //3 hardcoded;\n\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n      abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n    } // 2 is hardcoded\n\n\n    if (elem.startEnding && this.s === 0) {\n      // only put the first & second ending marks on the first staff\n      var textWidth = this.renderer.getTextSize(elem.startEnding, \"repeatfont\", '').width;\n      abselem.minspacing += textWidth + 10; // Give plenty of room for the ending number.\n\n      this.partstartelem = new EndingElem(elem.startEnding, anchor, null);\n      this.voice.addOther(this.partstartelem);\n    }\n\n    return abselem;\n  };\n})();\n\nmodule.exports = AbstractEngraver;","map":{"version":3,"sources":["/Users/philbrockman/coding/MusicalGens/app/http/web/app/node_modules/abcjs/src/write/abc_abstract_engraver.js"],"names":["AbsoluteElement","require","BeamElem","BraceElem","createClef","createKeySignature","createTimeSignature","Decoration","EndingElem","glyphs","RelativeElement","spacing","StaffGroupElement","TempoElement","TieElem","TripletElem","VoiceElement","parseCommon","AbstractEngraver","getDuration","elem","d","duration","hint","bagpipes","renderer","tuneNumber","decoration","isBagpipes","chartable","rest","note","rhythm","nostem","x","harmonic","uflags","dflags","reset","prototype","slurs","ties","slursbyvoice","tiesbyvoice","endingsbyvoice","s","v","tripletmultiplier","abcline","undefined","accidentalSlot","accidentalshiftx","dotshiftx","hasVocals","minY","partstartelem","pos","roomtaken","roomtakenright","staffgroup","startlimitelem","stemdir","voice","setStemHeight","heightInPixels","stemHeight","STEP","getCurrentVoiceId","pushCrossLineElems","popCrossLineElems","getElem","length","getNextElem","containsLyrics","staves","i","j","voices","k","el","lyric","positioning","vocalPosition","createABCLine","staffs","tempo","tempoSet","restoreState","createABCStaff","abcstaff","barfrom","connectBarLines","barto","duplicate","title","header","clef","barNumber","addMeasureNumber","addChild","keySig","key","meter","ts","children","staffLines","stafflines","addVoice","createABCVoice","setStaffLimits","brace","increaseStavesIncluded","addOther","slur","hasOwnProperty","above","force","setHint","abselems","createABCElement","suppress","saveState","tiesSave","cloneArray","slursSave","cloneHashOfHash","slursbyvoiceSave","tiesbyvoiceSave","cloneHashOfArrayOfHash","elemset","el_type","createBeam","createBarLine","invisible","absKey","direction","abselem","dim","getTextSize","type","height","abselem3","head","style","abselem2","calcBeamDir","beamelem","oldPos","createNote","add","endBeam","dir","calcDir","abselemset","startBeam","oldDir","push","triplet","isClosed","addBeam","sortPitch","sorted","p","pitches","pitch","tmp","ledgerLines","minPitch","maxPitch","isRest","c","additionalLedgers","dx","scale","getSymbolWidth","ofs","dontDraw","notehead","grace","flag","pp","width","p1","p2","zeroDuration","durlog","Math","floor","log","dot","tot","pow","inc","startTriplet","tripletMultiplier","durationForSpacing","absType","durationClassOveride","restpitch","voicetotal","numLines","lines","averagepitch","minpitch","maxpitch","mmWidth","addHead","numMeasures","addExtra","createNoteHead","verticalPos","max","sum","min","noteSymbol","console","prev","curr","delta","printer_shift","highestVert","isTopWhenStemIsDown","isBottomWhenStemIsUp","startSlur","endSlur","hasStem","gracenotes","bottom","heads","w","linewidth","lyricStr","each","ly","div","divider","syllable","lyricDim","position","addCentered","gracescale","graceScaleStem","gracebeam","mainNote","graceoffsets","accidental","gracepitch","acciaccatura","dAcciaccatura","addRight","scalex","scaley","graceDuration","pseudoabselem","abcelem","isTie","createDecoration","top","chordMargin","chord","y","name","chordWidth","chordHeight","rel_position","relPositionY","pos2","chordPosition","endTriplet","setCloseAnchor","pitchelem","headx","extrax","shiftheadx","adjust","opts","thickness","symbolHeightInPitches","xdelta","dotadjusty","abs","symb","accSlotFound","accPlace","endTie","setEndAnchor","slice","startTie","tie","slurid","setStartX","label","number","measureNumHeight","anchor","firstdots","firstthin","thick","secondthin","seconddots","setEndX","endEnding","anchor2","startEnding","textWidth","minspacing","module","exports"],"mappings":"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","sourcesContent":["// abc_abstract_engraver.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com)\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global window */\n\nvar AbsoluteElement = require('./abc_absolute_element');\nvar BeamElem = require('./abc_beam_element');\nvar BraceElem = require('./abc_brace_element');\nvar createClef = require('./abc_create_clef');\nvar createKeySignature = require('./abc_create_key_signature');\nvar createTimeSignature = require('./abc_create_time_signature');\nvar Decoration = require('./abc_decoration');\nvar EndingElem = require('./abc_ending_element');\nvar glyphs = require('./abc_glyphs');\nvar RelativeElement = require('./abc_relative_element');\nvar spacing = require('./abc_spacing');\nvar StaffGroupElement = require('./abc_staff_group_element');\nvar TempoElement = require('./abc_tempo_element');\nvar TieElem = require('./abc_tie_element');\nvar TripletElem = require('./abc_triplet_element');\nvar VoiceElement = require('./abc_voice_element');\n\nvar parseCommon = require('../parse/abc_common');\n\nvar AbstractEngraver;\n\n(function() {\n\t\"use strict\";\n\nvar getDuration = function(elem) {\n  var d = 0;\n  if (elem.duration) {\n    d = elem.duration;\n  }\n  return d;\n};\n\nvar hint = false;\n\nAbstractEngraver = function(bagpipes, renderer, tuneNumber) {\n\tthis.decoration = new Decoration();\n\tthis.renderer = renderer;\n\tthis.tuneNumber = tuneNumber;\n  this.isBagpipes = bagpipes;\n  this.chartable = {rest:{0:\"rests.whole\", 1:\"rests.half\", 2:\"rests.quarter\", 3:\"rests.8th\", 4: \"rests.16th\",5: \"rests.32nd\", 6: \"rests.64th\", 7: \"rests.128th\", \"multi\": \"rests.multimeasure\"},\n                 note:{\"-1\": \"noteheads.dbl\", 0:\"noteheads.whole\", 1:\"noteheads.half\", 2:\"noteheads.quarter\", 3:\"noteheads.quarter\", 4:\"noteheads.quarter\", 5:\"noteheads.quarter\", 6:\"noteheads.quarter\", 7:\"noteheads.quarter\", 'nostem':\"noteheads.quarter\"},\n                 rhythm:{\"-1\": \"noteheads.slash.whole\", 0:\"noteheads.slash.whole\", 1:\"noteheads.slash.whole\", 2:\"noteheads.slash.quarter\", 3:\"noteheads.slash.quarter\", 4:\"noteheads.slash.quarter\", 5:\"noteheads.slash.quarter\", 6:\"noteheads.slash.quarter\", 7:\"noteheads.slash.quarter\", nostem: \"noteheads.slash.nostem\"},\n                 x:{\"-1\": \"noteheads.indeterminate\", 0:\"noteheads.indeterminate\", 1:\"noteheads.indeterminate\", 2:\"noteheads.indeterminate\", 3:\"noteheads.indeterminate\", 4:\"noteheads.indeterminate\", 5:\"noteheads.indeterminate\", 6:\"noteheads.indeterminate\", 7:\"noteheads.indeterminate\", nostem: \"noteheads.indeterminate\"},\n                 harmonic:{\"-1\": \"noteheads.harmonic.quarter\", 0:\"noteheads.harmonic.quarter\", 1:\"noteheads.harmonic.quarter\", 2:\"noteheads.harmonic.quarter\", 3:\"noteheads.harmonic.quarter\", 4:\"noteheads.harmonic.quarter\", 5:\"noteheads.harmonic.quarter\", 6:\"noteheads.harmonic.quarter\", 7:\"noteheads.harmonic.quarter\", nostem: \"noteheads.harmonic.quarter\"},\n                 uflags:{3:\"flags.u8th\", 4:\"flags.u16th\", 5:\"flags.u32nd\", 6:\"flags.u64th\"},\n                 dflags:{3:\"flags.d8th\", 4:\"flags.d16th\", 5:\"flags.d32nd\", 6:\"flags.d64th\"}};\n\tthis.reset();\n};\n\nAbstractEngraver.prototype.reset = function() {\n\tthis.slurs = {};\n\tthis.ties = [];\n\tthis.slursbyvoice = {};\n\tthis.tiesbyvoice = {};\n\tthis.endingsbyvoice = {};\n\tthis.s = 0; // current staff number\n\tthis.v = 0; // current voice number on current staff\n\tthis.tripletmultiplier = 1;\n\n\tthis.abcline = undefined;\n\tthis.accidentalSlot = undefined;\n\tthis.accidentalshiftx = undefined;\n\tthis.dotshiftx = undefined;\n\tthis.hasVocals = false;\n\tthis.minY = undefined;\n\tthis.partstartelem = undefined;\n\tthis.pos = undefined;\n\tthis.roomtaken = undefined;\n\tthis.roomtakenright = undefined;\n\tthis.staffgroup = undefined;\n\tthis.startlimitelem = undefined;\n\tthis.stemdir = undefined;\n\tthis.voice = undefined;\n};\n\nAbstractEngraver.prototype.setStemHeight = function(heightInPixels) {\n\tthis.stemHeight = heightInPixels / spacing.STEP;\n};\n\nAbstractEngraver.prototype.getCurrentVoiceId = function() {\n  return \"s\"+this.s+\"v\"+this.v;\n};\n\nAbstractEngraver.prototype.pushCrossLineElems = function() {\n  this.slursbyvoice[this.getCurrentVoiceId()] = this.slurs;\n  this.tiesbyvoice[this.getCurrentVoiceId()] = this.ties;\n  this.endingsbyvoice[this.getCurrentVoiceId()] = this.partstartelem;\n};\n\nAbstractEngraver.prototype.popCrossLineElems = function() {\n  this.slurs = this.slursbyvoice[this.getCurrentVoiceId()] || {};\n  this.ties = this.tiesbyvoice[this.getCurrentVoiceId()] || [];\n  this.partstartelem = this.endingsbyvoice[this.getCurrentVoiceId()];\n};\n\nAbstractEngraver.prototype.getElem = function() {\n  if (this.abcline.length <= this.pos)\n    return null;\n  return this.abcline[this.pos];\n};\n\nAbstractEngraver.prototype.getNextElem = function() {\n        if (this.abcline.length <= this.pos+1)\n                return null;\n    return this.abcline[this.pos+1];\n};\n\n\tAbstractEngraver.prototype.containsLyrics = function(staves) {\n\t\tfor (var i = 0; i < staves.length; i++) {\n\t\t\tfor (var j = 0; j < staves[i].voices.length; j++) {\n\t\t\t\tfor (var k = 0; k < staves[i].voices[j].length; k++) {\n\t\t\t\t\tvar el = staves[i].voices[j][k];\n\t\t\t\t\tif (el.lyric) {\n\t\t\t\t\t\t// We just want to see if there are vocals below the music to know where to put the dynamics.\n\t\t\t\t\t\tif (!el.positioning || el.positioning.vocalPosition === 'below')\n\t\t\t\t\t\t\tthis.hasVocals = true;\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\nAbstractEngraver.prototype.createABCLine = function(staffs, tempo) {\n    this.minY = 2; // PER: This is the lowest that any note reaches. It will be used to set the dynamics row.\n\t// See if there are any lyrics on this line.\n\tthis.containsLyrics(staffs);\n  this.staffgroup = new StaffGroupElement();\n\tthis.tempoSet = false;\n  for (this.s = 0; this.s < staffs.length; this.s++) {\n\t  if (hint)\n\t\t  this.restoreState();\n\t  hint = false;\n    this.createABCStaff(staffs[this.s], tempo);\n  }\n  return this.staffgroup;\n};\n\nAbstractEngraver.prototype.createABCStaff = function(abcstaff, tempo) {\n// If the tempo is passed in, then the first element should get the tempo attached to it.\n  for (this.v = 0; this.v < abcstaff.voices.length; this.v++) {\n    this.voice = new VoiceElement(this.v,abcstaff.voices.length);\n    if (this.v===0) {\n      this.voice.barfrom = (abcstaff.connectBarLines===\"start\" || abcstaff.connectBarLines===\"continue\");\n      this.voice.barto = (abcstaff.connectBarLines===\"continue\" || abcstaff.connectBarLines===\"end\");\n    } else {\n      this.voice.duplicate = true; // bar lines and other duplicate info need not be created\n    }\n    if (abcstaff.title && abcstaff.title[this.v]) this.voice.header=abcstaff.title[this.v];\n\t  var clef = createClef(abcstaff.clef, this.tuneNumber);\n\t  if (clef) {\n\t\t  if (this.v ===0 && abcstaff.barNumber) {\n\t\t\t  this.addMeasureNumber(abcstaff.barNumber, clef);\n\t\t  }\n\t\t  this.voice.addChild(clef);\n\t  }\n\t  var keySig = createKeySignature(abcstaff.key, this.tuneNumber);\n\t  if (keySig) {\n\t\t  this.voice.addChild(keySig);\n\t\t  this.startlimitelem = keySig; // limit ties here\n\t  }\n    if (abcstaff.meter) {\n\t\tvar ts = createTimeSignature(abcstaff.meter, this.tuneNumber);\n\t\tthis.voice.addChild(ts);\n\t\tthis.startlimitelem = ts; // limit ties here\n\t}\n\t  if (this.voice.duplicate)\n\t  \tthis.voice.children = []; // we shouldn't reprint the above if we're reusing the same staff. We just created them to get the right spacing.\n    var staffLines = abcstaff.clef.stafflines || abcstaff.clef.stafflines === 0 ? abcstaff.clef.stafflines : 5;\n    this.staffgroup.addVoice(this.voice,this.s,staffLines);\n\t  this.createABCVoice(abcstaff.voices[this.v],tempo);\n\t  this.staffgroup.setStaffLimits(this.voice);\n            //Tony: Here I am following what staves need to be surrounded by the brace, by incrementing the length of the brace class.\n            //So basically this keeps incrementing the number of staff surrounded by the brace until it sees \"end\".\n            //This then gets processed in abc_staff_group_element.js, so that it will have the correct top and bottom coordinates for the brace.\n\t\t\tif(abcstaff.brace === \"start\"){\n\t\t\t\tthis.staffgroup.brace = new BraceElem(1, true);\n\t\t\t}\n\t\t\telse if(abcstaff.brace === \"end\" && this.staffgroup.brace) {\n\t\t\t\tthis.staffgroup.brace.increaseStavesIncluded();\n\t\t\t}\n\t\t\telse if(abcstaff.brace === \"continue\" && this.staffgroup.brace){\n\t\t\t\tthis.staffgroup.brace.increaseStavesIncluded();\n\t\t\t}\n  }\n};\n\nAbstractEngraver.prototype.createABCVoice = function(abcline, tempo) {\n  this.popCrossLineElems();\n  this.stemdir = (this.isBagpipes)?\"down\":null;\n  this.abcline = abcline;\n  if (this.partstartelem) {\n    this.partstartelem = new EndingElem(\"\", null, null);\n    this.voice.addOther(this.partstartelem);\n  }\n  for (var slur in this.slurs) {\n    if (this.slurs.hasOwnProperty(slur)) {\n      this.slurs[slur]= new TieElem(null, null, this.slurs[slur].above, this.slurs[slur].force, false);\n\t\tif (hint) this.slurs[slur].setHint();\n        this.voice.addOther(this.slurs[slur]);\n    }\n  }\n  for (var i=0; i<this.ties.length; i++) {\n    this.ties[i]=new TieElem(null, null, this.ties[i].above, this.ties[i].force, true);\n\t  if (hint) this.ties[i].setHint();\n    this.voice.addOther(this.ties[i]);\n  }\n\n  for (this.pos=0; this.pos<this.abcline.length; this.pos++) {\n    var abselems = this.createABCElement();\n\t  if (abselems) {\n    for (i=0; i<abselems.length; i++) {\n      if (!this.tempoSet && tempo && !tempo.suppress) {\n        this.tempoSet = true;\n        abselems[i].addChild(new TempoElement(tempo, this.tuneNumber));\n      }\n      this.voice.addChild(abselems[i]);\n    }\n    }\n  }\n  this.pushCrossLineElems();\n};\n\n\tAbstractEngraver.prototype.saveState = function() {\n\t\tthis.tiesSave = parseCommon.cloneArray(this.ties);\n\t\tthis.slursSave = parseCommon.cloneHashOfHash(this.slurs);\n\t\tthis.slursbyvoiceSave = parseCommon.cloneHashOfHash(this.slursbyvoice);\n\t\tthis.tiesbyvoiceSave = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoice);\n\t};\n\n\tAbstractEngraver.prototype.restoreState = function() {\n\t\tthis.ties = parseCommon.cloneArray(this.tiesSave);\n\t\tthis.slurs = parseCommon.cloneHashOfHash(this.slursSave);\n\t\tthis.slursbyvoice = parseCommon.cloneHashOfHash(this.slursbyvoiceSave);\n\t\tthis.tiesbyvoice = parseCommon.cloneHashOfArrayOfHash(this.tiesbyvoiceSave);\n\t};\n\n// return an array of AbsoluteElement\nAbstractEngraver.prototype.createABCElement = function() {\n  var elemset = [];\n  var elem = this.getElem();\n  switch (elem.el_type) {\n  case \"note\":\n    elemset = this.createBeam();\n    break;\n  case \"bar\":\n    elemset[0] = this.createBarLine(elem);\n    if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"meter\":\n    elemset[0] = createTimeSignature(elem, this.tuneNumber);\n\t  this.startlimitelem = elemset[0]; // limit ties here\n    if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"clef\":\n    elemset[0] = createClef(elem, this.tuneNumber);\n\t  if (!elemset[0]) return null;\n    if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"key\":\n\t  var absKey = createKeySignature(elem, this.tuneNumber);\n\t  if (absKey) {\n\t\t  elemset[0] = absKey;\n\t\t  this.startlimitelem = elemset[0]; // limit ties here\n\t  }\n    if (this.voice.duplicate && elemset.length > 0) elemset[0].invisible = true;\n    break;\n  case \"stem\":\n    this.stemdir=elem.direction;\n    break;\n  case \"part\":\n    var abselem = new AbsoluteElement(elem,0,0, 'part', this.tuneNumber);\n\t  var dim = this.renderer.getTextSize(elem.title, 'partsfont', \"part\");\n    abselem.addChild(new RelativeElement(elem.title, 0, 0, undefined, {type:\"part\", height: dim.height/spacing.STEP}));\n    elemset[0] = abselem;\n    break;\n  case \"tempo\":\n    var abselem3 = new AbsoluteElement(elem,0,0, 'tempo', this.tuneNumber);\n    abselem3.addChild(new TempoElement(elem, this.tuneNumber));\n    elemset[0] = abselem3;\n    break;\n\t  case \"style\":\n\t\t  if (elem.head === \"normal\")\n\t\t\t  delete this.style;\n\t\t  else\n\t\t\t  this.style = elem.head;\n\t\t  break;\n\t  case \"hint\":\n\t\t  hint = true;\n\t\t  this.saveState();\n\t\t  break;\n\t  case \"midi\":\n\t\t// This has no effect on the visible music, so just skip it.\n\t\tbreak;\n\n  default:\n    var abselem2 = new AbsoluteElement(elem,0,0, 'unsupported', this.tuneNumber);\n    abselem2.addChild(new RelativeElement(\"element type \"+elem.el_type, 0, 0, undefined, {type:\"debug\"}));\n    elemset[0] = abselem2;\n  }\n\n  return elemset;\n};\n\nAbstractEngraver.prototype.calcBeamDir = function() {\n\tif (this.stemdir) // If the user or voice is forcing the stem direction, we already know the answer.\n\t\treturn this.stemdir;\n\tvar beamelem = new BeamElem(this.stemHeight, this.stemdir);\n\t// PER: need two passes: the first one decides if the stems are up or down.\n\tvar oldPos = this.pos;\n\tvar abselem;\n\twhile (this.getElem()) {\n\t\tabselem = this.createNote(this.getElem(), true, true);\n\t\tbeamelem.add(abselem);\n\t\tif (this.getElem().endBeam)\n\t\t\tbreak;\n\t\tthis.pos++;\n\t}\n\tvar dir = beamelem.calcDir();\n\tthis.pos = oldPos;\n\treturn dir ? \"up\" : \"down\";\n};\n\nAbstractEngraver.prototype.createBeam = function() {\n  var abselemset = [];\n\n  if (this.getElem().startBeam && !this.getElem().endBeam) {\n\t  var dir = this.calcBeamDir();\n         var beamelem = new BeamElem(this.stemHeight, dir);\n\t  if (hint) beamelem.setHint();\n         var oldDir = this.stemdir;\n         this.stemdir = dir;\n\t  while (this.getElem()) {\n\t\t  var abselem = this.createNote(this.getElem(), true);\n\t\t  abselemset.push(abselem);\n\t\t  beamelem.add(abselem);\n\t\t  if (this.triplet && this.triplet.isClosed()) {\n\t\t\t  this.voice.addOther(this.triplet);\n\t\t\t  this.triplet = null;\n\t\t\t  this.tripletmultiplier = 1;\n\t\t  }\n\t\t  if (this.getElem().endBeam) {\n\t\t\t  break;\n\t\t  }\n\t\t  this.pos++;\n\t  }\n         this.stemdir = oldDir;\n    this.voice.addBeam(beamelem);\n  } else {\n    abselemset[0] = this.createNote(this.getElem());\n\t  if (this.triplet && this.triplet.isClosed()) {\n\t\t  this.voice.addOther(this.triplet);\n\t\t  this.triplet = null;\n\t\t  this.tripletmultiplier = 1;\n\t  }\n  }\n  return abselemset;\n};\n\nvar sortPitch = function(elem) {\n  var sorted;\n  do {\n    sorted = true;\n    for (var p = 0; p<elem.pitches.length-1; p++) {\n      if (elem.pitches[p].pitch>elem.pitches[p+1].pitch) {\n        sorted = false;\n        var tmp = elem.pitches[p];\n        elem.pitches[p] = elem.pitches[p+1];\n        elem.pitches[p+1] = tmp;\n      }\n    }\n  } while (!sorted);\n};\n\nvar ledgerLines = function(abselem, minPitch, maxPitch, isRest, c, additionalLedgers, dir, dx, scale) {\n\tfor (var i=maxPitch; i>11; i--) {\n\t\tif (i%2===0 && !isRest) {\n\t\t\tabselem.addChild(new RelativeElement(null, dx, (glyphs.getSymbolWidth(c)+4)*scale, i, {type:\"ledger\"}));\n\t\t}\n\t}\n\n\tfor (i=minPitch; i<1; i++) {\n\t\tif (i%2===0 && !isRest) {\n\t\t\tabselem.addChild(new RelativeElement(null, dx, (glyphs.getSymbolWidth(c)+4)*scale, i, {type:\"ledger\"}));\n\t\t}\n\t}\n\n\tfor (i = 0; i < additionalLedgers.length; i++) { // PER: draw additional ledgers\n\t\tvar ofs = glyphs.getSymbolWidth(c);\n\t\tif (dir === 'down') ofs = -ofs;\n\t\tabselem.addChild(new RelativeElement(null, ofs+dx, (glyphs.getSymbolWidth(c)+4)*scale, additionalLedgers[i], {type:\"ledger\"}));\n\t}\n};\n\nAbstractEngraver.prototype.createNote = function(elem, nostem, dontDraw) { //stem presence: true for drawing stemless notehead\n  var notehead = null;\n  var grace= null;\n  this.roomtaken = 0; // room needed to the left of the note\n  this.roomtakenright = 0; // room needed to the right of the note\n  var dotshiftx = 0; // room taken by chords with displaced noteheads which cause dots to shift\n  var c=\"\";\n  var flag = null;\n  var additionalLedgers = []; // PER: handle the case of [bc'], where the b doesn't have a ledger line\n\n  var p, i, pp;\n  var width, p1, p2, dx;\n\n  var duration = getDuration(elem);\n\tvar zeroDuration = false;\n  if (duration === 0) { zeroDuration = true; duration = 0.25; nostem = true; }        //PER: zero duration will draw a quarter note head.\n  var durlog = Math.floor(Math.log(duration)/Math.log(2)); //TODO use getDurlog\n  var dot=0;\n\n  for (var tot = Math.pow(2,durlog), inc=tot/2; tot<duration; dot++,tot+=inc,inc/=2);\n\n\n\tif (elem.startTriplet) {\n\t\tthis.tripletmultiplier = elem.tripletMultiplier;\n\t}\n\n  var durationForSpacing = duration * this.tripletmultiplier;\n  if (elem.rest && elem.rest.type === 'multimeasure')\n  \tdurationForSpacing = 1;\n  var absType = elem.rest ? \"rest\" : \"note\";\n  var abselem = new AbsoluteElement(elem, durationForSpacing, 1, absType, this.tuneNumber, { durationClassOveride: elem.duration * this.tripletmultiplier});\n  if (hint) abselem.setHint();\n\n  if (elem.rest) {\n    var restpitch = 7;\n    if (this.voice.voicetotal > 1) {\n\t    if (this.stemdir === \"down\") restpitch = 3;\n\t    if (this.stemdir === \"up\") restpitch = 11;\n    }\n\t  // There is special placement for the percussion staff. If there is one staff line, then move the rest position.\n\t  var numLines = this.staffgroup.staffs[this.staffgroup.staffs.length-1].lines;\n\t  if (numLines === 1) {\n\t\t  // The half and whole rests are attached to different lines normally, so we need to tweak their position to get them to both be attached to the same one.\n\t\t  if (duration < 0.5)\n\t\t\t  restpitch = 7;\n\t\t  else if (duration < 1)\n\t\t\trestpitch = 6.8;\t// half rest\n\t\t  else\n\t\t  \trestpitch = 4.8; // whole rest\n\t  }\n    switch(elem.rest.type) {\n\t\tcase \"whole\":\n\t\t\tc = this.chartable.rest[0];\n\t\t\telem.averagepitch=restpitch;\n\t\t\telem.minpitch=restpitch;\n\t\t\telem.maxpitch=restpitch;\n\t\t\tdot = 0;\n\t\t\tbreak;\n    case \"rest\":\n\t    if (elem.style === \"rhythm\") // special case for rhythm: rests are a handy way to express the rhythm.\n\t\t    c = this.chartable.rhythm[-durlog];\n\t    else\n\t\t    c = this.chartable.rest[-durlog];\n      elem.averagepitch=restpitch;\n      elem.minpitch=restpitch;\n      elem.maxpitch=restpitch;\n      break;\n    case \"invisible\":\n    case \"spacer\":\n      c=\"\";\n\t\telem.averagepitch=restpitch;\n\t\telem.minpitch=restpitch;\n\t\telem.maxpitch=restpitch;\n\t\tbreak;\n\t    case \"multimeasure\":\n\t    \tc = this.chartable.rest['multi'];\n\t\t    elem.averagepitch=restpitch;\n\t\t    elem.minpitch=restpitch;\n\t\t    elem.maxpitch=restpitch;\n\t\t    dot = 0;\n\t\t    var mmWidth = glyphs.getSymbolWidth(c);\n\t\t    abselem.addHead(new RelativeElement(c, -mmWidth, mmWidth*2, 7 ));\n\t\t    var numMeasures = new RelativeElement(\"\"+elem.duration, 0, mmWidth, 16, {type:\"multimeasure-text\"});\n\t\t    abselem.addExtra(numMeasures);\n    }\n         if (!dontDraw && elem.rest.type !== \"multimeasure\")\n    notehead = this.createNoteHead(abselem, c, {verticalPos:restpitch}, null, 0, -this.roomtaken, null, dot, 0, 1);\n    if (notehead) abselem.addHead(notehead);\n    this.roomtaken+=this.accidentalshiftx;\n    this.roomtakenright = Math.max(this.roomtakenright,this.dotshiftx);\n\n  } else {\n         sortPitch(elem);\n\n    // determine averagepitch, minpitch, maxpitch and stem direction\n    var sum=0;\n    for (p=0, pp=elem.pitches.length; p<pp; p++) {\n      sum += elem.pitches[p].verticalPos;\n    }\n    elem.averagepitch = sum/elem.pitches.length;\n    elem.minpitch = elem.pitches[0].verticalPos;\n      this.minY = Math.min(elem.minpitch, this.minY);\n    elem.maxpitch = elem.pitches[elem.pitches.length-1].verticalPos;\n    var dir = (elem.averagepitch>=6) ? \"down\": \"up\";\n    if (this.stemdir) dir=this.stemdir;\n\n\t  var style = elem.style ? elem.style : this.style; // get the style of note head.\n\t  if (!style || style === \"normal\") style = \"note\";\n\t  var noteSymbol;\n\t  if (zeroDuration)\n\t\t  noteSymbol = this.chartable[style].nostem;\n\t\telse\n\t\t  noteSymbol = this.chartable[style][-durlog];\n\t  if (!noteSymbol)\n\t  \tconsole.log(\"noteSymbol:\", style, durlog, zeroDuration);\n\n    // determine elements of chords which should be shifted\n    for (p=(dir===\"down\")?elem.pitches.length-2:1; (dir===\"down\")?p>=0:p<elem.pitches.length; p=(dir===\"down\")?p-1:p+1) {\n      var prev = elem.pitches[(dir===\"down\")?p+1:p-1];\n      var curr = elem.pitches[p];\n      var delta = (dir===\"down\")?prev.pitch-curr.pitch:curr.pitch-prev.pitch;\n      if (delta<=1 && !prev.printer_shift) {\n        curr.printer_shift=(delta)?\"different\":\"same\";\n        if (curr.verticalPos > 11 || curr.verticalPos < 1) {        // PER: add extra ledger line\n          additionalLedgers.push(curr.verticalPos - (curr.verticalPos%2));\n        }\n        if (dir===\"down\") {\n         this.roomtaken = glyphs.getSymbolWidth(noteSymbol)+2;\n        } else {\n         dotshiftx = glyphs.getSymbolWidth(noteSymbol)+2;\n        }\n      }\n    }\n\n           // The accidentalSlot will hold a list of all the accidentals on this chord. Each element is a vertical place,\n           // and contains a pitch, which is the last pitch that contains an accidental in that slot. The slots are numbered\n         // from closest to the note to farther left. We only need to know the last accidental we placed because\n         // we know that the pitches are sorted by now.\n    this.accidentalSlot = [];\n\n    for (p=0; p<elem.pitches.length; p++) {\n\n      if (!nostem) {\n        if ((dir===\"down\" && p!==0) || (dir===\"up\" && p!==pp-1)) { // not the stemmed elem of the chord\n         flag = null;\n        } else {\n         flag = this.chartable[(dir===\"down\")?\"dflags\":\"uflags\"][-durlog];\n        }\n      }\n\t    if (elem.pitches[p].style) { // There is a style for the whole group of pitches, but there could also be an override for a particular pitch.\n\t\t    c = this.chartable[elem.pitches[p].style][-durlog];\n\t    } else\n\t\t    c = noteSymbol;\n                // The highest position for the sake of placing slurs is itself if the slur is internal. It is the highest position possible if the slur is for the whole chord.\n                // If the note is the only one in the chord, then any slur it has counts as if it were on the whole chord.\n                elem.pitches[p].highestVert = elem.pitches[p].verticalPos;\n                var isTopWhenStemIsDown = (this.stemdir===\"up\" || dir===\"up\") && p===0;\n                var isBottomWhenStemIsUp = (this.stemdir===\"down\" || dir===\"down\") && p===pp-1;\n      if (!dontDraw && (isTopWhenStemIsDown || isBottomWhenStemIsUp)) { // place to put slurs if not already on pitches\n\n                 if (elem.startSlur || pp === 1) {\n                 elem.pitches[p].highestVert = elem.pitches[pp-1].verticalPos;\n                 if (this.stemdir===\"up\" || dir===\"up\")\n                                        elem.pitches[p].highestVert += 6;        // If the stem is up, then compensate for the length of the stem\n                 }\n                         if (elem.startSlur) {\n          if (!elem.pitches[p].startSlur) elem.pitches[p].startSlur = []; //TODO possibly redundant, provided array is not optional\n         for (i=0; i<elem.startSlur.length; i++) {\n         elem.pitches[p].startSlur.push(elem.startSlur[i]);\n         }\n        }\n\n        if (!dontDraw && elem.endSlur) {\n                        elem.pitches[p].highestVert = elem.pitches[pp-1].verticalPos;\n                        if (this.stemdir===\"up\" || dir===\"up\")\n                                elem.pitches[p].highestVert += 6;        // If the stem is up, then compensate for the length of the stem\n          if (!elem.pitches[p].endSlur) elem.pitches[p].endSlur = []; //TODO possibly redundant, provided array is not optional\n         for (i=0; i<elem.endSlur.length; i++) {\n         elem.pitches[p].endSlur.push(elem.endSlur[i]);\n         }\n        }\n      }\n\n\t\tvar hasStem = !nostem && durlog<=-1;\n                if (!dontDraw)\n      notehead = this.createNoteHead(abselem, c, elem.pitches[p], hasStem ? dir : null, 0, -this.roomtaken, flag, dot, dotshiftx, 1);\n      if (notehead) {\n      \tif (elem.gracenotes && elem.gracenotes.length > 0)\n\t\t\tnotehead.bottom = notehead.bottom - 1;\t // If there is a tie to the grace notes, leave a little more room for the note to avoid collisions.\n\t\t  abselem.addHead(notehead);\n\t  }\n      this.roomtaken += this.accidentalshiftx;\n      this.roomtakenright = Math.max(this.roomtakenright,this.dotshiftx);\n    }\n\n    // draw stem from the furthest note to a pitch above/below the stemmed note\n    if (hasStem) {\n      p1 = (dir===\"down\") ? elem.minpitch-7 : elem.minpitch+1/3;\n                // PER added stemdir test to make the line meet the note.\n      if (p1>6 && !this.stemdir) p1=6;\n      p2 = (dir===\"down\") ? elem.maxpitch-1/3 : elem.maxpitch+7;\n                // PER added stemdir test to make the line meet the note.\n      if (p2<6 && !this.stemdir) p2=6;\n      dx = (dir===\"down\" || abselem.heads.length === 0)?0:abselem.heads[0].w;\n      width = (dir===\"down\")?1:-1;\n\t\t// TODO-PER-HACK: One type of note head has a different placement of the stem. This should be more generically calculated:\n\t\tif (notehead.c === 'noteheads.slash.quarter') {\n\t\t\tif (dir === 'down')\n\t\t\t\tp2 -= 1;\n\t\t\telse\n\t\t\t\tp1 += 1;\n\t\t}\n      abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\"type\": \"stem\", \"pitch2\":p2, linewidth: width}));\n        this.minY = Math.min(p1, this.minY);\n        this.minY = Math.min(p2, this.minY);\n    }\n\n  }\n\n  if (elem.lyric !== undefined) {\n    var lyricStr = \"\";\n         parseCommon.each(elem.lyric, function(ly) {\n         \tvar div = ly.divider === ' ' ? \"\" : ly.divider;\n         lyricStr += ly.syllable + div + \"\\n\";\n      });\n\t  var lyricDim = this.renderer.getTextSize(lyricStr, 'vocalfont', \"lyric\");\n\t  var position = elem.positioning ? elem.positioning.vocalPosition : 'below';\n    abselem.addCentered(new RelativeElement(lyricStr, 0, lyricDim.width, undefined, {type:\"lyric\", position: position, height: lyricDim.height / spacing.STEP }));\n  }\n\n  if (!dontDraw && elem.gracenotes !== undefined) {\n    var gracescale = 3/5;\n    var graceScaleStem = 3.5/5; // TODO-PER: empirically found constant.\n    var gracebeam = null;\n    if (elem.gracenotes.length>1) {\n      gracebeam = new BeamElem(this.stemHeight*graceScaleStem, \"grace\",this.isBagpipes);\n\t\tif (hint) gracebeam.setHint();\n\t\tgracebeam.mainNote = abselem;\t// this gives us a reference back to the note this is attached to so that the stems can be attached somewhere.\n    }\n\n    var graceoffsets = [];\n    for (i=elem.gracenotes.length-1; i>=0; i--) { // figure out where to place each gracenote\n      this.roomtaken+=10;\n      graceoffsets[i] = this.roomtaken;\n      if (elem.gracenotes[i].accidental) {\n        this.roomtaken+=7;\n      }\n    }\n\n    for (i=0; i<elem.gracenotes.length; i++) {\n      var gracepitch = elem.gracenotes[i].verticalPos;\n\n      flag = (gracebeam) ? null : this.chartable.uflags[(this.isBagpipes)?5:3];\n      grace = this.createNoteHead(abselem, \"noteheads.quarter\", elem.gracenotes[i], \"up\", -graceoffsets[i], -graceoffsets[i], flag, 0, 0, gracescale);\n      abselem.addExtra(grace);\n                // PER: added acciaccatura slash\n                if (elem.gracenotes[i].acciaccatura) {\n                        var pos = elem.gracenotes[i].verticalPos+7*gracescale;        // the same formula that determines the flag position.\n                        var dAcciaccatura = gracebeam ? 5 : 6;        // just an offset to make it line up correctly.\n                        abselem.addRight(new RelativeElement(\"flags.ugrace\", -graceoffsets[i]+dAcciaccatura, 0, pos, {scalex:gracescale, scaley: gracescale}));\n                }\n      if (gracebeam) { // give the beam the necessary info\n          var graceDuration = elem.gracenotes[i].duration / 2;\n          if (this.isBagpipes) graceDuration /= 2;\n        var pseudoabselem = {heads:[grace],\n                         abcelem:{averagepitch: gracepitch, minpitch: gracepitch, maxpitch: gracepitch, duration: graceDuration }};\n        gracebeam.add(pseudoabselem);\n      } else { // draw the stem\n        p1 = gracepitch+1/3*gracescale;\n        p2 = gracepitch+7*gracescale;\n        dx = grace.dx + grace.w;\n        width = -0.6;\n        abselem.addExtra(new RelativeElement(null, dx, 0, p1, {\"type\": \"stem\", \"pitch2\":p2, linewidth: width}));\n      }\n\t\tledgerLines(abselem, gracepitch, gracepitch, false, \"noteheads.quarter\", [], true, grace.dx-1, 0.6);\n\n      if (i===0 && !this.isBagpipes && !(elem.rest && (elem.rest.type===\"spacer\"||elem.rest.type===\"invisible\"))) {\n      \tvar isTie = (elem.gracenotes.length === 1 && grace.pitch === notehead.pitch);\n      \tthis.voice.addOther(new TieElem(grace, notehead, false, true, isTie));\n\t  }\n    }\n\n    if (gracebeam) {\n      this.voice.addBeam(gracebeam);\n    }\n  }\n\n  if (!dontDraw && elem.decoration) {\n\t  this.decoration.createDecoration(this.voice, elem.decoration, abselem.top, (notehead)?notehead.w:0, abselem, this.roomtaken, dir, abselem.bottom, elem.positioning, this.hasVocals);\n  }\n\n  if (elem.barNumber) {\n    abselem.addChild(new RelativeElement(elem.barNumber, -10, 0, 0, {type:\"barNumber\"}));\n  }\n\n  // ledger lines\n\tledgerLines(abselem, elem.minpitch, elem.maxpitch, elem.rest, c, additionalLedgers, dir, -2, 1);\n\n\tvar chordMargin = 8; // If there are chords next to each other, this is how close they can get.\n  if (elem.chord !== undefined) {\n    for (i = 0; i < elem.chord.length; i++) {\n      var x = 0;\n      var y;\n\t\tvar dim = this.renderer.getTextSize(elem.chord[i].name, 'annotationfont', \"annotation\");\n\t\tvar chordWidth = dim.width;\n\t\tvar chordHeight = dim.height / spacing.STEP;\n      switch (elem.chord[i].position) {\n      case \"left\":\n        this.roomtaken+=chordWidth+7;\n        x = -this.roomtaken;        // TODO-PER: This is just a guess from trial and error\n        y = elem.averagepitch;\n        abselem.addExtra(new RelativeElement(elem.chord[i].name, x, chordWidth+4, y, {type:\"text\", height: chordHeight}));\n        break;\n      case \"right\":\n        this.roomtakenright+=4;\n        x = this.roomtakenright;// TODO-PER: This is just a guess from trial and error\n        y = elem.averagepitch;\n        abselem.addRight(new RelativeElement(elem.chord[i].name, x, chordWidth+4, y, {type:\"text\", height: chordHeight}));\n        break;\n      case \"below\":\n\t\t  // setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t  abselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth+chordMargin, undefined, {type: \"text\", position: \"below\", height: chordHeight}));\n    break;\n\t\tcase \"above\":\n\t\t\t// setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t\tabselem.addRight(new RelativeElement(elem.chord[i].name, 0, chordWidth+chordMargin, undefined, {type: \"text\", height: chordHeight}));\n\t\t\tbreak;\n      default:\n\t\tif (elem.chord[i].rel_position) {\n\t\t\tvar relPositionY = elem.chord[i].rel_position.y + 3*spacing.STEP; // TODO-PER: this is a fudge factor to make it line up with abcm2ps\n\t\t\tabselem.addChild(new RelativeElement(elem.chord[i].name, x + elem.chord[i].rel_position.x, 0, elem.minpitch + relPositionY / spacing.STEP, {type: \"text\", height: chordHeight}));\n\t\t} else {\n\t\t\t// setting the y-coordinate to undefined for now: it will be overwritten later on, after we figure out what the highest element on the line is.\n\t\t\tvar pos2 = 'above';\n\t\t\tif (elem.positioning && elem.positioning.chordPosition)\n\t\t\t\tpos2 = elem.positioning.chordPosition;\n\n\t\t\tdim = this.renderer.getTextSize(elem.chord[i].name, 'gchordfont', \"chord\");\n\t\t\tchordHeight = dim.height / spacing.STEP;\n\t\t\tchordWidth = dim.width; // Since the chord is centered, we only use half the width.\n\t\t\tabselem.addCentered(new RelativeElement(elem.chord[i].name, x, chordWidth, undefined, {type: \"chord\", position: pos2, height: chordHeight }));\n\t\t}\n      }\n    }\n  }\n\n\n  if (elem.startTriplet && !dontDraw) {\n    this.triplet = new TripletElem(elem.startTriplet, notehead); // above is opposite from case of slurs\n  }\n\n  if (elem.endTriplet && this.triplet && !dontDraw) {\n    this.triplet.setCloseAnchor(notehead);\n  }\n\n  return abselem;\n};\n\n\n\n\nAbstractEngraver.prototype.createNoteHead = function(abselem, c, pitchelem, dir, headx, extrax, flag, dot, dotshiftx, scale) {\n\n  // TODO scale the dot as well\n  var pitch = pitchelem.verticalPos;\n  var notehead;\n  var i;\n  this.accidentalshiftx = 0;\n  this.dotshiftx = 0;\n  if (c === undefined)\n    abselem.addChild(new RelativeElement(\"pitch is undefined\", 0, 0, 0, {type:\"debug\"}));\n  else if (c===\"\") {\n    notehead = new RelativeElement(null, 0, 0, pitch);\n  } else {\n    var shiftheadx = headx;\n    if (pitchelem.printer_shift) {\n      var adjust = (pitchelem.printer_shift===\"same\")?1:0;\n      shiftheadx = (dir===\"down\")?-glyphs.getSymbolWidth(c)*scale+adjust:glyphs.getSymbolWidth(c)*scale-adjust;\n    }\n\t  var opts = {scalex:scale, scaley: scale, thickness: glyphs.symbolHeightInPitches(c)*scale };\n\t  //if (dir)\n\t  //\topts.stemHeight = ((dir===\"down\")?-this.stemHeight:this.stemHeight);\n    notehead = new RelativeElement(c, shiftheadx, glyphs.getSymbolWidth(c)*scale, pitch, opts);\n    if (flag) {\n      var pos = pitch+((dir===\"down\")?-7:7)*scale;\n      if (scale===1 && (dir===\"down\")?(pos>6):(pos<6)) pos=6;\n      var xdelta = (dir===\"down\")?headx:headx+notehead.w-0.6;\n      abselem.addRight(new RelativeElement(flag, xdelta, glyphs.getSymbolWidth(flag)*scale, pos, {scalex:scale, scaley: scale}));\n    }\n    this.dotshiftx = notehead.w+dotshiftx-2+5*dot;\n    for (;dot>0;dot--) {\n      var dotadjusty = (1-Math.abs(pitch)%2); //PER: take abs value of the pitch. And the shift still happens on ledger lines.\n      abselem.addRight(new RelativeElement(\"dots.dot\", notehead.w+dotshiftx-2+5*dot, glyphs.getSymbolWidth(\"dots.dot\"), pitch+dotadjusty));\n    }\n  }\n        if (notehead)\n                notehead.highestVert = pitchelem.highestVert;\n\n  if (pitchelem.accidental) {\n    var symb;\n    switch (pitchelem.accidental) {\n    case \"quartersharp\":\n      symb = \"accidentals.halfsharp\";\n        break;\n    case \"dblsharp\":\n      symb = \"accidentals.dblsharp\";\n      break;\n    case \"sharp\":\n      symb = \"accidentals.sharp\";\n      break;\n    case \"quarterflat\":\n      symb = \"accidentals.halfflat\";\n      break;\n    case \"flat\":\n      symb = \"accidentals.flat\";\n      break;\n    case \"dblflat\":\n      symb = \"accidentals.dblflat\";\n      break;\n    case \"natural\":\n      symb = \"accidentals.nat\";\n    }\n         // if a note is at least a sixth away, it can share a slot with another accidental\n         var accSlotFound = false;\n         var accPlace = extrax;\n         for (var j = 0; j < this.accidentalSlot.length; j++) {\n                 if (pitch - this.accidentalSlot[j][0] >= 6) {\n                         this.accidentalSlot[j][0] = pitch;\n                         accPlace = this.accidentalSlot[j][1];\n                         accSlotFound = true;\n                         break;\n                 }\n         }\n         if (accSlotFound === false) {\n                 accPlace -= (glyphs.getSymbolWidth(symb)*scale+2);\n                 this.accidentalSlot.push([pitch,accPlace]);\n                 this.accidentalshiftx = (glyphs.getSymbolWidth(symb)*scale+2);\n         }\n    abselem.addExtra(new RelativeElement(symb, accPlace, glyphs.getSymbolWidth(symb), pitch, {scalex:scale, scaley: scale}));\n  }\n\n  if (pitchelem.endTie) {\n    if (this.ties[0]) {\n      this.ties[0].setEndAnchor(notehead);\n      this.ties = this.ties.slice(1,this.ties.length);\n    }\n  }\n\n  if (pitchelem.startTie) {\n    //PER: bug fix: var tie = new TieElem(notehead, null, (this.stemdir==\"up\" || dir==\"down\") && this.stemdir!=\"down\",(this.stemdir==\"down\" || this.stemdir==\"up\"));\n    var tie = new TieElem(notehead, null, (this.stemdir===\"down\" || dir===\"down\") && this.stemdir!==\"up\",(this.stemdir===\"down\" || this.stemdir===\"up\"), true);\n\t  if (hint) tie.setHint();\n\n\t  this.ties[this.ties.length]=tie;\n    this.voice.addOther(tie);\n\t  // HACK-PER: For the animation, we need to know if a note is tied to the next one, so here's a flag.\n\t  // Unfortunately, only some of the notes in the current event might be tied, but this will consider it\n\t  // tied if any one of them is. That will work for most cases.\n\t  abselem.startTie = true;\n  }\n\n  if (pitchelem.endSlur) {\n    for (i=0; i<pitchelem.endSlur.length; i++) {\n      var slurid = pitchelem.endSlur[i];\n      var slur;\n      if (this.slurs[slurid]) {\n        slur = this.slurs[slurid];\n\t\t  slur.setEndAnchor(notehead);\n        delete this.slurs[slurid];\n      } else {\n        slur = new TieElem(null, notehead, dir===\"down\",(this.stemdir===\"up\" || dir===\"down\") && this.stemdir!==\"down\", false);\n\t\t  if (hint) slur.setHint();\n        this.voice.addOther(slur);\n      }\n      if (this.startlimitelem) {\n        slur.setStartX(this.startlimitelem);\n      }\n    }\n  }\n\n  if (pitchelem.startSlur) {\n    for (i=0; i<pitchelem.startSlur.length; i++) {\n      var slurid = pitchelem.startSlur[i].label;\n      //PER: bug fix: var slur = new TieElem(notehead, null, (this.stemdir==\"up\" || dir==\"down\") && this.stemdir!=\"down\", this.stemdir);\n      var slur = new TieElem(notehead, null, (this.stemdir===\"down\" || dir===\"down\") && this.stemdir!==\"up\", false, false);\n\t\tif (hint) slur.setHint();\n      this.slurs[slurid]=slur;\n      this.voice.addOther(slur);\n    }\n  }\n\n  return notehead;\n\n};\n\nAbstractEngraver.prototype.addMeasureNumber = function (number, abselem) {\n\tvar measureNumHeight = this.renderer.getTextSize(number, \"measurefont\", 'bar-number');\n\tabselem.addChild(new RelativeElement(number, 0, 0, 11+measureNumHeight.height / spacing.STEP, {type:\"barNumber\"}));\n};\n\nAbstractEngraver.prototype.createBarLine = function (elem) {\n// bar_thin, bar_thin_thick, bar_thin_thin, bar_thick_thin, bar_right_repeat, bar_left_repeat, bar_double_repeat\n\n  var abselem = new AbsoluteElement(elem, 0, 10, 'bar', this.tuneNumber);\n  var anchor = null; // place to attach part lines\n  var dx = 0;\n\n\tif (elem.barNumber) {\n\t\tthis.addMeasureNumber(elem.barNumber, abselem);\n\t}\n\n\n  var firstdots = (elem.type===\"bar_right_repeat\" || elem.type===\"bar_dbl_repeat\");\n  var firstthin = (elem.type!==\"bar_left_repeat\" && elem.type!==\"bar_thick_thin\" && elem.type!==\"bar_invisible\");\n  var thick = (elem.type===\"bar_right_repeat\" || elem.type===\"bar_dbl_repeat\" || elem.type===\"bar_left_repeat\" ||\n         elem.type===\"bar_thin_thick\" || elem.type===\"bar_thick_thin\");\n  var secondthin = (elem.type===\"bar_left_repeat\" || elem.type===\"bar_thick_thin\" || elem.type===\"bar_thin_thin\" || elem.type===\"bar_dbl_repeat\");\n  var seconddots = (elem.type===\"bar_left_repeat\" || elem.type===\"bar_dbl_repeat\");\n\n  // limit positioning of slurs\n  if (firstdots || seconddots) {\n    for (var slur in this.slurs) {\n      if (this.slurs.hasOwnProperty(slur)) {\n        this.slurs[slur].setEndX(abselem);\n      }\n    }\n    this.startlimitelem = abselem;\n  }\n\n  if (firstdots) {\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n    dx+=6; //2 hardcoded, twice;\n  }\n\n  if (firstthin) {\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor);\n  }\n\n  if (elem.type===\"bar_invisible\") {\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"none\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor);\n  }\n\n  if (elem.decoration) {\n    this.decoration.createDecoration(this.voice, elem.decoration, 12, (thick)?3:1, abselem, 0, \"down\", 2, elem.positioning, this.hasVocals);\n  }\n\n  if (thick) {\n    dx+=4; //3 hardcoded;\n    anchor = new RelativeElement(null, dx, 4, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:4});\n    abselem.addRight(anchor);\n    dx+=5;\n  }\n\n// if (this.partstartelem && (thick || (firstthin && secondthin))) { // means end of nth part\n// this.partstartelem.anchor2=anchor;\n// this.partstartelem = null;\n// }\n\n  if (this.partstartelem && elem.endEnding) {\n    this.partstartelem.anchor2=anchor;\n    this.partstartelem = null;\n  }\n\n  if (secondthin) {\n    dx+=3; //3 hardcoded;\n    anchor = new RelativeElement(null, dx, 1, 2, {\"type\": \"bar\", \"pitch2\":10, linewidth:0.6});\n    abselem.addRight(anchor); // 3 is hardcoded\n  }\n\n  if (seconddots) {\n    dx+=3; //3 hardcoded;\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 7));\n    abselem.addRight(new RelativeElement(\"dots.dot\", dx, 1, 5));\n  } // 2 is hardcoded\n\n  if (elem.startEnding && this.s === 0) { // only put the first & second ending marks on the first staff\n\t  var textWidth = this.renderer.getTextSize(elem.startEnding, \"repeatfont\", '').width;\n\t  abselem.minspacing += textWidth + 10; // Give plenty of room for the ending number.\n    this.partstartelem = new EndingElem(elem.startEnding, anchor, null);\n    this.voice.addOther(this.partstartelem);\n  }\n\n  return abselem;\n\n};\n\n\n})();\n\nmodule.exports = AbstractEngraver;\n"]},"metadata":{},"sourceType":"script"}