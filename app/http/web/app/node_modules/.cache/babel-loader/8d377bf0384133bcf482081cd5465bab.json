{"ast":null,"code":"// abc_decoration.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com) & Paul Rosen\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global window */\nvar DynamicDecoration = require('./abc_dynamic_decoration');\n\nvar CrescendoElem = require('./abc_crescendo_element');\n\nvar glyphs = require('./abc_glyphs');\n\nvar RelativeElement = require('./abc_relative_element');\n\nvar TieElem = require('./abc_tie_element');\n\nvar Decoration;\n\n(function () {\n  \"use strict\";\n\n  Decoration = function Decoration() {\n    this.startDiminuendoX = undefined;\n    this.startCrescendoX = undefined;\n    this.minTop = 12; // TODO-PER: this is assuming a 5-line staff. Pass that info in.\n\n    this.minBottom = 0;\n  };\n\n  var closeDecoration = function (voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch) {\n    var yPos;\n\n    for (var i = 0; i < decoration.length; i++) {\n      if (decoration[i] === \"staccato\" || decoration[i] === \"tenuto\" || decoration[i] === \"accent\") {\n        var symbol = \"scripts.\" + decoration[i];\n        if (decoration[i] === \"accent\") symbol = \"scripts.sforzato\";\n        if (yPos === undefined) yPos = dir === \"down\" ? pitch + 2 : minPitch - 2;else yPos = dir === \"down\" ? yPos + 2 : yPos - 2;\n\n        if (decoration[i] === \"accent\") {\n          // Always place the accent three pitches away, no matter whether that is a line or space.\n          if (dir === \"up\") yPos--;else yPos++;\n        } else {\n          // don't place on a stave line. The stave lines are 2,4,6,8,10\n          switch (yPos) {\n            case 2:\n            case 4:\n            case 6:\n            case 8:\n            case 10:\n              if (dir === \"up\") yPos--;else yPos++;\n              break;\n          }\n        }\n\n        if (pitch > 9) yPos++; // take up some room of those that are above\n\n        var deltaX = width / 2;\n\n        if (glyphs.getSymbolAlign(symbol) !== \"center\") {\n          deltaX -= glyphs.getSymbolWidth(symbol) / 2;\n        }\n\n        abselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), yPos));\n      }\n\n      if (decoration[i] === \"slide\" && abselem.heads[0]) {\n        var yPos2 = abselem.heads[0].pitch;\n        yPos2 -= 2; // TODO-PER: not sure what this fudge factor is.\n\n        var blank1 = new RelativeElement(\"\", -roomtaken - 15, 0, yPos2 - 1);\n        var blank2 = new RelativeElement(\"\", -roomtaken - 5, 0, yPos2 + 1);\n        abselem.addChild(blank1);\n        abselem.addChild(blank2);\n        voice.addOther(new TieElem(blank1, blank2, false, false, false));\n      }\n    }\n\n    if (yPos === undefined) yPos = pitch;\n    return {\n      above: yPos,\n      below: abselem.bottom\n    };\n  };\n\n  var volumeDecoration = function (voice, decoration, abselem, positioning) {\n    for (var i = 0; i < decoration.length; i++) {\n      switch (decoration[i]) {\n        case \"p\":\n        case \"mp\":\n        case \"pp\":\n        case \"ppp\":\n        case \"pppp\":\n        case \"f\":\n        case \"ff\":\n        case \"fff\":\n        case \"ffff\":\n        case \"sfz\":\n        case \"mf\":\n          var elem = new DynamicDecoration(abselem, decoration[i], positioning);\n          voice.addOther(elem);\n      }\n    }\n  };\n\n  var compoundDecoration = function (decoration, pitch, width, abselem, dir) {\n    function highestPitch() {\n      if (abselem.heads.length === 0) return 10; // TODO-PER: I don't know if this can happen, but we'll return the top of the staff if so.\n\n      var pitch = abselem.heads[0].pitch;\n\n      for (var i = 1; i < abselem.heads.length; i++) pitch = Math.max(pitch, abselem.heads[i].pitch);\n\n      return pitch;\n    }\n\n    function lowestPitch() {\n      if (abselem.heads.length === 0) return 2; // TODO-PER: I don't know if this can happen, but we'll return the bottom of the staff if so.\n\n      var pitch = abselem.heads[0].pitch;\n\n      for (var i = 1; i < abselem.heads.length; i++) pitch = Math.min(pitch, abselem.heads[i].pitch);\n\n      return pitch;\n    }\n\n    function compoundDecoration(symbol, count) {\n      var placement = dir === 'down' ? lowestPitch() + 1 : highestPitch() + 9;\n      if (dir !== 'down' && count === 1) placement--;\n      var deltaX = width / 2;\n      deltaX += dir === 'down' ? -5 : 3;\n\n      for (var i = 0; i < count; i++) {\n        placement -= 1;\n        abselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), placement));\n      }\n    }\n\n    for (var i = 0; i < decoration.length; i++) {\n      switch (decoration[i]) {\n        case \"/\":\n          compoundDecoration(\"flags.ugrace\", 1);\n          break;\n\n        case \"//\":\n          compoundDecoration(\"flags.ugrace\", 2);\n          break;\n\n        case \"///\":\n          compoundDecoration(\"flags.ugrace\", 3);\n          break;\n\n        case \"////\":\n          compoundDecoration(\"flags.ugrace\", 4);\n          break;\n      }\n    }\n  };\n\n  var stackedDecoration = function (decoration, width, abselem, yPos, positioning, minTop, minBottom) {\n    function incrementPlacement(placement, height) {\n      if (placement === 'above') yPos.above += height;else yPos.below -= height;\n    }\n\n    function getPlacement(placement) {\n      var y;\n\n      if (placement === 'above') {\n        y = yPos.above;\n        if (y < minTop) y = minTop;\n      } else {\n        y = yPos.below;\n        if (y > minBottom) y = minBottom;\n      }\n\n      return y;\n    }\n\n    function textDecoration(text, placement) {\n      var y = getPlacement(placement);\n      var textFudge = 2;\n      var textHeight = 5; // TODO-PER: Get the height of the current font and use that for the thickness.\n\n      abselem.addChild(new RelativeElement(text, width / 2, 0, y + textFudge, {\n        type: \"decoration\",\n        klass: 'ornament',\n        thickness: 3\n      }));\n      incrementPlacement(placement, textHeight);\n    }\n\n    function symbolDecoration(symbol, placement) {\n      var deltaX = width / 2;\n\n      if (glyphs.getSymbolAlign(symbol) !== \"center\") {\n        deltaX -= glyphs.getSymbolWidth(symbol) / 2;\n      }\n\n      var height = glyphs.symbolHeightInPitches(symbol) + 1; // adding a little padding so nothing touches.\n\n      var y = getPlacement(placement);\n      y = placement === 'above' ? y + height / 2 : y - height / 2; // Center the element vertically.\n\n      abselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), y, {\n        klass: 'ornament',\n        thickness: glyphs.symbolHeightInPitches(symbol)\n      }));\n      incrementPlacement(placement, height);\n    }\n\n    var symbolList = {\n      \"+\": \"scripts.stopped\",\n      \"open\": \"scripts.open\",\n      \"snap\": \"scripts.snap\",\n      \"wedge\": \"scripts.wedge\",\n      \"thumb\": \"scripts.thumb\",\n      \"shortphrase\": \"scripts.shortphrase\",\n      \"mediumphrase\": \"scripts.mediumphrase\",\n      \"longphrase\": \"scripts.longphrase\",\n      \"trill\": \"scripts.trill\",\n      \"roll\": \"scripts.roll\",\n      \"irishroll\": \"scripts.roll\",\n      \"marcato\": \"scripts.umarcato\",\n      \"dmarcato\": \"scripts.dmarcato\",\n      \"umarcato\": \"scripts.umarcato\",\n      \"turn\": \"scripts.turn\",\n      \"uppermordent\": \"scripts.prall\",\n      \"pralltriller\": \"scripts.prall\",\n      \"mordent\": \"scripts.mordent\",\n      \"lowermordent\": \"scripts.mordent\",\n      \"downbow\": \"scripts.downbow\",\n      \"upbow\": \"scripts.upbow\",\n      \"fermata\": \"scripts.ufermata\",\n      \"invertedfermata\": \"scripts.dfermata\",\n      \"breath\": \",\",\n      \"coda\": \"scripts.coda\",\n      \"segno\": \"scripts.segno\"\n    };\n    var hasOne = false;\n\n    for (var i = 0; i < decoration.length; i++) {\n      switch (decoration[i]) {\n        case \"0\":\n        case \"1\":\n        case \"2\":\n        case \"3\":\n        case \"4\":\n        case \"5\":\n        case \"D.C.\":\n        case \"D.S.\":\n          textDecoration(decoration[i], positioning);\n          hasOne = true;\n          break;\n\n        case \"fine\":\n          textDecoration(\"FINE\", positioning);\n          hasOne = true;\n          break;\n\n        case \"+\":\n        case \"open\":\n        case \"snap\":\n        case \"wedge\":\n        case \"thumb\":\n        case \"shortphrase\":\n        case \"mediumphrase\":\n        case \"longphrase\":\n        case \"trill\":\n        case \"roll\":\n        case \"irishroll\":\n        case \"marcato\":\n        case \"dmarcato\":\n        case \"turn\":\n        case \"uppermordent\":\n        case \"pralltriller\":\n        case \"mordent\":\n        case \"lowermordent\":\n        case \"downbow\":\n        case \"upbow\":\n        case \"fermata\":\n        case \"breath\":\n        case \"umarcato\":\n        case \"coda\":\n        case \"segno\":\n          symbolDecoration(symbolList[decoration[i]], positioning);\n          hasOne = true;\n          break;\n\n        case \"invertedfermata\":\n          symbolDecoration(symbolList[decoration[i]], 'below');\n          hasOne = true;\n          break;\n\n        case \"mark\":\n          abselem.klass = \"mark\";\n          break;\n      }\n    }\n\n    return hasOne;\n  };\n\n  Decoration.prototype.dynamicDecoration = function (voice, decoration, abselem, positioning) {\n    var diminuendo;\n    var crescendo;\n\n    for (var i = 0; i < decoration.length; i++) {\n      switch (decoration[i]) {\n        case \"diminuendo(\":\n          this.startDiminuendoX = abselem;\n          diminuendo = undefined;\n          break;\n\n        case \"diminuendo)\":\n          diminuendo = {\n            start: this.startDiminuendoX,\n            stop: abselem\n          };\n          this.startDiminuendoX = undefined;\n          break;\n\n        case \"crescendo(\":\n          this.startCrescendoX = abselem;\n          crescendo = undefined;\n          break;\n\n        case \"crescendo)\":\n          crescendo = {\n            start: this.startCrescendoX,\n            stop: abselem\n          };\n          this.startCrescendoX = undefined;\n          break;\n      }\n    }\n\n    if (diminuendo) {\n      voice.addOther(new CrescendoElem(diminuendo.start, diminuendo.stop, \">\", positioning));\n    }\n\n    if (crescendo) {\n      voice.addOther(new CrescendoElem(crescendo.start, crescendo.stop, \"<\", positioning));\n    }\n  };\n\n  Decoration.prototype.createDecoration = function (voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch, positioning, hasVocals) {\n    if (!positioning) positioning = {\n      ornamentPosition: 'above',\n      volumePosition: hasVocals ? 'above' : 'below',\n      dynamicPosition: hasVocals ? 'above' : 'below'\n    }; // These decorations don't affect the placement of other decorations\n\n    volumeDecoration(voice, decoration, abselem, positioning.volumePosition);\n    this.dynamicDecoration(voice, decoration, abselem, positioning.dynamicPosition);\n    compoundDecoration(decoration, pitch, width, abselem, dir); // treat staccato, accent, and tenuto first (may need to shift other markers)\n\n    var yPos = closeDecoration(voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch); // yPos is an object containing 'above' and 'below'. That is the placement of the next symbol on either side.\n\n    yPos.above = Math.max(yPos.above, this.minTop);\n    var hasOne = stackedDecoration(decoration, width, abselem, yPos, positioning.ornamentPosition, this.minTop, this.minBottom);\n\n    if (hasOne) {//\t\t\tabselem.top = Math.max(yPos.above + 3, abselem.top); // TODO-PER: Not sure why we need this fudge factor.\n    }\n  };\n})();\n\nmodule.exports = Decoration;","map":{"version":3,"sources":["/Users/philbrockman/coding/MusicalGens/app/http/web/app/node_modules/abcjs/src/write/abc_decoration.js"],"names":["DynamicDecoration","require","CrescendoElem","glyphs","RelativeElement","TieElem","Decoration","startDiminuendoX","undefined","startCrescendoX","minTop","minBottom","closeDecoration","voice","decoration","pitch","width","abselem","roomtaken","dir","minPitch","yPos","i","length","symbol","deltaX","getSymbolAlign","getSymbolWidth","addChild","heads","yPos2","blank1","blank2","addOther","above","below","bottom","volumeDecoration","positioning","elem","compoundDecoration","highestPitch","Math","max","lowestPitch","min","count","placement","stackedDecoration","incrementPlacement","height","getPlacement","y","textDecoration","text","textFudge","textHeight","type","klass","thickness","symbolDecoration","symbolHeightInPitches","symbolList","hasOne","prototype","dynamicDecoration","diminuendo","crescendo","start","stop","createDecoration","hasVocals","ornamentPosition","volumePosition","dynamicPosition","module","exports"],"mappings":"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","sourcesContent":["// abc_decoration.js: Creates a data structure suitable for printing a line of abc\n// Copyright (C) 2010-2018 Gregory Dyke (gregdyke at gmail dot com) & Paul Rosen\n//\n//    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n//    documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation\n//    the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n//    to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n//\n//    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n//\n//    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n//    BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n//    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n//    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n//    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n/*global window */\n\nvar DynamicDecoration = require('./abc_dynamic_decoration');\nvar CrescendoElem = require('./abc_crescendo_element');\nvar glyphs = require('./abc_glyphs');\nvar RelativeElement = require('./abc_relative_element');\nvar TieElem = require('./abc_tie_element');\n\nvar Decoration;\n\n(function() {\n\t\"use strict\";\n\n\tDecoration = function Decoration() {\n\t\tthis.startDiminuendoX = undefined;\n\t\tthis.startCrescendoX = undefined;\n\t\tthis.minTop = 12;\t// TODO-PER: this is assuming a 5-line staff. Pass that info in.\n\t\tthis.minBottom = 0;\n\t};\n\n\tvar closeDecoration = function(voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch) {\n\t\tvar yPos;\n\t\tfor (var i=0;i<decoration.length; i++) {\n\t\t\tif (decoration[i]===\"staccato\" || decoration[i]===\"tenuto\" || decoration[i] === \"accent\") {\n\t\t\t\tvar symbol = \"scripts.\" + decoration[i];\n\t\t\t\tif (decoration[i] === \"accent\") symbol = \"scripts.sforzato\";\n\t\t\t\tif (yPos === undefined)\n\t\t\t\t\tyPos = (dir===\"down\") ? pitch+2:minPitch-2;\n\t\t\t\telse\n\t\t\t\t\tyPos = (dir===\"down\") ? yPos+2:yPos-2;\n\t\t\t\tif (decoration[i] === \"accent\") {\n\t\t\t\t\t// Always place the accent three pitches away, no matter whether that is a line or space.\n\t\t\t\t\tif (dir === \"up\") yPos--;\n\t\t\t\t\telse yPos++;\n\t\t\t\t} else {\n\t\t\t\t\t// don't place on a stave line. The stave lines are 2,4,6,8,10\n\t\t\t\t\tswitch (yPos) {\n\t\t\t\t\t\tcase 2:\n\t\t\t\t\t\tcase 4:\n\t\t\t\t\t\tcase 6:\n\t\t\t\t\t\tcase 8:\n\t\t\t\t\t\tcase 10:\n\t\t\t\t\t\t\tif (dir === \"up\") yPos--;\n\t\t\t\t\t\t\telse yPos++;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (pitch>9) yPos++; // take up some room of those that are above\n\t\t\t\tvar deltaX = width/2;\n\t\t\t\tif (glyphs.getSymbolAlign(symbol)!==\"center\") {\n\t\t\t\t\tdeltaX -= (glyphs.getSymbolWidth(symbol)/2);\n\t\t\t\t}\n\t\t\t\tabselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), yPos));\n\t\t\t}\n\t\t\tif (decoration[i]===\"slide\" && abselem.heads[0]) {\n\t\t\t\tvar yPos2 = abselem.heads[0].pitch;\n\t\t\t\tyPos2 -= 2; // TODO-PER: not sure what this fudge factor is.\n\t\t\t\tvar blank1 = new RelativeElement(\"\", -roomtaken-15, 0, yPos2-1);\n\t\t\t\tvar blank2 = new RelativeElement(\"\", -roomtaken-5, 0, yPos2+1);\n\t\t\t\tabselem.addChild(blank1);\n\t\t\t\tabselem.addChild(blank2);\n\t\t\t\tvoice.addOther(new TieElem(blank1, blank2, false, false, false));\n\t\t\t}\n\t\t}\n\t\tif (yPos === undefined)\n\t\t\tyPos = pitch;\n\n\t\treturn { above: yPos, below: abselem.bottom };\n\t};\n\n\tvar volumeDecoration = function(voice, decoration, abselem, positioning) {\n\t\tfor (var i=0;i<decoration.length; i++) {\n\t\t\tswitch(decoration[i]) {\n\t\t\t\tcase \"p\":\n\t\t\t\tcase \"mp\":\n\t\t\t\tcase \"pp\":\n\t\t\t\tcase \"ppp\":\n\t\t\t\tcase \"pppp\":\n\t\t\t\tcase \"f\":\n\t\t\t\tcase \"ff\":\n\t\t\t\tcase \"fff\":\n\t\t\t\tcase \"ffff\":\n\t\t\t\tcase \"sfz\":\n\t\t\t\tcase \"mf\":\n\t\t\t\t\tvar elem = new DynamicDecoration(abselem, decoration[i], positioning);\n\t\t\t\t\tvoice.addOther(elem);\n\t\t\t}\n\t\t}\n\t};\n\n\tvar compoundDecoration = function(decoration, pitch, width, abselem, dir) {\n\t\tfunction highestPitch() {\n\t\t\tif (abselem.heads.length === 0)\n\t\t\t\treturn 10;\t// TODO-PER: I don't know if this can happen, but we'll return the top of the staff if so.\n\t\t\tvar pitch = abselem.heads[0].pitch;\n\t\t\tfor (var i = 1; i < abselem.heads.length; i++)\n\t\t\t\tpitch = Math.max(pitch, abselem.heads[i].pitch);\n\t\t\treturn pitch;\n\t\t}\n\t\tfunction lowestPitch() {\n\t\t\tif (abselem.heads.length === 0)\n\t\t\t\treturn 2;\t// TODO-PER: I don't know if this can happen, but we'll return the bottom of the staff if so.\n\t\t\tvar pitch = abselem.heads[0].pitch;\n\t\t\tfor (var i = 1; i < abselem.heads.length; i++)\n\t\t\t\tpitch = Math.min(pitch, abselem.heads[i].pitch);\n\t\t\treturn pitch;\n\t\t}\n\t\tfunction compoundDecoration(symbol, count) {\n\t\t\tvar placement = (dir === 'down') ? lowestPitch()+1:highestPitch()+9;\n\t\t\tif (dir !== 'down' && count === 1)\n\t\t\t\tplacement--;\n\t\t\tvar deltaX = width/2;\n\t\t\tdeltaX += (dir === 'down') ? -5 : 3;\n\t\t\tfor (var i = 0; i < count; i++) {\n\t\t\t\tplacement -= 1;\n\t\t\t\tabselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), placement));\n\t\t\t}\n\t\t}\n\n\t\tfor (var i=0;i<decoration.length; i++) {\n\t\t\tswitch(decoration[i]) {\n\t\t\t\tcase \"/\": compoundDecoration(\"flags.ugrace\", 1); break;\n\t\t\t\tcase \"//\": compoundDecoration(\"flags.ugrace\", 2); break;\n\t\t\t\tcase \"///\": compoundDecoration(\"flags.ugrace\", 3); break;\n\t\t\t\tcase \"////\": compoundDecoration(\"flags.ugrace\", 4); break;\n\t\t\t}\n\t\t}\n\t};\n\n\tvar stackedDecoration = function(decoration, width, abselem, yPos, positioning, minTop, minBottom) {\n\t\tfunction incrementPlacement(placement, height) {\n\t\t\tif (placement === 'above')\n\t\t\t\tyPos.above += height;\n\t\t\telse\n\t\t\t\tyPos.below -= height;\n\t\t}\n\t\tfunction getPlacement(placement) {\n\t\t\tvar y;\n\t\t\tif (placement === 'above') {\n\t\t\t\ty = yPos.above;\n\t\t\t\tif (y < minTop)\n\t\t\t\t\ty = minTop;\n\t\t\t} else {\n\t\t\t\ty = yPos.below;\n\t\t\t\tif (y > minBottom)\n\t\t\t\t\ty = minBottom;\n\t\t\t}\n\t\t\treturn y;\n\t\t}\n\t\tfunction textDecoration(text, placement) {\n\t\t\tvar y = getPlacement(placement);\n\t\t\tvar textFudge = 2;\n\t\t\tvar textHeight = 5;\n\t\t\t// TODO-PER: Get the height of the current font and use that for the thickness.\n\t\t\tabselem.addChild(new RelativeElement(text, width/2, 0, y+textFudge, {type:\"decoration\", klass: 'ornament', thickness: 3}));\n\n\t\t\tincrementPlacement(placement, textHeight);\n\t\t}\n\t\tfunction symbolDecoration(symbol, placement) {\n\t\t\tvar deltaX = width/2;\n\t\t\tif (glyphs.getSymbolAlign(symbol) !== \"center\") {\n\t\t\t\tdeltaX -= (glyphs.getSymbolWidth(symbol) / 2);\n\t\t\t}\n\t\t\tvar height = glyphs.symbolHeightInPitches(symbol) + 1; // adding a little padding so nothing touches.\n\t\t\tvar y = getPlacement(placement);\n\t\t\ty = (placement === 'above') ? y + height/2 : y - height/2;// Center the element vertically.\n\t\t\tabselem.addChild(new RelativeElement(symbol, deltaX, glyphs.getSymbolWidth(symbol), y, { klass: 'ornament', thickness: glyphs.symbolHeightInPitches(symbol) }));\n\n\t\t\tincrementPlacement(placement, height);\n\t\t}\n\n\t\tvar symbolList = {\n\t\t\t\"+\": \"scripts.stopped\",\n\t\t\t\"open\": \"scripts.open\",\n\t\t\t\"snap\": \"scripts.snap\",\n\t\t\t\"wedge\": \"scripts.wedge\",\n\t\t\t\"thumb\": \"scripts.thumb\",\n\t\t\t\"shortphrase\": \"scripts.shortphrase\",\n\t\t\t\"mediumphrase\": \"scripts.mediumphrase\",\n\t\t\t\"longphrase\": \"scripts.longphrase\",\n\t\t\t\"trill\": \"scripts.trill\",\n\t\t\t\"roll\": \"scripts.roll\",\n\t\t\t\"irishroll\": \"scripts.roll\",\n\t\t\t\"marcato\": \"scripts.umarcato\",\n\t\t\t\"dmarcato\": \"scripts.dmarcato\",\n\t\t\t\"umarcato\": \"scripts.umarcato\",\n\t\t\t\"turn\": \"scripts.turn\",\n\t\t\t\"uppermordent\": \"scripts.prall\",\n\t\t\t\"pralltriller\": \"scripts.prall\",\n\t\t\t\"mordent\": \"scripts.mordent\",\n\t\t\t\"lowermordent\": \"scripts.mordent\",\n\t\t\t\"downbow\": \"scripts.downbow\",\n\t\t\t\"upbow\": \"scripts.upbow\",\n\t\t\t\"fermata\": \"scripts.ufermata\",\n\t\t\t\"invertedfermata\": \"scripts.dfermata\",\n\t\t\t\"breath\": \",\",\n\t\t\t\"coda\": \"scripts.coda\",\n\t\t\t\"segno\": \"scripts.segno\"\n\t\t};\n\n\t\tvar hasOne = false;\n\t\tfor (var i=0;i<decoration.length; i++) {\n\t\t\tswitch(decoration[i]) {\n\t\t\t\tcase \"0\":\n\t\t\t\tcase \"1\":\n\t\t\t\tcase \"2\":\n\t\t\t\tcase \"3\":\n\t\t\t\tcase \"4\":\n\t\t\t\tcase \"5\":\n\t\t\t\tcase \"D.C.\":\n\t\t\t\tcase \"D.S.\":\n\t\t\t\t\ttextDecoration(decoration[i], positioning);\n\t\t\t\t\thasOne = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"fine\":\n\t\t\t\t\ttextDecoration(\"FINE\", positioning);\n\t\t\t\t\thasOne = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"+\":\n\t\t\t\tcase \"open\":\n\t\t\t\tcase \"snap\":\n\t\t\t\tcase \"wedge\":\n\t\t\t\tcase \"thumb\":\n\t\t\t\tcase \"shortphrase\":\n\t\t\t\tcase \"mediumphrase\":\n\t\t\t\tcase \"longphrase\":\n\t\t\t\tcase \"trill\":\n\t\t\t\tcase \"roll\":\n\t\t\t\tcase \"irishroll\":\n\t\t\t\tcase \"marcato\":\n\t\t\t\tcase \"dmarcato\":\n\t\t\t\tcase \"turn\":\n\t\t\t\tcase \"uppermordent\":\n\t\t\t\tcase \"pralltriller\":\n\t\t\t\tcase \"mordent\":\n\t\t\t\tcase \"lowermordent\":\n\t\t\t\tcase \"downbow\":\n\t\t\t\tcase \"upbow\":\n\t\t\t\tcase \"fermata\":\n\t\t\t\tcase \"breath\":\n\t\t\t\tcase \"umarcato\":\n\t\t\t\tcase \"coda\":\n\t\t\t\tcase \"segno\":\n\t\t\t\t\tsymbolDecoration(symbolList[decoration[i]], positioning);\n\t\t\t\t\thasOne = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"invertedfermata\":\n\t\t\t\t\tsymbolDecoration(symbolList[decoration[i]], 'below');\n\t\t\t\t\thasOne = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"mark\":\n\t\t\t\t\tabselem.klass = \"mark\";\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn hasOne;\n\t};\n\n\tDecoration.prototype.dynamicDecoration = function(voice, decoration, abselem, positioning) {\n\t\tvar diminuendo;\n\t\tvar crescendo;\n\t\tfor (var i=0;i<decoration.length; i++) {\n\t\t\tswitch(decoration[i]) {\n\t\t\t\tcase \"diminuendo(\":\n\t\t\t\t\tthis.startDiminuendoX = abselem;\n\t\t\t\t\tdiminuendo = undefined;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"diminuendo)\":\n\t\t\t\t\tdiminuendo = { start: this.startDiminuendoX, stop: abselem};\n\t\t\t\t\tthis.startDiminuendoX = undefined;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"crescendo(\":\n\t\t\t\t\tthis.startCrescendoX = abselem;\n\t\t\t\t\tcrescendo = undefined;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"crescendo)\":\n\t\t\t\t\tcrescendo = { start: this.startCrescendoX, stop: abselem};\n\t\t\t\t\tthis.startCrescendoX = undefined;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (diminuendo) {\n\t\t\tvoice.addOther(new CrescendoElem(diminuendo.start, diminuendo.stop, \">\", positioning));\n\t\t}\n\t\tif (crescendo) {\n\t\t\tvoice.addOther(new CrescendoElem(crescendo.start, crescendo.stop, \"<\", positioning));\n\t\t}\n\t};\n\n\tDecoration.prototype.createDecoration = function(voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch, positioning, hasVocals) {\n\t\tif (!positioning)\n\t\t\tpositioning = { ornamentPosition: 'above', volumePosition: hasVocals ? 'above' :'below', dynamicPosition: hasVocals ? 'above' : 'below' };\n\t\t// These decorations don't affect the placement of other decorations\n\t\tvolumeDecoration(voice, decoration, abselem, positioning.volumePosition);\n\t\tthis.dynamicDecoration(voice, decoration, abselem, positioning.dynamicPosition);\n\t\tcompoundDecoration(decoration, pitch, width, abselem, dir);\n\n\t\t// treat staccato, accent, and tenuto first (may need to shift other markers)\n\t\tvar yPos = closeDecoration(voice, decoration, pitch, width, abselem, roomtaken, dir, minPitch);\n\t\t// yPos is an object containing 'above' and 'below'. That is the placement of the next symbol on either side.\n\n\t\tyPos.above = Math.max(yPos.above, this.minTop);\n\t\tvar hasOne = stackedDecoration(decoration, width, abselem, yPos, positioning.ornamentPosition, this.minTop, this.minBottom);\n\t\tif (hasOne) {\n//\t\t\tabselem.top = Math.max(yPos.above + 3, abselem.top); // TODO-PER: Not sure why we need this fudge factor.\n\t\t}\n\t};\n\n})();\n\nmodule.exports = Decoration;\n"]},"metadata":{},"sourceType":"script"}